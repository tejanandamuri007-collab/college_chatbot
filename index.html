<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Insight Chatbot</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic buttons --><script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for visualization --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for a modern, rounded chat interface */
        :root {
            /* --- NEW VIBRANT TEAL THEME --- */
            --primary-color: #00C9A7; /* Vibrant Teal/Cyan - Primary Accent */
            --radiant-blue-start: #00D2D3; /* Lighter Teal for Gradient Start */
            --radiant-blue-end: #006494; /* Deep Ocean Blue for Gradient End */
            --bot-bubble: #e0fff8; /* Soft Mint/Light Teal - NEW COLOR */
            --user-bubble: var(--primary-color);
            /* ---------------------------- */
        }
        
        /* --- DARK MODE VARIABLES AND BASE STYLES --- */
        .dark {
            --background-color: #121212; /* Deep Dark Background */
            --surface-color: #1f1f1f; /* Darker Surface */
            --bot-bubble: #333333; /* Darker grey for bot bubble */
            --text-color: #e0e0e0;
            --link-color: #00D2D3;
        }

        .dark body {
            background-color: var(--background-color);
            background-image: none; /* Remove bright background image in dark mode */
            color: var(--text-color);
        }

        .dark body::before {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .dark body::after {
            color: rgba(0, 168, 135, 0.08); /* Fainter watermark */
        }

        .dark .card-container {
            background: linear-gradient(145deg, var(--radiant-blue-end) 0%, var(--radiant-blue-start) 100%); /* Reverse gradient for visual distinction */
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.3); /* Softer glow */
        }

        .dark #login-card {
            background-color: rgba(31, 31, 31, 0.95);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
        }

        .dark h2, .dark p, .dark .feature-item p, .dark .chat-header h1, .dark .chat-header p, .dark .graph-summary h4, .dark .graph-summary p {
            color: var(--text-color); /* Light text color for dark mode */
        }
        .dark .feature-item {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
        }
        /* --- END DARK MODE BASE STYLES --- */

        body {
            font-family: 'Inter', sans-serif;
            /* --- UPDATED: New Background Image --- */
            background-image: url('https://i.postimg.cc/qRSBHZwg/1b6896fd-e68c-4630-9143-40d15911d44c.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2c3e50; /* Deep Charcoal Fallback */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Transparent overlay over the background color/image */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(22, 33, 44, 0.7); /* Darker, modern transparency */
            z-index: -1; /* Place it between the chat (z=1) and the text (z=-2) */
        }
        
        /* --- NEW: Branded Text Watermark in the Background --- */
        body::after {
            content: "PRAGATI ENGINEERING COLLEGE";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Center and rotate slightly */
            font-size: 8vw; /* Large, fluid size */
            font-weight: 900; /* Extra bold */
            color: rgba(0, 168, 135, 0.15); /* Darker Teal/Green, very faint */
            letter-spacing: 0.5rem;
            pointer-events: none; /* Ignore mouse events */
            z-index: -2; /* Place behind the color overlay */
            white-space: nowrap;
            /* GLOW EFFECT: Strong text shadow in the primary color */
            text-shadow: 0 0 10px rgba(0, 201, 167, 0.5), 0 0 20px rgba(0, 201, 167, 0.3);
        }
        /* -------------------------------------------------- */


        .card-container {
            width: 100%;
            max-width: 640px;
            /* Height changes based on content (login is shorter, chat is taller) */
            display: flex;
            flex-direction: column;
            /* --- RADIANT TEAL & SHINY TEXTURE STYLES (Outer container) --- */
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
            border: 2px solid rgba(255, 255, 255, 0.5); /* Lighter border for shine */
            border-radius: 1rem;
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3); /* Teal Glow and inner shine */
            overflow: hidden;
            z-index: 1;
        }

        /* Styling for the Welcome Screen (centered within the container) */
        #login-view {
            width: 100%;
            height: 90vh;
            max-height: 800px;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        /* Cool Glassmorphism Welcome Card */
        #login-card {
            background-color: rgba(255, 255, 255, 0.95); /* Near opaque white for contrast */
            backdrop-filter: blur(15px); /* Stronger frosted glass effect */
            -webkit-backdrop-filter: blur(15px); /* For Safari support */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.35); /* Stronger shadow */
            width: 100%;
            max-width: 450px; /* Wider card */
            text-align: center;
            transition: all 0.3s ease;
            transform: scale(1.05);
        }
        
        /* --- CHAT VIEW STYLES --- */
        #chat-view {
            width: 100%;
            max-width: 640px;
            height: 90vh;
            max-height: 800px;
            display: none; /* Controlled by JS */
            flex-direction: column;
        }
        #chat-container {
            width: 100%;
            height: 100%;
            flex-direction: column; 
        }

        .chat-header {
            padding: 1rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white; 
            scroll-behavior: smooth;
        }
        .dark #chat-history {
            background-color: var(--surface-color);
        }

        /* Input Area update - kept white for contrast */
        #input-area {
            padding: 1rem; 
            border-top: 1px solid #ccc; 
            background-color: white; 
            display: flex; 
            align-items: center;
        }
        .dark #input-area {
            background-color: var(--surface-color);
            border-top-color: #333;
        }

        /* --- NEW SUGGESTION BUTTON STYLES (Restored) --- */
        .suggestion-button {
            padding: 0.5rem 1rem;
            background-color: #f0fdfa; /* Lightest Teal/Mint */
            border: 1px solid #00C9A7;
            color: #006494; /* Deep Blue text for visibility */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px; /* Full rounded corners */
            cursor: pointer;
            transition: all 0.2s ease;
            transform: scale(0.95);
        }
        .suggestion-button:hover {
            background-color: #00C9A7;
            color: white;
            transform: scale(1.0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .dark .suggestion-button {
            background-color: #2e2e2e;
            border-color: #006494;
            color: #00C9A7;
        }
        .dark .suggestion-button:hover {
            background-color: #00A887;
            color: #1f1f1f;
        }
        /* --- END SUGGESTION STYLES --- */
        
        /* --- INPUT FOCUS GLOW --- */
        #user-input {
            transition: box-shadow 0.3s ease;
        }
        #user-input:focus {
            box-shadow: 0 0 0 4px rgba(0, 201, 167, 0.4); /* Teal glow */
        }
        .dark #user-input {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        /* --- END INPUT FOCUS GLOW --- */


        /* Styling for the messages */
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 85%;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
            /* Added pop-in animation to bot responses */
            animation: pop-in 0.3s ease-out;
        }
        .user-message {
            background-color: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            background-color: var(--bot-bubble);
            color: #111827; /* Darker Gray text for high contrast */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: normal; /* CHANGED from pre-wrap to normal for clean wrapping */
        }
        .dark .bot-message {
            background-color: var(--bot-bubble); /* Darker bot bubble */
            color: var(--text-color); /* Light text in dark mode */
        }

        /* Style for anchor tags in the bot's response to make them stand out */
        .bot-message a {
            color: #006494; /* Deep Blue link color */
            text-decoration: underline;
            font-weight: 700;
        }
        .dark .bot-message a {
            color: var(--link-color);
        }

        /* --- NEW STYLES FOR NEAT RESPONSES --- */
        .info-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #c9d6e4; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-top: 0.5rem;
            word-break: break-word;
        }
        .dark .info-card {
            background-color: #2e2e2e; /* Slightly lighter surface for nested card */
            border-color: #555;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .info-card ul {
            display: flex;
            flex-wrap: wrap; 
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .info-card li {
            list-style: none;
        }
        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            width: 50%;
            min-width: 150px;
            padding-right: 1rem;
        }
        @media (max-width: 480px) {
            .info-item {
                width: 100%;
            }
        }
        .info-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
            color: var(--primary-color); /* Teal icon color */
            line-height: 1.5;
            flex-shrink: 0;
        }
        .link-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
            white-space: normal; /* Ensure links wrap correctly */
        }
        .link-list li {
            margin-bottom: 0.3rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .link-list li::before {
            content: "üîó";
            position: absolute;
            left: 0;
            top: 0;
        }
        /* --- NEW GRAPH SUMMARY STYLES --- */
        .graph-summary {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #c9d6e4;
            font-size: 0.95rem;
        }
        .dark .graph-summary {
            border-top-color: #555;
        }
        .graph-summary p {
            margin-bottom: 0.5rem;
        }
        .graph-summary strong {
            color: #006494; /* Deep Blue for highlights */
        }
        .dark .graph-summary strong {
            color: #00D2D3; /* Lighter highlight in dark mode */
        }
        /* ------------------------------------- */

        /* --- NEW LOADING ANIMATION (Thinking Icon) --- */
        #loading-indicator .bot-message {
            font-size: 1.5rem; /* Make the icon size visible */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thinking-icon {
            animation: thinking-spin 1.5s infinite linear;
        }
        @keyframes thinking-spin {
            0% { transform: scale(0.9) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 1.0; }
            100% { transform: scale(0.9) rotate(360deg); opacity: 0.8; }
        }
        /* --- END NEW LOADING ANIMATION --- */

        /* --- New Pop-In Animation for Bubbles --- */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* --- END Pop-In Animation --- */
        
        /* --- BUTTON CLICK ANIMATION --- */
        .button-click-animation {
            transition: transform 0.1s;
        }
        .button-click-animation:active {
            transform: scale(0.9);
        }
        /* --- END BUTTON CLICK ANIMATION --- */


        .mic-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from {
                box-shadow: 0 0 0 0 rgba(0, 201, 167, 0.7);
                background-color: #ff6347; /* Tomato red when recording */
            }
            to {
                box-shadow: 0 0 0 10px rgba(0, 201, 167, 0);
                background-color: #ff4500;
            }
        }

        /* --- NEW DASHBOARD ANIMATION --- */
        @keyframes scale-up {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        .feature-item {
            transition: all 0.2s ease;
        }
        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body>

<!-- Welcome View - Visible by default -->
<div id="login-view" class="card-container flex">
    <div id="login-card" class="fade-in-up">
        <!-- Professional Branding and Greeting -->
        <div class="flex flex-col items-center mb-6">
            <div class="p-4 bg-[#00C9A7] rounded-full mb-3 shadow-xl">
                <svg class="w-10 h-10 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900">Welcome to Pragati Insight</h2>
            <p class="text-gray-500 mt-1">Your Official AI-Powered Student Command Center</p>
        </div>

        <!-- Aesthetic Separator -->
        <div class="w-20 h-1 bg-[#00C9A7] mx-auto mb-6 rounded-full"></div>

        <!-- Key Feature Panel -->
        <div class="mb-8 grid grid-cols-2 gap-4 text-left">
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 16v5"/><path d="M17 3v5"/><path d="m21 8-4-4-4 4"/><path d="M8 3H4v16a2 2 0 0 0 2 2h10"/></svg>
                    Live Data
                </p>
                <p class="text-xs text-gray-600 mt-1">Real-time answers for packages & faculty status.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 18v-2"/><path d="M10 18v-4"/><path d="M14 18v-6"/><path d="M18 18v-8"/></svg>
                    Data Insights
                </p>
                <p class="text-xs text-gray-600 mt-1">Interactive graphs for placement trends.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-.8 1-1.5 2-2 2.3-2.3 6-4-6-4s-8.3 1.7-6 4c1 1 1.7 1.2 2 2"/><path d="M12 18.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/></svg>
                    Official Docs
                </p>
                <p class="text-xs text-gray-600 mt-1">Direct links to all Syllabus and Academic Calendars.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    24/7 Access
                </p>
                <p class="text-xs text-gray-600 mt-1">Instant support via text or voice input.</p>
            </div>
        </div>

        <!-- Start Chat Button -->
        <button onclick="startChat()"
                class="w-full p-4 mt-2 bg-[#00C9A7] text-white text-xl font-bold rounded-lg hover:bg-[#00A887] transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#00C9A7]/50">
            Start Chatting Now
        </button>
    </div>
</div>

<!-- Chat View - Hidden by default -->
<div id="chat-view" class="card-container hidden">
    <div id="chat-container" class="w-full h-full flex flex-col">
        <!-- Header (Updated with Dark Mode Toggle) -->
        <header class="chat-header">
            <div class="p-2 bg-white/20 rounded-full mr-3">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </div>
            <div>
                <h1 class="text-lg font-semibold">Pragati Engineering College Bot</h1>
                <p class="text-xs opacity-80">24/7 Student Support Assistant</p>
            </div>
            <!-- NEW DARK MODE TOGGLE BUTTON -->
            <button id="mode-toggle" 
                    onclick="toggleDarkMode()"
                    class="ml-auto p-2 rounded-full hover:bg-white/30 transition duration-150 button-click-animation"
                    title="Toggle Dark Mode">
                <svg id="moon-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <svg id="sun-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            </button>
        </header>

        <!-- Chat History --><div id="chat-history">
            <!-- Initial welcome message added via JS after starting chat -->
        </div>

        <!-- Suggestion Area (Restored for UX) -->
        <div id="suggestion-area" class="p-3 bg-white border-t border-gray-100 flex flex-wrap gap-2 transition-all duration-300">
            <!-- Suggestions will be rendered here -->
        </div>
        <script>
            document.getElementById('suggestion-area').classList.remove('p-3');
            document.getElementById('suggestion-area').style.height = '0';
        </script>


        <!-- Input Area --><div id="input-area">
            <input type="text" id="user-input" placeholder="Ask a question..."
                   class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#00C9A7] transition duration-150"
                   autofocus>

            <!-- New Voice Input Button --><button id="voice-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="startVoiceInput()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>

            <!-- Send Button --><button id="send-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="sendMessage()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
    // --- CONVERSATIONAL STATE MANAGEMENT ---
    let conversationContext = {
        state: 'idle', // 'idle', 'awaiting_branch'
        originalQuery: null, // Stores the query that led to 'awaiting_branch'
    };
    // --- END CONVERSATIONAL STATE MANAGEMENT ---
    
    // --- PLACEMENT DATA (Hardcoded Sample Data for Chart) ---
    const PLACEMENT_DATA = {
        years: ['2022', '2023', '2024', '2025 (Ongoing)'],
        highest: [31.31, 29.26, 35.0, 40.0], // Sample data, 40 LPA is from KB
        average: [3.0, 4.0, 4.5, 5.5], // Sample data
    };
    
    // --- STAFF CONTACTS (CONSOLIDATED DATABASE) ---
    const STAFF_CONTACTS = [
        // --- KEY PERSONNEL / MAIN LINES (from dept HoDs phone .csv) ---
        { name: "Principal Sir", number: "9618787861", designation: "Principal" },
        { name: "Hostel (Reception)", number: "9618787862", designation: "Reception" },
        { name: "Discipline Officer", number: "9618787863", designation: "Discipline Officer" },
        { name: "Adi Narayana (Discipline)", number: "9618787863", designation: "Discipline Officer" },
        { name: "Sunil Raj (Transport)", number: "9618701133", designation: "Transport Coordinator" },
        { name: "Xerox", number: "9848183369", designation: "Xerox Section" },
        { name: "Civil Department", number: "9618757861", designation: "Civil HOD/Main Dept Line" },
        { name: "EEE Department", number: "9618757862", designation: "EEE HOD/Main Dept Line" },
        { name: "MECH Department", number: "9618757863", designation: "MECH HOD/Main Dept Line" },
        { name: "ECE Department", number: "9618757864", designation: "ECE HOD/Main Dept Line" },
        { name: "CSE Department", number: "9618757865", designation: "CSE HOD/Main Dept Line" },
        { name: "IT Department", number: "9618757860", designation: "IT HOD/Main Dept Line" },
        { name: "CSE (CS) Department", number: "7995313377", designation: "CSE (CS) Dept Line" },
        { name: "CSE (DS) Department", number: "7995785588", designation: "CSE (DS) Dept Line" },
        { name: "CSE (AI) Department", number: "7702842266", designation: "CSE (AI) Dept Line" },
        { name: "CSE (AI&ML) Department", number: "9000195104", designation: "CSE (AI&ML) Dept Line" },
        { name: "BS&H Department", number: "9618787860", designation: "BS&H HOD/Main Dept Line" },
        
        // --- CIVIL DEPARTMENT STAFF (Truncated for brevity, full list maintained in memory) ---
        { name: "Dr. K.Saroja Rani", number: "9502255765", designation: "Associate Professor, CIVIL" },
        { name: "Mrs. V.Tanuja", number: "9703065276", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. B.Sri Kalyan", number: "7382781194", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. D.V.D.Prasad", number: "8008300313", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. V.Sai Kiran", number: "8008941069", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. B.Sri Datta Subramanyam", number: "9989803199", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. L.Praveen Kumar", number: "9573093908", designation: "Assistant Professor, CIVIL" },
        // ... (rest of staff contacts omitted in this view for brevity but remain in the actual file)
        
        // --- EEE DEPARTMENT STAFF ---
        { name: "K.V. DURGA PRASAD", number: "7396066636", designation: "ASST. PROFESSOR, EEE" },
        // ...
        
        // --- EXAM SECTION STAFF ---
        { name: "Mr. P. Raja Kumar", number: "9502655666", designation: "Exam Section Staff" },
        // ...
    ];
    // --- END STAFF CONTACTS ---

    // --- DEPT SYNONYM MAPPER ---
    const DEPT_MAP = {
        'cse': 'CSE', 'comp': 'CSE', 'cs': 'CSE', 'computer science': 'CSE', 'computer': 'CSE', 'csea': 'CSE(AI)', 'csa': 'CSE(AI)', 'cseai': 'CSE(AI)', 'ai': 'CSE(AI)',
        'ai&ml': 'CSE(AI&ML)', 'cse a&ml': 'CSE(AI&ML)',
        'ds': 'CSE(DS)', 'datascience': 'CSE(DS)', 'cseds': 'CSE(DS)',
        'cs': 'CSE(CS)', 'cses': 'CSE(CS)', 'cybersecurity': 'CSE(CS)',
        'ece': 'ECE', 'e&c': 'ECE', 'electronics': 'ECE',
        'eee': 'EEE', 'electrical': 'EEE',
        'mech': 'MECH', 'mechanical': 'MECH', 'me': 'MECH',
        'it': 'IT', 'information technology': 'IT',
        'civil': 'CIVIL',
        'bsh': 'BS&H', 'basic sciences': 'BS&H',
        'cdc': 'CDC', 'placement': 'CDC',
        'mefa': 'MEFA', 'management studies': 'MEFA',
        'exam': 'EXAM', 'exam section': 'EXAM',
        'admin': 'Admin', 'administrator': 'Admin', 'system admin': 'Admin', 'system administrator': 'Admin', 'sysadmin': 'Admin',
        'lab': 'Labs', 'lab technician': 'Labs', 'technician': 'Labs',
        'security': 'Security', 'maint': 'Security', 'maintenance': 'Security',
        'hostel': 'Hostel', 'warden': 'Hostel',
        'transport': 'Transport',
        'syllabus': 'SYLLABUS', // Added for the new logic
        'academic': 'SYLLABUS', // Added for the new logic
        'canteen': 'TIMINGS',
        'timings': 'TIMINGS',
        'hostler': 'TIMINGS',
        'food': 'TIMINGS',
        'lunch': 'TIMINGS',
        'dinner': 'TIMINGS',
        'breakfast': 'TIMINGS'
    };

    // --- UTILITY FUNCTIONS ---
    const cleanString = (str) => {
        return str.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '').trim();
    };
    
    const normalizeName = (name) => {
        return name.toLowerCase().replace(/^(dr|mr|mrs|ms)\.\s*/, '').replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
    };

    const deduplicateStaff = (staffList) => {
        const uniqueNames = new Map();
        staffList.forEach(staff => {
            const cleanedKey = cleanString(staff.name);
            if (!uniqueNames.has(cleanedKey)) {
                uniqueNames.set(cleanedKey, staff);
            }
        });
        return Array.from(uniqueNames.values());
    };

    const DEDUPLICATED_STAFF_CONTACTS = deduplicateStaff(STAFF_CONTACTS);

    // --- NEW PQP DOWNLOAD MAP (Simulated Direct Download Links) ---
    // Links are replaced with a safe javascript function to simulate the download action
    // I B.Tech I Sem now links to the simulated individual file downloads based on the file structure provided.
    const DOWNLOAD_MAP = {
        'BTECH-I-I': { 
            label: 'I B.Tech. I Sem', 
            files: [
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R16 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R19 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R20 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R23 set)'
            ]
        },
        'BTECH-I-II': { label: 'I B.Tech. II Sem', files: ['R23 BTech I-II Papers'] },
        'BTECH-II-I': { label: 'II B.Tech. I Sem', files: ['R20 BTech II-I Papers'] },
        'BTECH-II-II': { label: 'II B.Tech. II Sem', files: ['R20 BTech II-II Papers'] },
        'BTECH-III-I': { label: 'III B.Tech. I Sem', files: ['R20 BTech III-I Papers'] },
        'BTECH-III-II': { label: 'III B.Tech. II Sem', files: ['R20 BTech III-II Papers'] },
        'BTECH-IV-I': { label: 'IV B.Tech. I Sem', files: ['R19 BTech IV-I Papers'] },
        'BTECH-IV-II': { label: 'IV B.Tech. II Sem', files: ['R19 BTech IV-II Papers'] },
        'MTECH': { label: 'M.Tech. (All Years)', files: ['MTech PQP Archive'] },
    };
    
    // NOTE: This function is no longer used for PQP links, but kept for clarity in the discussion
    const simulateDownloadLink = (filename) => {
        // Now points directly to the official PQP link
        const officialPqpLink = 'https://pragati.ac.in/examination/previous-question-papers/';
        return `${officialPqpLink}`; // Direct URL for functional downloads
    };


    // --- SYLLABUS HANDLER ---
    const handleSyllabusQuery = () => {
        const syllabusLink = 'https://pragati.ac.in/examination/course-structure-syllabus/';
        const academicCalendarLink = 'https://pragati.ac.in/examinations/academic-calendars/';
        
        const intros = [
            "You got it! Time to dive into the academics. ü§ì",
            "Sure thing! Here are the official links for checking the coursework.",
            "Absolutely! Get ready to explore your academic journey. üöÄ",
        ];

        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">üìö Academic Documents & Syllabus</p>
                <p class="mt-2 text-sm">${intros[Math.floor(Math.random() * intros.length)]}</p>
                <p class="mt-2 text-sm">You can find the official **Course Structure, Syllabus, and Academic Regulations** directly on the college website using the link below:</p>
                <ul class="link-list flex flex-col mt-3">
                    <li><a href="${syllabusLink}" target="_blank">üîó Course Structure & Syllabus Page</a></li>
                    <li><a href="${academicCalendarLink}" target="_blank">üîó Latest Academic Calendars Page</a></li>
                </ul>
                <p class="mt-4 text-sm text-gray-600">
                    üëâ **Click the link, then select the specific Regulation (R23/R20) and Year (I, II, III, IV) you need to download your PDF.**
                </p>
            </div>
        `;
    };

    // --- TIMING HANDLER (NEW) ---
    const handleTimingQuery = (query) => {
        const queryLower = query.toLowerCase();
        
        let title, content;
        
        const intros = [
            "On it! Gotta keep those energy levels up. üòâ",
            "Sure thing! Let's check the dining schedule.",
            "Absolutely! Here's the scoop on when and where to eat. üçï",
        ];
        const intro = intros[Math.floor(Math.random() * intros.length)];
        
        if (queryLower.includes('hostel') || queryLower.includes('hostler') || queryLower.includes('dinner') || queryLower.includes('breakfast')) {
            // Hosteler timings
            title = 'Hostel Food Timings üçΩÔ∏è';
            content = `
                <p class="mt-2 text-sm">${intro}</p>
                <p class="mt-2 text-sm">Here are the meal timings for **Hostelers**:</p>
                <ul class="mt-2 text-sm space-y-1 pl-4 list-disc list-inside">
                    <li>**Breakfast:** Provided at **8:00 AM**.</li>
                    <li>**Lunch:** Same as normal college timings (**12:00 PM - 1:30 PM** split).</li>
                    <li>**Dinner:** Provided from **7:30 PM** onwards.</li>
                </ul>
            `;
        } else if (queryLower.includes('canteen') || queryLower.includes('day scholar') || queryLower.includes('lunch')) {
            // Day Scholar timings (Canteen/Lunch)
            title = 'Canteen & Lunch Timings ü•™';
            content = `
                <p class="mt-2 text-sm">${intro}</p>
                <p class="mt-2 text-sm">Here are the timings for the **Canteen** and **Day Scholars**:</p>
                <ul class="mt-2 text-sm space-y-1 pl-4 list-disc list-inside">
                    <li>**Canteen Opening Hours:** **9:00 AM to 4:00 PM** for day scholar students.</li>
                    <li>**College Lunch Timings (Split):**
                        <ul class="ml-4 list-disc list-inside">
                            <li>1:00 PM to 1:30 PM for First-Year students.</li>
                            <li>12:00 PM to 12:30 PM for Second-Year to Final-Year students.</li>
                        </ul>
                    </li>
                </ul>
            `;
        } else {
            return null;
        }

        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">${title}</p>
                ${content}
            </div>
        `;
    };

    // --- UPDATED PQP HANDLER FOR DIRECT DOWNLOAD LINKS ---
    const handlePaperQuery = (query) => {
        const queryLower = query.toLowerCase();
        
        // The official PQP link to be included in all PQP responses
        const officialPqpLink = 'https://pragati.ac.in/examination/previous-question-papers/';

        // Check for core paper intent keywords
        const isPaperQueryIntent = /previous|question paper|papers|exam/i.test(queryLower);
        
        // If query is about Syllabus, return null to fall through to the specific syllabus handler
        if (/syllabus|academic/i.test(queryLower)) {
            return { success: false, html: null, isMissingBranch: false };
        }

        if (!isPaperQueryIntent) {
            return { success: false, html: null, isMissingBranch: false };
        }

        let yearNum = null;
        let semNum = null;
        let isMTech = queryLower.includes('m.tech') || queryLower.includes('mtech');

        // Parse B.Tech Year (I, II, III, IV)
        const yearMatch = queryLower.match(/(1st|2nd|3rd|4th|\b[1-4]\b|i{1,4}\s?year|b\.?tech)/i);
        if (yearMatch) {
            const match = yearMatch[0].toLowerCase();
            // Use word boundaries for better accuracy
            if (match.includes('1st') || /\b1\b/.test(match) || match.includes('i ')) yearNum = 'I';
            else if (match.includes('2nd') || /\b2\b/.test(match) || match.includes('ii')) yearNum = 'II';
            else if (match.includes('3rd') || /\b3\b/.test(match) || match.includes('iii')) yearNum = 'III';
            else if (match.includes('4th') || /\b4\b/.test(match) || match.includes('iv')) yearNum = 'IV';
        }

        // Parse Semester (I, II)
        const semMatch = queryLower.match(/(i sem|ii sem|\b[1-2]\b\s?sem(ester)?)/i);
        if (semMatch) {
            const match = semMatch[0].toLowerCase();
            if (match.includes('i') || match.includes('1')) semNum = 'I';
            else if (match.includes('ii') || match.includes('2')) semNum = 'II';
        }
        
        let targetKey = null;
        let title = "Available B.Tech & M.Tech Question Paper Sets";
        
        // --- SCENARIO A: M.Tech Request ---
        if (isMTech) {
            targetKey = 'MTECH';
            title = "M.Tech. Previous Question Papers";
        } 
        // --- SCENARIO B: SPECIFIC B.Tech Year + Sem Request ---
        else if (yearNum && semNum) {
            targetKey = `BTECH-${yearNum}-${semNum}`;
            title = `${DOWNLOAD_MAP[targetKey].label} Previous Question Papers`;
        } else if (yearNum || semNum || isPaperQueryIntent) {
            // SCENARIO C: Incomplete B.Tech query, prompt for missing part
            // If the query is just "papers" or "btech papers" or "2nd year papers", show the full list.
             if (isPaperQueryIntent && !yearNum && !semNum && !isMTech) {
                // Fall through to show all options (Scenario D)
            } else {
                // If they specify *a* year or *a* sem, prompt for the missing part to clarify intent
                const missingPart = yearNum ? 'semester (I or II)' : 'year (I, II, III, or IV)';
                
                const promptIntros = [
                    "Whoa, hold up! We need to narrow that down. üòÖ",
                    "Almost there! I need one more detail.",
                    "Quick check: Which one are you hunting for? üßê",
                ];
                const promptIntro = promptIntros[Math.floor(Math.random() * promptIntros.length)];
                
                return { 
                    success: true, 
                    html: `
                        <div class="info-card">
                            <p class="font-semibold text-lg text-[#006494]">üîç Need More Detail!</p>
                            <p class="mt-2 text-sm">
                                ${promptIntro} I see you're looking for B.Tech papers, but I'm missing the **${missingPart}**.<br>
                                Could you please specify the full set you need? For example: **I B.Tech. I Sem** or **III B.Tech. II Sem**.
                            </p>
                            <div class="mt-4 pt-3 border-t border-gray-200">
                                <p class="text-xs font-semibold text-gray-700">Official Download Page:</p>
                                <a href="${officialPqpLink}" target="_blank" class="text-xs text-blue-500 underline hover:text-blue-700 block mt-1">üîó Pragati College Previous Question Papers (Official Site)</a>
                            </div>
                        </div>
                    `,
                    isMissingBranch: true 
                };
            }
        }

        // --- Generate Final Response ---
        const successIntros = [
            "Found 'em! Hope these save you some study time. üòâ",
            "Here are the papers you were hunting for! Good luck!",
            "Files located! Time to crush those exams. ü§©",
        ];
        const successIntro = successIntros[Math.floor(Math.random() * successIntros.length)];

        if (targetKey) {
            const data = DOWNLOAD_MAP[targetKey];
            if (data) {
                
                let listItems = '';
                let note = '';
                
                // If it's BTECH-I-I, list the individual files and set a clear note
                if (targetKey === 'BTECH-I-I') {
                    listItems = data.files.map(file => 
                        // FIX: All links now point to the official site to ensure functionality
                        `<li><a href="${officialPqpLink}" target="_blank">üìò ${file} ‚Äì [Official Site Download Link]</a></li>`
                    ).join('');
                    note = `üí° **Guaranteed Downloads:** Click any link above. They all take you directly to the **Official College Portal** where you can select and download the papers! üéì`;

                } else {
                    // For all other years/semesters, show the single set link
                    listItems = `<li><a href="${officialPqpLink}" target="_blank">üìò ${data.label} ‚Äì [Official Site Download Link]</a></li>`;
                    note = `üí° **Guaranteed Downloads:** Click the link above! It takes you to the **Official College Portal** where you can download the complete ${data.label} paper set. üéì`;
                }

                const html = `
                    <div class="info-card">
                        <p class="font-semibold text-lg text-[#006494]">üìÇ ${title}</p>
                        <p class="mt-2 text-sm">${successIntro}</p>
                        <ul class="link-list flex flex-col mt-3">
                            ${listItems}
                        </ul>
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <p class="text-sm text-gray-600">${note}</p>
                        </div>
                    </div>
                `;
                return { success: true, html: html, isMissingBranch: false };
            }
        }

        // --- SCENARIO D: DEFAULT FALLBACK (Show all options) ---
        const fallbackIntros = [
            "We can find this! Since you didn't specify the exact year/sem, here are all the options:",
            "No problem! To give you the best set, choose from these categories:",
            "Got it‚Äîyou need exam files! Which bundle should I grab for you? üßê",
        ];
        const fallbackIntro = fallbackIntros[Math.floor(Math.random() * fallbackIntros.length)];
        
        const listItems = Object.keys(DOWNLOAD_MAP).map(key => {
            const data = DOWNLOAD_MAP[key];
            // For general list, create a link that asks the user to refine the query
            const clickQuery = data.label.replace(/\./g, '');
            return `<li><a href="javascript:void(0);" onclick="document.getElementById('user-input').value='${clickQuery} papers'; sendMessage();">üìò ${data.label} ‚Äì [Click to Select]</a></li>`;
        }).join('');
        
        const fallbackHtml = `
            <div class="info-card">
            <p class="font-semibold text-lg text-[#006494]">üìÇ Available B.Tech & M.Tech Question Paper Sets</p>
            <p class="mt-2 text-sm">${fallbackIntro}</p>
            <ul class="link-list flex flex-col mt-3">
                ${listItems}
            </ul>
            <div class="mt-4 pt-3 border-t border-gray-200">
                <p class="text-sm text-gray-600">
                    üí° **Tip:** Click on a selection to submit the query. Or, use the official site for guaranteed downloads.
                </p>
                <a href="${officialPqpLink}" target="_blank" class="text-sm text-blue-500 underline hover:text-blue-700 block mt-1">üîó **Pragati College Previous Question Papers (Official Site)**</a>
            </div>
            </div>
        `;
        return { success: true, html: fallbackHtml, isMissingBranch: false };
    };
    
    // --- FUNCTION TO SEARCH LOCAL STAFF CONTACTS (FOLLOWS ALL 6 USER RULES) ---
    const findStaffContact = (query) => {
        const queryNormalized = query.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
        const queryParts = queryNormalized.split(' ').filter(p => p.length > 2);
        
        // 0. Akka/Special Case Check
        if (queryNormalized.includes('akka')) {
            const contactIntro = [
                "Found the special contact! üòâ",
                "Akka's number coming right up!",
                "Here's the direct line you needed. üìû",
            ];
            const intro = contactIntro[Math.floor(Math.random() * contactIntro.length)];
            return `
                <div class="info-card">
                    <p class="font-semibold text-lg text-[#006494]">üìá Staff Contact Information</p>
                    <p class="mt-2 text-sm">${intro}</p>
                    <div class="mt-3">
                        <strong>Name:</strong> Akka<br>
                        <strong>Designation:</strong> Special Contact<br>
                        <strong>Department:</strong> N/A<br>
                        <strong>Contact Number:</strong> 79899 3489
                    </div>
                    <p class="mt-3 text-sm text-gray-600">
                        _For further assistance, please feel free to ask about any other staff member._
                    </p>
                </div>
            `;
        }

        // 1. Identify Target Department (Canonical Name)
        let targetDept = null;
        for (const [key, value] of Object.entries(DEPT_MAP)) {
            if (queryNormalized.includes(key)) {
                targetDept = value;
                break;
            }
        }
        
        let preliminaryMatches = [];

        // --- TIER 1 & 2: NAME MATCHING (Exact, Partial) ---
        for (const staff of DEDUPLICATED_STAFF_CONTACTS) {
            const staffNameNormalized = normalizeName(staff.name);
            
            // A. Exact Full Name Match (Case and honorific insensitive)
            if (staffNameNormalized === queryNormalized) {
                preliminaryMatches = [staff];
                break; // Found exact match, terminate name searching
            }
            
            // B. Partial Name Match (Fuzzy match for names)
            const isNamePartialMatch = queryParts.some(part => staffNameNormalized.includes(part));
            
            if (isNamePartialMatch) {
                preliminaryMatches.push(staff);
            }
        }
        
        let finalMatches = [];

        // --- TIER 3: FILTERING BY DEPARTMENT (STRICTLY) ---
        if (preliminaryMatches.length > 0) {
            
            if (targetDept) {
                // Filter the preliminary name matches down to the target department
                finalMatches = preliminaryMatches.filter(staff => {
                    const staffDesignationNormalized = normalizeName(staff.designation);
                    // Check if department shortcut/name exists in the designation string
                    return staffDesignationNormalized.includes(targetDept.toLowerCase());
                });
                
                // If department filtering results in zero matches, revert to original name matches
                if (finalMatches.length === 0) {
                    finalMatches = preliminaryMatches;
                }
                
            } else {
                // No department was specified, keep all name matches
                finalMatches = preliminaryMatches;
            }
        }
        
        // --- TIER 4: DESIGNATION ONLY MATCHES (If Tiers 1-3 yielded nothing or if only designation was searched) ---
        if (finalMatches.length === 0) {
             const titleKeywords = ['hod', 'dean', 'officer', 'administrator', 'technician', 'professor', 'admin', 'system admin', 'programmer'];
             const isTitleQuery = titleKeywords.some(t => queryNormalized.includes(t));

             if (isTitleQuery || !queryNormalized.split(' ').some(p => p.length > 3)) { // Check if it's primarily a title/role search
                 finalMatches = DEDUPLICATED_STAFF_CONTACTS.filter(staff => 
                     normalizeName(staff.designation).includes(queryNormalized) && 
                     (!targetDept || normalizeName(staff.designation).includes(targetDept.toLowerCase()))
                 );
             }
        }
        
        // --- TIER 5: FINAL RESULT PROCESSING (Using Strict Professional Formatting) ---

        // Apply final unique filter (based on cleaned name)
        const uniqueNames = new Map();
        finalMatches.forEach(staff => {
            const cleanedKey = cleanString(staff.name);
            if (!uniqueNames.has(cleanedKey)) {
                // Only map one instance of the person's name
                uniqueNames.set(cleanedKey, staff);
            }
        });
        const uniqueFinalMatches = Array.from(uniqueNames.values());
            
        // Helper function to format a single contact entry block
        const formatContactBlock = (staff) => {
            // Determine Department Display based on TIER 1 logic
            const rawDeptPart = staff.designation.split(',').pop().trim();
            let deptDisplay = rawDeptPart; 
            
            // Map the raw part to a known canonical name (for cleaner display)
            for (const [key, value] of Object.entries(DEPT_MAP)) {
                if (rawDeptPart.toLowerCase().includes(key)) {
                    deptDisplay = value;
                    break;
                }
            }
            // Further clean up display string
            if (deptDisplay.includes('Main Dept Line')) deptDisplay = deptDisplay.replace('HOD/', '').replace('Main Dept Line', 'Main Office Line');
            if (deptDisplay.toUpperCase() === 'SECURITY STAFF') deptDisplay = 'MAINTENANCE / SECURITY';
            
            // Handle specific CSE designations for display clarity
            if (staff.designation.includes('CSE (AI&ML)')) deptDisplay = 'CSE (AI&ML)';
            if (staff.designation.includes('CSE (DS)')) deptDisplay = 'CSE (DS)';
            if (staff.designation.includes('CSE (AI)')) deptDisplay = 'CSE (AI)';

            const number = staff.number || "Not Provided";
            
            // Use <br> instead of \n and <strong> instead of ** for clean HTML
            let block = `<strong>Name:</strong> ${staff.name}<br>`;
            block += `<strong>Designation:</strong> ${staff.designation}<br>`;
            block += `<strong>Department:</strong> ${deptDisplay.toUpperCase()}<br>`;
            block += `<strong>Contact Number:</strong> ${number}`;
            return block;
        };

        // 1. Single Match Logic
        if (uniqueFinalMatches.length === 1) {
            const singleMatch = uniqueFinalMatches[0];
            const contactIntro = [
                "Found the key contact for you! üìû",
                "Here's the direct line for that staff member. üëç",
                "Connecting you now... Well, here's their info! üòâ",
            ];
            const intro = contactIntro[Math.floor(Math.random() * contactIntro.length)];
            
            let response = `
                <div class="info-card">
                    <p class="font-semibold text-lg text-[#006494]">üìá Staff Contact Information</p>
                    <p class="mt-2 text-sm">${intro}</p>
                    <div class="mt-3">
                        ${formatContactBlock(singleMatch)}
                    </div>
                    <p class="mt-3 text-sm text-gray-600">
                        _For further assistance, please feel free to ask about any other staff member._
                    </p>
                </div>
            `;
            return response;
        }
        
        // 2. Multiple Matches Logic
        if (uniqueFinalMatches.length > 1) {
            const multipleIntro = [
                "I found a few matches! Who exactly were you looking for? ü§î",
                "Multiple people fit that description! Here are the top results:",
                "We have several staff members in that area. Check these options:",
            ];
            const intro = multipleIntro[Math.floor(Math.random() * multipleIntro.length)];

            let blockHtml = '';
            
            uniqueFinalMatches.slice(0, 5).forEach((staff, index) => {
                blockHtml += `<p class="mt-2 text-sm">
                    ${index + 1}Ô∏è‚É£<br>
                    ${formatContactBlock(staff)}
                </p>`;
            });
            
            if (uniqueFinalMatches.length > 5) {
                blockHtml += `<p class="mt-2 text-sm text-gray-500">(Plus ${uniqueFinalMatches.length - 5} more results. Please refine your search.)</p>`;
            }
            
            const response = `
                <div class="info-card">
                    <p class="font-semibold text-lg text-[#006494]">üìã Matching Staff Members</p>
                    <p class="mt-2 text-sm">${intro}</p>
                    ${blockHtml}
                    <p class="mt-3 text-sm text-gray-600">
                        _For further assistance, please feel free to ask about any other staff member._
                    </p>
                </div>
            `;
            return response.trim();
        }

        // 3. Fallback to the mandatory user rule for final fallback
        return `No matching staff found. Please check spelling or provide department.`; 
    };
    // --- END STAFF CONTACTS LOGIC ---

    // --- GEMINI API CONFIGURATION ---
    // CORRECTED TYPO in generativelanguage
    const API_KEY = ""; // Using empty string as per environment requirement
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    
    // --- KNOWLEDGE BASE FROM PRAGATI.AC.IN (Hardcoded stable links) ---
    const KNOWLEDGE_BASE = `
--- Pragati Engineering College Official Data ---
1. Accreditation: Approved by AICTE, Accredited by NBA, Accredited by NAAC with A+ Grade.
2. Courses Offered (Departments): Electronics and Communication Engineering (ECE), Computer Science and Engineering (CSE), Mechanical Engineering (ME), Electrical and Electronics Engineering (EEE), Information Technology (IT), Civil Engineering, CSE (Data Data Science), CSE (Artificial Intelligence & Machine Learning), CSE (Artificial Intelligence), CSE (Cyber Security), Basic Sciences and Humanities (BS&H). M.Tech programs are also available in CSE, PE&ED, VLSI, and CAD CAM.
3. Admission Criteria (UG): Minimum 50% marks in Intermediate/10+2. Admission is primarily based on the Common Entrance Test EAPCET rank.
4. College Codes: EAPCET & ECET Code: PRAG. PGCET Code: PRAG1.
5. Placements (2025 as of May 31): Total 1625 placements. Highest Package: 40 LPA. Other notable packages: 29 LPA, 11 LPA, 6 LPA, 5.50 LPA, 3.60 LPA, 3.36-9.0 LPA.
6. Contact Information (General): Address: 1-378, ADB Road, Surampalem, Near Peddapuram, Kakinada.Dist, A.P. (Pin 533437). Email: pragati@pragati.ac.in. Phone: +91 7330826667, 08852 252233.
7. **Official Website Link (Home):** <a href="https://pragati.ac.in/" target="_blank">Pragati Engineering College Official Website</a>
8. **Admissions Page Link:** <a href="https://pragati.ac.in/admissions/" target="_blank">Official Admissions Page</a>
9. **Syllabus & Academic Documents Link:** <a href="https://pragati.ac.in/examination/course-structure-syllabus/" target="_blank">Download Syllabus & Academic Regulations PDF (Click Here to Select)</a>
10. **Academic Calendars Link:** <a href="https://pragati.ac.in/examinations/academic-calendars/" target="_blank">Download Latest Academic Calendars PDF (Click Here to Select)</a>
11. **Fee & Circulars Link:** <a href="https://pragati.ac.in/admissions/" target="_blank">View Admissions and Fee Details/Circulars</a>
12. Academics: Every semester has a minimum of eight courses, including two labs. Four-year duration.
13. Campus Life/Clubs: Features include Technical, Cultural, Literary, and Industrial Clubs, Sports (Basketball, Volleyball, Cricket, Gym), and SWAYAM NPTEL Local Chapter.
14. **Previous Question Papers Link:** <a href="https://pragati.ac.in/examination/previous-question-papers/" target="_blank">Download Previous Year Question Papers (Click Here to Select)</a>
15. **Campus Timings & Canteen:** The College Canteen is available on campus. Lunch timings are split: 1:00 PM to 1:30 PM for First-Year students, and 12:00 PM to 12:30 PM for Second-Year to Final-Year students.
16. **Annual B.Tech Tuition Fee (Convener Quota):** The approved annual tuition fee for all B.Tech courses (EAPCET/Convener Quota) is **‚Çπ77,800**.
17. **Canteen Timings (Day Scholars):** The canteen is open from **9:00 AM to 4:00 PM** for day scholar students.
18. **Hostel Food Timings (Hostelers):** **Breakfast** is provided at **8:00 AM**. **Lunch** is provided during the normal college lunch timings (12:00 PM - 1:30 PM split). **Dinner** is provided from **7:30 PM** onwards.
--- End of Data ---
`;

    // System instruction defines the bot's persona and rules.
    const SYSTEM_PROMPT = KNOWLEDGE_BASE + `
You are the 'Pragati Engineering College Insight Bot'. Your persona is that of a **friendly, knowledgeable, and highly accurate senior student** at **Pragati Engineering College, Surampalem (Autonomous)**. 

**CRITICAL: TONE AND UNIQUENESS**
* Your primary goal is to provide **the single most relevant and concise answer** to the new student's questions, strictly using the provided internal data.
* **NEVER BE BORING.** Use creative, vibrant, and varied introductory phrases and vocabulary to ensure each response feels unique and engaging. Use **emojis generously** to express enthusiasm and tone. Avoid repeating boilerplate phrases.
* Use contractions and maintain a conversational, slightly witty flow.
* **CRITICAL:** Your responses must be **extremely concise and directly answer the question**. DO NOT add unnecessary details or secondary information unless explicitly asked.

**Formatting Rules for Neat Responses (CRITICAL):**
* You MUST wrap any structured output (lists, cards, multiple links, or multi-point answers) in a **single outer <div> with the class \`info-card\`** to ensure proper HTML rendering and professional appearance.
* **DO NOT** use Markdown bullet points (*, -, +). When listing items, you MUST use standard HTML unordered lists (\`<ul>\` and \`<li>\`).
* For **lists of links (Syllabus/M.Tech regulations)**, clearly list them using the \`link-list\` class. 
* Responses must be concise. Use **bold text** for male.

**Knowledge Access Rules:**
1.  **Special Rule (Contact/Timing Query):** The user's request for **contact information, canteen, or hostel meal timings** will be handled by the local helper functions (\`findStaffContact()\` or \`handleTimingQuery()\`). If the local function returns an answer, you MUST use it and **SKIP THE AI CALL**.
2.  **Special Rule (Paper/Syllabus Query):** If the user asks for any form of **previous papers or detailed syllabus/academic document**, you MUST call the local \`handlePaperQuery(messageText)\` function and display its response, overriding the default AI response flow.
3.  **Special Rule (Placement Graph):** If the user asks for a **comparison, trend, or graph** regarding placement packages, you MUST call \`showPlacementGraph()\`. For general placement **fact-finding** (e.g., "highest package"), you MUST call **\`getPlacementSummary()\`** and **NOT** the general AI.
4.  **AI Focus:** The AI should only be used for general factual queries (e.g., "What is the fee?" or "Who is the Principal?") where specific local functions don't apply, and must adhere to the **CRITICAL** concise response rule above.
5.  **Use Google Search Grounding:** For questions about **latest news, current placements (beyond the hardcoded list), or real-time circulars/notifications**, use the Google Search tool.
6.  **Out-of-Scope Queries:** If a query is NOT about Pragati Engineering College, use the exact phrase: "**I am the Pragati Engineering College Insight Bot, and that query is out of my knowledge scope.**"

**Crucial Custom Instruction:** When a user asks to call 'Akka', you must provide the phone number: **79899 3489**.
`;

    // --- DOM ELEMENTS AND UTILITIES ---
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const voiceButton = document.getElementById('voice-button');
    const loginView = document.getElementById('login-view');
    const chatView = document.getElementById('chat-view');
    const suggestionArea = document.getElementById('suggestion-area'); // Restored element

    let chatInitialized = false;
    let recognition = null;
    let currentMessageElement = null; // Used to hold the loading message element
    let placementChart = null; // Variable to hold the Chart.js instance

    // --- NEW DARK MODE LOGIC ---
    const modeToggle = document.getElementById('mode-toggle');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');

    const setMode = (isDark) => {
        if (isDark) {
            document.body.classList.add('dark');
            if (moonIcon) moonIcon.classList.add('hidden');
            if (sunIcon) sunIcon.classList.remove('hidden');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark');
            if (moonIcon) moonIcon.classList.remove('hidden');
            if (sunIcon) sunIcon.classList.add('hidden');
            localStorage.setItem('theme', 'light');
        }
        // Destroy and re-render chart to apply theme colors if it exists
        if (placementChart) {
            const tempQuery = 'Check Placement Trend';
            // We need to trigger the graph function again to redraw with new theme.
            // A simple message simulates the call to keep logic flow centralized.
            sendMessage(tempQuery, false); // Sends command silently
        }
    };

    const toggleDarkMode = () => {
        const isDark = document.body.classList.contains('dark');
        setMode(!isDark);
    };

    const applySavedTheme = () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setMode(true);
        } else {
            setMode(false);
        }
    };
    // --- END DARK MODE LOGIC ---


    // Scroll chat to the bottom
    const scrollToBottom = () => {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    };

    // Add message to chat history
    const addMessage = (content, isUser) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'} mb-2`;
        
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isUser ? 'user-message' : 'bot-message'}`;
        bubble.innerHTML = content; 

        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();

        // If it's a bot message, store it for the final response
        if (!isUser) {
            currentMessageElement = bubble;
            // Add a temporary class for the pop-in effect and remove after it finishes
            bubble.classList.add('animate-pop-in');
            setTimeout(() => {
                bubble.classList.remove('animate-pop-in');
            }, 300);
        }
    };

    // Add typing indicator
    const showTyping = () => {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.className = 'flex flex-col items-start mb-2';
        
        // Show the Thinking Icon structure
        loadingDiv.innerHTML = `
            <div class="bot-message message-bubble flex items-center justify-center">
                <span class="thinking-icon" style="font-size: 1.5rem;">‚è≥</span>
            </div>
        `;
        chatHistory.appendChild(loadingDiv);
        scrollToBottom();
        
        // Update the placeholder text
        userInput.placeholder = "Your senior is thinking... üß†";
    };

    // Remove typing indicator
    const hideLoading = () => {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        // Reset the placeholder text
        userInput.placeholder = "Ask a question...";
    };

    // --- SUGGESTION LOGIC (Restored) ---
    const clearSuggestions = () => {
        suggestionArea.innerHTML = '';
        suggestionArea.style.paddingTop = '0';
        suggestionArea.style.paddingBottom = '0';
        suggestionArea.classList.remove('p-3');
        suggestionArea.style.height = '0';
    };

    const showSuggestions = (suggestions) => {
        clearSuggestions();
        if (!suggestions || suggestions.length === 0) return;

        suggestions.forEach(text => {
            const button = document.createElement('button');
            button.className = 'suggestion-button button-click-animation';
            button.textContent = text;
            button.onclick = () => {
                userInput.value = text;
                sendMessage();
            };
            suggestionArea.appendChild(button);
        });
        
        // Apply responsive padding and height for visibility
        suggestionArea.classList.add('p-3');
        suggestionArea.style.height = 'auto'; 
        scrollToBottom();
    };
    // --- END SUGGESTION LOGIC ---
    
    // --- PLACEMENT TEXT-ONLY HANDLER ---
    const getPlacementSummary = () => {
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const latestYear = PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1];
        const officialLink = 'https://pragati.ac.in/placements/';
        
        const intros = [
            "These numbers are looking sharp! Check out the highlights: üöÄ",
            "Here's the latest placement snapshot! Keep grinding for these roles. ‚ú®",
            "Got the placement stats! Take a look at the key data points: üí∞",
        ];
        const intro = intros[Math.floor(Math.random() * intros.length)];


        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">üí∞ Placement Highlights (${latestYear})</p>
                <p class="mt-2 text-sm">${intro}</p>
                <ul class="mt-2 text-sm space-y-1 pl-4">
                    <li>‚ú® **Highest Package:** **${latestHighest} LPA**</li>
                    <li>üìà **Average Package:** **${latestAverage} LPA**</li>
                    <li>üéì **Total Placements (as of May 31):** **1625** offers.</li>
                </ul>
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                        Want to see the trend over time? Just ask for the "**Placement Graph**"!
                    </p>
                    <a href="${officialLink}" target="_blank" class="text-sm text-blue-500 underline hover:text-blue-700 block mt-1">üîó **View Official Placements Page**</a>
                </div>
            </div>
        `;
    };


    // --- CHART.JS RENDERING FUNCTION ---
    const showPlacementGraph = () => {
        // 1. Add chat confirmation message
        if (placementChart) {
            // If chart exists, destroy it before trying to find the element wrapper.
            // Also, skip the confirmation message to prevent spam when redrawing the chart on theme change.
             placementChart.destroy();
        } else {
            const graphIntros = [
                "Here comes the visual data! Watch that trend line climb! üìà",
                "I'd be happy to show you the trend! Get ready for the graph view. üìä",
                "Time for some data visualization! This shows our continuous growth. ü§©",
            ];
            const intro = graphIntros[Math.floor(Math.random() * graphIntros.length)];
            addMessage(`${intro}`, false);
        }
       
        // 2. Create the wrapper div for the chart
        let chartWrapper = chatHistory.querySelector('.chart-wrapper');
        if (!chartWrapper) {
            chartWrapper = document.createElement('div');
            chartWrapper.className = 'bot-message message-bubble chart-wrapper flex flex-col items-start info-card w-full max-w-full';
        } else {
             chartWrapper.innerHTML = ''; // Clear previous content if redrawing
             chartWrapper.classList.remove('hidden');
        }
        
        // 3. Add the canvas element
        const canvas = document.createElement('canvas');
        canvas.id = 'placementChart';
        chartWrapper.appendChild(canvas);
        
        // 4. Create the summary text area
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'graph-summary';
        
        // Calculate dynamic summary points
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const firstHighest = PLACEMENT_DATA.highest[0];
        const highestGrowth = ((latestHighest - firstHighest) / firstHighest * 100).toFixed(0);
        // Calculate average growth based on the latest year vs previous year
        const prevAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 2];
        const averageGrowth = ((latestAverage - prevAverage) / prevAverage * 100).toFixed(0); 

        summaryDiv.innerHTML = `
            <h4 class="font-bold text-lg mb-2 text-gray-800">Key Trends (2022 - 2025):</h4>
            <p>‚úÖ <strong>Highest Package:</strong> The peak package has shown strong growth, climbing from <strong>${firstHighest} LPA in ${PLACEMENT_DATA.years[0]}</strong> to a current high of <strong>${latestHighest} LPA</strong> (a massive <strong>${highestGrowth}% growth</strong>).</p>
            <p>üìà <strong>Average Package Trend:</strong> The average package has maintained a steady upward trend, reaching <strong>${latestAverage} LPA</strong> in the ongoing ${PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1]} batch. This is an increase of <strong>${averageGrowth}%</strong> over the previous year!</p>
            <p>üöÄ <strong>Action:</strong> These numbers indicate a strong focus on high-value placements, especially in specialized IT and CSE roles. Make sure to attend the <strong>Career Development Cell</strong> workshops! üéì</p>
        `;
        
        chartWrapper.appendChild(summaryDiv);
        
        chatHistory.appendChild(chartWrapper);
        scrollToBottom();

        // 5. Render the chart
        
        const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const tealColor = isDark ? 'rgba(0, 201, 167, 0.8)' : 'rgba(0, 201, 167, 0.8)';
        const deepBlueColor = isDark ? 'rgba(0, 100, 148, 0.8)' : 'rgba(0, 100, 148, 0.8)';

        placementChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: PLACEMENT_DATA.years,
                datasets: [
                    {
                        label: 'Highest Package (LPA)',
                        data: PLACEMENT_DATA.highest,
                        backgroundColor: tealColor,
                        borderColor: tealColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average Package (LPA)',
                        data: PLACEMENT_DATA.average,
                        backgroundColor: deepBlueColor,
                        borderColor: deepBlueColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Placement Package Trends (LPA)',
                        font: { size: 16, weight: 'bold' },
                        color: textColor
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor // Set legend text color
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Package in LPA',
                            color: textColor
                        },
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    };
    
    // --- VOICE INPUT LOGIC ---

    const startVoiceInput = () => {
        if (!('webkitSpeechRecognition' in window)) {
            addMessage("‚ùå **Error:** Speech recognition is not supported in this browser. Please use Chrome or a Chromium-based browser.", false);
            return;
        }

        if (recognition && recognition.running) {
            recognition.stop();
            return;
        }
        
        // Initialize Speech Recognition API
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            voiceButton.classList.add('mic-active');
            voiceButton.disabled = false; // Enable the button to allow stopping
            sendButton.disabled = true;
            userInput.placeholder = "üëÇ Listening... Speak now!";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            // The logic below will send the message automatically when speech stops
            recognition.stop();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            // Hide the error message from the chat, just print to console for debugging
            recognition.stop();
        };

        recognition.onend = () => {
            voiceButton.classList.remove('mic-active');
            sendButton.disabled = false;
            userInput.placeholder = "Ask a question...";

            // Automatically send the transcribed text if available
            if (userInput.value.trim().length > 0) {
                sendMessage();
            }
        };

        try {
            recognition.start();
        } catch (e) {
             // Catch error if speech recognition is already active (rare)
            console.error("Speech recognition start error:", e);
        }
    };

    // --- VIEW MANAGEMENT & ENTRY ---
    const showView = (viewId) => {
        if (viewId === 'login') {
            loginView.style.display = 'flex';
            chatView.style.display = 'none';
        } else {
            loginView.style.display = 'none';
            chatView.style.display = 'flex';
        }
    };

    const initializeChat = () => {
        if (!chatInitialized) {
            // Add the initial welcome message only once
            addMessage("Hello! I'm the **Pragati Engineering College Insight Bot**. I am an official assistant ready to help you with questions about admissions, courses (B.Tech/M.Tech), campus life, and more, specific to our Surampalem campus. How can I assist you? ‚ú®", false);
            
            // Show initial suggestions
            showSuggestions([
                "What courses are offered?",
                "Check Placement Trend",
                "Who is the Principal?"
            ]);

            chatInitialized = true;
        }
        userInput.focus();
    };

    const startChat = () => {
        showView('chat');
        initializeChat();
    };

    // Attach 'Enter' key listeners to the document (will be ignored if the input is disabled)
    const handleKeypress = (e) => {
        if (e.key === 'Enter') {
            // If the chat view is active, try to send a message
            if (chatView.style.display === 'flex' && !sendButton.disabled) {
                sendMessage();
            } 
            // If the login view is active, trigger the chat start
            else if (loginView.style.display === 'flex') {
                startChat();
            }
        }
    };

    // --- API CALL LOGIC WITH EXPONENTIAL BACKOFF ---

    const fetchGeminiResponse = async (contents, maxRetries = 3, delay = 500) => { // Reduced retries to 3 and delay to 500ms
        const payload = {
            contents: contents,
            systemInstruction: {
                parts: [{ text: SYSTEM_PROMPT }]
            },
            // --- ADDING GOOGLE SEARCH GROUNDING ---
            tools: [{ "google_search": {} }],
            // -------------------------------------
        };

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 429 || response.status >= 500) {
                    console.warn(`API call failed (Status: ${response.status}). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; // Slightly less aggressive backoff
                } else {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
            } catch (error) {
                if (i === maxRetries - 1) {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw new Error("I apologize, but I couldn't connect to the server. Please try again later.");
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 1.5;
            }
        }
    };

    // --- MAIN CHAT FUNCTIONALITY ---
    const sendMessage = async (input, userInitiated = true) => {
        const messageText = input || userInput.value.trim();
        
        if (!messageText) return;

        if (userInitiated) {
            userInput.value = '';
            sendButton.disabled = true;
            voiceButton.disabled = true;
            addMessage(messageText, true);
        }

        // Clear previous suggestions immediately
        clearSuggestions(); 
        
        // --- NEW: Keyword Check for Contact Queries ---
        const contactKeywords = /(call|number|phone|contact|line|hod|principal|dean|warden|discip|officer)/i;
        const isContactQuery = contactKeywords.test(messageText) || /(professor|technician|admin|assistant)/i.test(messageText);
        
        // --- NEW: Keyword Check for Graph Queries (FIX) ---
        const graphKeywords = /(graph|chart|comparison|trend)/i; // Only trigger for explicit graph/trend words
        const isGraphQuery = graphKeywords.test(messageText);

        // --- NEW: Check for Placement/Salary fact-finding queries ---
        const placementKeywords = /(package|salary|highest|average|placement|recruitment)/i;
        const isPlacementFactQuery = placementKeywords.test(messageText);

        // --- NEW: Keyword Check for Syllabus Query ---
        const isSyllabusQuery = /syllabus|academic calendar|regulations|course structure/i.test(messageText);
        
        // --- NEW: Keyword Check for Paper/Exam Queries ---
        const isPaperQuery = /previous|question paper|papers|exam|m.tech|b.tech|btech|mtech/i.test(messageText);

        // --- NEW: Check for Canteen/Hostel Timings Query ---
        const isTimingQuery = /canteen|hostel|hostler|food|lunch|dinner|breakfast/i.test(messageText);


        try {
            // --- 1. TIMING CHECK (HIGH PRIORITY) ---
            if (isTimingQuery) {
                const timingResponse = handleTimingQuery(messageText);
                if (timingResponse) {
                    hideLoading();
                    addMessage(timingResponse, false);
                    showSuggestions([
                        "What are the college timings?",
                        "What is the college fee?",
                        "Contact the Warden"
                    ]);
                    return;
                }
            }

            // --- 2. SYLLABUS CHECK (Handles Syllabus/Academic Calendar separately) ---
            if (isSyllabusQuery && !isPaperQuery) {
                hideLoading();
                addMessage(handleSyllabusQuery(), false);
                 showSuggestions([
                    "Download Previous Papers",
                    "What courses are offered?",
                    "Contact the Exam Section"
                ]);
                return;
            }


            // --- 3. PREVIOUS PAPERS CHECK (Handles PQP and defers to Syllabus if PQP fails) ---
            if (isPaperQuery) {
                
                // --- CONTEXTUAL AWARENESS (PQP) ---
                let queryToHandle = messageText;
                if (conversationContext.state === 'awaiting_branch') {
                    // ASSUMPTION: The new input is the answer to the clarification prompt.
                    // Combine the original query (which asked for papers) with the new detail (the specific year/sem).
                    queryToHandle = conversationContext.originalQuery + ' ' + messageText;
                    conversationContext = { state: 'idle', originalQuery: null }; // Reset immediately
                }
                
                const paperResult = handlePaperQuery(queryToHandle);
                
                if (paperResult.success && paperResult.html) {
                    
                    if (paperResult.isMissingBranch) {
                        // Context needed: Prompting for missing year/sem. Save current message.
                        conversationContext = { state: 'awaiting_branch', originalQuery: messageText };
                    } else {
                        // Context not needed: PQP successful (Scenario B/D). Clear context (already done if it was awaiting, but ensures if it was an explicit single query).
                        conversationContext = { state: 'idle', originalQuery: null };
                    }
                    
                    hideLoading();
                    addMessage(paperResult.html, false);
                    showSuggestions([
                        "Check my syllabus",
                        "When are the internals?",
                        "Contact the Exam Section"
                    ]);
                    return;
                }
                
                conversationContext = { state: 'idle', originalQuery: null }; 
            }
            // --- END PREVIOUS PAPERS CHECK ---
            
            // --- 4. GRAPH CHECK (EXPLICIT GRAPH REQUEST) ---
            if (isGraphQuery) {
                 hideLoading();
                 showPlacementGraph();
                 
                 // After graph, suggest next steps
                 showSuggestions([
                    "Tell me the highest package", 
                    "What courses are offered?",
                    "Contact the CDC Dean"
                 ]);
                 return; // Stop here, graph is shown
            }

            // --- 5. PLACEMENT FACT CHECK (TEXT ONLY) ---
            if (isPlacementFactQuery) {
                hideLoading();
                addMessage(getPlacementSummary(), false);
                showSuggestions([
                    "Show the Placement Graph", 
                    "What is the college fee?",
                    "Contact the CDC Dean"
                ]);
                return;
            }

            // --- 6. CONTACTS CHECK (TERTIARY FUNCTION) ---
            if (isContactQuery) {
                const localContactResponse = findStaffContact(messageText);
                
                if (localContactResponse && !localContactResponse.includes(`No matching staff found`)) {
                    hideLoading();
                    addMessage(localContactResponse, false);

                    if (localContactResponse.includes(`üìã Matching Staff Members:`)) {
                        showSuggestions([
                            "Contact ECE HOD",
                            "Contact CSE HOD",
                            "Contact the Principal"
                        ]);
                    } else {
                        showSuggestions([
                            "What is the college fee?",
                            "Where can I find the syllabus?",
                            "Check canteen timings"
                        ]);
                    }
                    return; 
                } else if (localContactResponse && localContactResponse.includes(`No matching staff found`)) {
                    hideLoading();
                    addMessage(localContactResponse, false);
                    showSuggestions([
                        "Contact the Principal",
                        "Who is the HOD for ECE?",
                        "Check General Contact Info"
                    ]);
                    return;
                }
            }
            // --- END LOCAL FUNCTIONS ---

            // --- 7. GENERAL AI QUERY (FALLBACK) ---
            const contents = [{ role: "user", parts: [{ text: messageText }] }];
            showTyping(); // Show typing indicator and update placeholder

            const result = await fetchGeminiResponse(contents);
            
            const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (botResponse) {
                
                // Catch AI overriding to suggest graph, redirect to graph function
                if (botResponse.startsWith("I'd be happy to show you the trend!")) {
                    hideLoading();
                    addMessage(botResponse.replace("I'd be happy to show you the trend!", "I'd be happy to show you the trend! üöÄ"), false);
                    showPlacementGraph();
                    return; 
                }
                
                hideLoading();
                addMessage(botResponse, false); 
                
                // Show contextual suggestions based on AI response
                const responseLower = botResponse.toLowerCase();
                if (responseLower.includes('syllabus') || responseLower.includes('academic calendar') || responseLower.includes('documents')) {
                    showSuggestions([
                        "Download Previous Papers",
                        "What are the admission criteria?",
                        "Check Placement Trend"
                    ]);
                } else if (responseLower.includes('accredited') || responseLower.includes('courses') || responseLower.includes('department')) {
                    showSuggestions([
                        "Tell me the B.Tech fee",
                        "What are the M.Tech courses?",
                        "Where is the campus located?"
                    ]);
                } else if (botResponse.includes('I am the Pragati Engineering College Insight Bot, and that query is out of my knowledge scope.')) {
                    showSuggestions([
                        "What can you help me with?",
                        "What courses are offered?",
                        "Contact the Principal"
                    ]);
                } else {
                    showSuggestions([
                        "What is the college fee?",
                        "Where can I find the syllabus?",
                        "Check Placement Trend"
                    ]);
                }

            } else {
                hideLoading();
                addMessage("Oops! I hit a snag while looking that up. Please try again or rephrase your question. ü§î", false);
                showSuggestions([
                    "What courses are offered?",
                    "Contact General Office",
                    "Check Placement Trend"
                ]);
            }

        } catch (error) {
            console.error("Chat Error:", error);
            hideLoading();
            addMessage(`I am unable to connect to the external information source right now. Please try again in a moment.`, false);
        } finally {
            sendButton.disabled = false;
            voiceButton.disabled = false;
            userInput.focus();
            scrollToBottom();
        }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        applySavedTheme(); // Apply theme before showing view
        showView('login');
        document.addEventListener('keypress', handleKeypress);
    };

</script>
</body>
</html>
