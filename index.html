<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Insight Chatbot</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic buttons --><script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for visualization --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for a modern, rounded chat interface */
        :root {
            /* --- NEW VIBRANT TEAL THEME --- */
            --primary-color: #00C9A7; /* Vibrant Teal/Cyan - Primary Accent */
            --radiant-blue-start: #00D2D3; /* Lighter Teal for Gradient Start */
            --radiant-blue-end: #006494; /* Deep Ocean Blue for Gradient End */
            --bot-bubble: #e0fff8; /* Soft Mint/Light Teal - NEW COLOR */
            --user-bubble: var(--primary-color);
            --text-color-light-default: #1f2937; /* Dark Gray for high contrast in Light Mode (Changed from #374151) */
            --text-color-dark-default: #e5e7eb; /* Light Gray for high contrast in Dark Mode (Changed from #d1d5db) */
        }
        
        /* --- DARK MODE VARIABLES AND BASE STYLES --- */
        .dark {
            --background-color: #0d0d0d; /* Even Deeper Dark Background */
            --surface-color: #1f1f1f; /* Darker Surface */
            --bot-bubble: #282828; /* Darker grey for bot bubble */
            --text-color: var(--text-color-dark-default);
            --link-color: #00D2D3;
        }

        .dark body {
            background-color: var(--background-color);
            background-image: none; /* Remove bright background image in dark mode */
            color: var(--text-color);
        }

        .dark body::before {
            background-color: rgba(0, 0, 0, 0.8); /* Stronger overlay */
        }

        .dark body::after {
            color: rgba(0, 168, 135, 0.06); /* Even Fainter watermark */
        }

        .dark .card-container {
            background: linear-gradient(145deg, #004d73 0%, #00a09a 100%); /* Adjusted dark gradient */
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 30px rgba(0, 201, 167, 0.4); /* Softer glow */
        }

        .dark #login-card {
            background-color: rgba(31, 31, 31, 0.98); /* Near opaque */
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.7);
        }

        .dark h2, .dark p, .dark .feature-item p, .dark .chat-header h1, .dark .chat-header p, .dark .graph-summary h4, .dark .graph-summary p {
            color: var(--text-color); /* Light text color for dark mode */
        }
        .dark .feature-item {
            background-color: rgba(40, 40, 40, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .dark #chat-history { /* Brighter chat history in dark mode for better separation */
            background-color: #1a1a1a;
        }
        /* --- END DARK MODE BASE STYLES --- */

        body {
            font-family: 'Inter', sans-serif;
            /* --- UPDATED: New Background Image --- */
            background-image: url('https://i.postimg.cc/qRSBHZwg/1b6896fd-e68c-4630-9143-40d15911d44c.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2c3e50; /* Deep Charcoal Fallback */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Transparent overlay over the background color/image */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(22, 33, 44, 0.7); /* Darker, modern transparency */
            z-index: -1; /* Place it between the chat (z=1) and the text (z=-2) */
        }
        
        /* --- NEW: Branded Text Watermark in the Background --- */
        body::after {
            content: "PRAGATI ENGINEERING COLLEGE";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Center and rotate slightly */
            font-size: 8vw; /* Large, fluid size */
            font-weight: 900; /* Extra bold */
            color: rgba(0, 168, 135, 0.15); /* Darker Teal/Green, very faint */
            letter-spacing: 0.5rem;
            pointer-events: none; /* Ignore mouse events */
            z-index: -2; /* Place behind the color overlay */
            white-space: nowrap;
            /* GLOW EFFECT: Strong text shadow in the primary color */
            text-shadow: 0 0 10px rgba(0, 201, 167, 0.5), 0 0 20px rgba(0, 201, 167, 0.3);
        }
        /* -------------------------------------------------- */


        .card-container {
            width: 100%;
            max-width: 640px;
            /* Height changes based on content (login is shorter, chat is taller) */
            display: flex;
            flex-direction: column;
            /* --- RADIANT TEAL & SHINY TEXTURE STYLES (Outer container) --- */
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
            border: 2px solid rgba(255, 255, 255, 0.5); /* Lighter border for shine */
            border-radius: 1rem;
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3); /* Teal Glow and inner shine */
            overflow: hidden;
            z-index: 1;
        }

        /* Styling for the Welcome Screen (centered within the container) */
        #login-view {
            width: 100%;
            height: 90vh;
            max-height: 800px;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        /* Cool Glassmorphism Welcome Card */
        #login-card {
            background-color: rgba(255, 255, 255, 0.95); /* Near opaque white for contrast */
            backdrop-filter: blur(15px); /* Stronger frosted glass effect */
            -webkit-backdrop-filter: blur(15px); /* For Safari support */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.35); /* Stronger shadow */
            width: 100%;
            max-width: 450px; /* Wider card */
            text-align: center;
            transition: all 0.3s ease;
            transform: scale(1.05);
        }
        
        /* --- GLOWING WELCOME TEXT (H2 ONLY) --- */
        #login-card h2 {
            color: var(--primary-color); /* Neon Teal */
            text-shadow: 0 0 8px var(--primary-color), 0 0 20px rgba(0, 201, 167, 0.5); 
        }
        #login-card p {
            color: #555; /* Default gray for subtitle */
        }
        /* --- END GLOWING WELCOME TEXT --- */

        /* --- FEATURE BOX GLOWING TEXT (NEW) --- */
        .feature-item-title {
            color: var(--primary-color) !important; /* Ensure primary color */
            text-shadow: 0 0 5px var(--primary-color); /* Apply glow */
        }
        /* --- END FEATURE BOX GLOWING TEXT --- */
        
        /* --- CHAT VIEW STYLES --- */
        #chat-view {
            width: 100%;
            max-width: 640px;
            height: 90vh;
            max-height: 800px;
            display: none; /* Controlled by JS */
            flex-direction: column;
        }
        #chat-container {
            width: 100%;
            height: 100%;
            flex-direction: column; 
        }

        .chat-header {
            padding: 1rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f7fcfc; /* Very light mint background for light mode */
            scroll-behavior: smooth;
        }
        .dark #chat-history {
            background-color: #1a1a1a; /* Dark gray for dark mode */
        }

        /* Input Area update - kept white for contrast */
        #input-area {
            padding: 1rem; 
            border-top: 1px solid #ccc; 
            background-color: white; 
            display: flex; 
            align-items: center;
        }
        .dark #input-area {
            background-color: var(--surface-color);
            border-top-color: #333;
        }

        /* --- NEW SUGGESTION BUTTON STYLES (Restored) --- */
        .suggestion-button {
            padding: 0.5rem 1rem;
            background-color: #f0fdfa; /* Lightest Teal/Mint */
            border: 1px solid #00C9A7;
            color: #006494; /* Deep Blue text for visibility */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px; /* Full rounded corners */
            cursor: pointer;
            transition: all 0.2s ease;
            transform: scale(0.95);
        }
        .suggestion-button:hover {
            background-color: #00C9A7;
            color: white;
            transform: scale(1.0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .dark .suggestion-button {
            background-color: #2e2e2e;
            border-color: #006494;
            color: #00C9A7;
        }
        .dark .suggestion-button:hover {
            background-color: #00A887;
            color: #1f1f1f;
        }
        /* --- END SUGGESTION STYLES --- */
        
        /* --- INPUT FOCUS GLOW --- */
        #user-input {
            transition: box-shadow 0.3s ease;
        }
        #user-input:focus {
            box-shadow: 0 0 0 4px rgba(0, 201, 167, 0.4); /* Teal glow */
        }
        .dark #user-input {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        /* --- END INPUT FOCUS GLOW --- */


        /* Styling for the messages */
        .message-bubble {
            /* CRITICAL FIX: REDUCED VERTICAL PADDING */
            padding: 0.5rem 1rem; /* Reduced from 0.75rem */
            border-radius: 1.25rem;
            max-width: 85%;
            /* CRITICAL FIX: REDUCED BOTTOM MARGIN */
            margin-bottom: 0.3rem; /* Reduced from 0.5rem */
            line-height: 1.4; /* TIGHTENED LINE HEIGHT */
            word-wrap: break-word;
            /* Added pop-in animation to bot responses */
            animation: pop-in 0.3s ease-out;
        }
        .user-message {
            background-color: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            background-color: var(--bot-bubble);
            color: var(--text-color-light-default); /* Darker Gray text for high contrast */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap;
        }
        .dark .bot-message {
            background-color: var(--bot-bubble); /* Darker bot bubble */
            color: var(--text-color-dark-default); /* Light text in dark mode */
        }

        /* Style for anchor tags in the bot's response to make them stand out */
        .bot-message a {
            color: #006494; /* Deep Blue link color */
            text-decoration: underline;
            font-weight: 700;
        }
        .dark .bot-message a {
            color: var(--link-color);
        }

        /* --- NEW STYLES FOR NEAT RESPONSES --- */
        .info-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            /* CRITICAL FIX: REDUCED INFO CARD PADDING */
            padding: 0.5rem 0.75rem; /* Reduced top/bottom padding even further */
            border: 1px solid #c9d6e4; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-top: 0.3rem; /* Reduced margin-top */
            word-break: break-word;
            /* Default body text color for high contrast */
            color: var(--text-color-light-default);
        }
        .dark .info-card {
            background-color: #2e2e2e; /* Slightly lighter surface for nested card */
            border-color: #555;
            box-shadow: 0 44px 10px rgba(0, 0, 0, 0.3);
            color: var(--text-color-dark-default); /* High contrast text in dark mode */
        }
        
        /* CRITICAL FIX: TIGHTER SPACING INSIDE INFO CARD */
        .info-card p {
            margin-top: 0.1rem; /* Micro-adjustment */
            margin-bottom: 0.1rem; /* Micro-adjustment */
            line-height: 1.35; /* Tighter line spacing for content paragraphs */
        }
        .info-card .font-semibold.text-lg {
             margin-bottom: 0; /* Zero margin after title */
        }
        
        .info-card .contact-details {
            font-weight: bold;
            color: #006494;
            display: block;
            margin-top: 0.25rem;
        }
        /* Ensure all internal text elements use the default high-contrast color */
        .info-card p, .info-card ul li, .info-card strong {
             color: inherit !important; /* Inherit the high-contrast color set above */
        }
        .dark .info-card p, .dark .info-card ul li {
             color: var(--text-color-dark-default) !important;
        }
        /* Re-apply accent colors where necessary */
        .info-card strong {
            font-weight: 700;
        }
        .info-card .accent-highlight {
            color: #006494 !important;
            font-weight: 700;
        }
        .dark .info-card .accent-highlight {
            color: #00D2D3 !important;
        }
        /* CRITICAL READABILITY FIXES */
        .info-card .contact-name-text {
            color: #000000 !important; /* Pure black on light background */
        }
        .dark .info-card .contact-name-text {
            color: #ffffff !important; /* Pure white on dark background */
        }
        .info-card .contact-designation-text {
            color: #1f2937 !important; /* Dark Gray for light mode designation */
        }
        .dark .info-card .contact-designation-text {
            color: #d1d5db !important; /* Light Gray for dark mode designation */
        }
        /* Phone number is handled in JS template below to use different accents for contrast */


        .info-card ul {
            display: flex;
            flex-wrap: wrap; 
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .info-card li {
            list-style: none;
        }
        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            width: 50%;
            min-width: 150px;
            padding-right: 1rem;
        }
        @media (max-width: 480px) {
            .info-item {
                width: 100%;
            }
        }
        .info-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
            color: var(--primary-color); /* Teal icon color */
            line-height: 1.5;
            flex-shrink: 0;
        }
        .link-list {
            list-style: none;
            padding: 0;
            margin-top: 0.2rem; /* Reduced margin-top */
        }
        .link-list li {
            margin-bottom: 0.1rem; /* Reduced margin-bottom */
            padding-left: 1.5rem;
            position: relative;
        }
        .link-list li::before {
            content: "ðŸ”—";
            position: absolute;
            left: 0;
            top: 0;
        }
        /* --- NEW GRAPH SUMMARY STYLES --- */
        .graph-summary {
            margin-top: 0.4rem; /* Reduced margin-top */
            padding-top: 0.4rem; /* Reduced padding-top */
            border-top: 1px solid #c9d6e4;
            font-size: 0.95rem;
        }
        .dark .graph-summary {
            border-top-color: #555;
        }
        .graph-summary p {
            margin-bottom: 0.2rem; /* Reduced margin-bottom */
        }
        .graph-summary strong {
            color: #006494; /* Deep Blue for highlights */
        }
        .dark .graph-summary strong {
            color: #00D2D3; /* Lighter highlight in dark mode */
        }
        /* ------------------------------------- */

        /* --- NEW LOADING ANIMATION (Branded Pulsing Ring) --- */
        /* The container for the entire loading logo block (Acts as the bubble frame) */
        #loading-indicator-container {
             background-color: var(--bot-bubble);
             border-radius: 1.25rem;
             padding: 0.4rem; /* Minimal padding around the logo */
             margin-bottom: 0.3rem; /* Reduced margin-bottom */
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .dark #loading-indicator-container {
             background-color: var(--bot-bubble);
             box-shadow: 0 1px 3px rgba(255, 255, 255, 0.1);
        }

        /* Wrapper for the logo and the ring */
        .loading-logo-wrapper {
            position: relative;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-logo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            z-index: 2;
            position: relative;
        }
        
        /* The actual rotating ring element */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-ring {
            from { opacity: 0.7; transform: scale(1.0); }
            to { opacity: 1.0; transform: scale(1.05); } 
        }

        .loading-ring {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            /* FIX: Set all borders to transparent first, then overwrite only top for clean spin */
            border: 3px solid transparent; 
            border-top-color: var(--primary-color); /* Isolate color to top section */
            z-index: 1;
            /* Apply the spin animation */
            animation: spin 1s infinite linear; 
            /* Optional: Add a subtle color pulse for engagement without disrupting the spin */
            box-shadow: 0 0 10px rgba(0, 201, 167, 0.5); 
        }
        
        /* Remove the generic bubble styling for the specific loading message */
        #loading-indicator .bot-message {
            padding: 0 !important; /* Zero padding on inner bubble */
            background-color: transparent !important;
            box-shadow: none !important;
        }
        /* --- END NEW LOADING ANIMATION --- */


        /* --- New Pop-In Animation for Bubbles --- */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* --- END Pop-In Animation --- */
        
        /* --- BUTTON CLICK ANIMATION --- */
        .button-click-animation {
            transition: transform 0.1s;
        }
        .button-click-animation:active {
            transform: scale(0.9);
        }
        /* --- END BUTTON CLICK ANIMATION --- */


        .mic-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from {
                box-shadow: 0 0 0 0 rgba(0, 201, 167, 0.7);
                background-color: #ff6347; /* Tomato red when recording */
            }
            to {
                box-shadow: 0 0 0 10px rgba(0, 201, 167, 0);
                background-color: #ff4500;
            }
        }

        /* --- NEW DASHBOARD ANIMATION --- */
        @keyframes scale-up {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        .feature-item {
            transition: all 0.2s ease;
        }
        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* New custom style for highly condensed contact card */
        .contact-card {
            padding: 0.75rem !important; /* Smaller padding inside the info-card */
            max-width: 320px; /* Limit width for dense look */
            background-color: var(--bot-bubble) !important; /* Use bot bubble color for consistency */
            border: 1px solid rgba(0, 100, 148, 0.2) !important; /* Light border */
        }
        .dark .contact-card {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        /* Ensure the message bubble containing the card is styled correctly */
        .message-bubble.bg-transparent {
            background-color: transparent !important;
            box-shadow: none !important;
            padding: 0.75rem 1rem !important;
        }
        .message-bubble.p-0 {
            padding: 0 !important;
        }
        /* NEW: Aggressively compact list style for dense information display */
        .compact-list li {
            margin-bottom: 0px !important;
            padding-top: 2px !important;
            padding-bottom: 2px !important;
        }
        /* Added for professional spacing */
        .info-divider {
            border-top: 1px solid #e5e7eb;
            /* CRITICAL FIX: REDUCED VERTICAL MARGINS */
            margin-top: 0.4rem; /* Reduced to 0.4rem */
            padding-top: 0.4rem; /* Reduced to 0.4rem */
        }
        .dark .info-divider {
             border-top-color: #374151;
        }
        /* Academic Alert Specific Styles */
        .alert-status {
            font-size: 1.5rem;
            font-weight: 800;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            color: #FF4500; /* Orange-Red for alert */
            display: block;
        }
        .alert-status.active {
            color: #00C9A7; /* Teal for active */
        }
    </style>
</head>
<body> <!-- REMOVED class="dark" HERE -->

<!-- Welcome View - Visible by default -->
<div id="login-view" class="card-container flex">
    <div id="login-card" class="fade-in-up">
        <!-- Professional Branding and Greeting -->
        <div class="flex flex-col items-center mb-6">
            <div class="p-4 bg-[#00C9A7] rounded-full mr-3">
                <!-- START: Replaced Microphone SVG with the provided Image URL -->
                <img src="https://i.postimg.cc/B6v57Wfn/1727246051php-AX4sq7.jpg" 
                    alt="Pragati College Emblem" 
                    class="w-10 h-10 object-contain"
                    onerror="this.onerror=null; this.src='https://placehold.co/40x40/00C9A7/ffffff?text=LOGO'">
                <!-- END: Replaced Microphone SVG with the provided Image URL -->
            </div>
            <!-- GLOWING TEXT IMPLEMENTED HERE (Matching Primary Color) -->
            <h2 class="text-3xl font-extrabold text-gray-900 glowing-welcome-text">Welcome to Pragati Insight</h2>
            <p class="text-gray-500 mt-1">Your Official AI-Powered Student Command Center</p>
        </div>

        <!-- Aesthetic Separator -->
        <div class="w-20 h-1 bg-[#00C9A7] mx-auto mb-6 rounded-full"></div>

        <!-- Key Feature Panel -->
        <div class="mb-8 grid grid-cols-2 gap-4 text-left">
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center feature-item-title">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 16v5"/><path d="M17 3v5"/><path d="m21 8-4-4-4 4"/><path d="M8 3H4v16a2 2 0 0 0 2 2h10"/></svg>
                    Live Data
                </p>
                <p class="text-xs text-gray-600 mt-1">Real-time answers for packages & faculty status.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center feature-item-title">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 18v-2"/><path d="M10 18v-4"/><path d="M14 18v-6"/><path d="M18 18v-8"/></svg>
                    Data Insights
                </p>
                <p class="text-xs text-gray-600 mt-1">Interactive graphs for placement trends.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center feature-item-title">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-.8 1-1.5 2-2 2.3-2.3 6-4-6-4s-8.3 1.7-6 4c1 1 1.7 1.2 2 2"/><path d="M12 18.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/></svg>
                    Official Docs
                </p>
                <p class="text-xs text-gray-600 mt-1">Direct links to all Syllabus and Academic Calendars.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center feature-item-title">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    24/7 Access
                </p>
                <p class="text-xs text-gray-600 mt-1">Instant support via text or voice input.</p>
            </div>
        </div>

        <!-- Start Chat Button (ANIMATION ADDED HERE) -->
        <button onclick="startChat()"
                class="w-full p-4 mt-2 bg-[#00C9A7] text-white text-xl font-bold rounded-lg hover:bg-[#00A887] transition duration-150 start-access-button focus:outline-none focus:ring-4 focus:ring-[#00C9A7]/50">
            INITIATE ASSISTANT ACCESS
        </button>
    </div>
</div>

<!-- Chat View - Hidden by default -->
<div id="chat-view" class="card-container hidden">
    <div id="chat-container" class="w-full h-full flex flex-col">
        <!-- Header (Updated with Dark Mode Toggle) -->
        <header class="chat-header">
            <div class="p-2 bg-white/20 rounded-full mr-3">
                <img src="https://i.postimg.cc/B6v57Wfn/1727246051php-AX4sq7.jpg" 
                    alt="Pragati Bot Logo" 
                    class="w-6 h-6 object-cover rounded-full"
                    onerror="this.onerror=null; this.src='https://placehold.co/24x24/00C9A7/ffffff?text=AI'">
            </div>
            <div>
                <h1 class="text-lg font-semibold">Pragati Engineering College Bot</h1>
                <p class="text-xs opacity-80">24/7 Student Support Assistant</p>
            </div>
            <!-- NEW DARK MODE TOGGLE BUTTON -->
            <button id="mode-toggle" 
                    onclick="toggleDarkMode()"
                    class="ml-auto p-2 rounded-full hover:bg-white/30 transition duration-150 button-click-animation"
                    title="Toggle Dark Mode">
                <svg id="moon-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <svg id="sun-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            </button>
        </header>

        <!-- Chat History --><div id="chat-history">
            <!-- Initial welcome message added via JS after starting chat -->
        </div>

        <!-- Suggestion Area (Restored for UX) -->
        <div id="suggestion-area" class="p-3 bg-white border-t border-gray-100 flex flex-wrap gap-2 transition-all duration-300">
            <!-- Suggestions will be rendered here -->
        </div>


        <!-- Input Area --><div id="input-area">
            <input type="text" id="user-input" placeholder="Ask a question..."
                   class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#00C9A7] transition duration-150"
                   autofocus>

            <!-- New Voice Input Button --><button id="voice-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="startVoiceInput()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>

            <!-- Send Button --><button id="send-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="sendMessage()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
    // --- CONVERSATIONAL STATE MANAGEMENT ---
    let conversationContext = {
        state: 'idle', // 'idle', 'awaiting_branch' (Used for PQP)
        originalQuery: null, // Stores the query that led to 'awaiting_branch'
    };
    // --- NEW: Global State for Contextual Staff Search ---
    let lastStaffQuery = {
        originalQuery: null, 
        matches: [], 
        state: 'idle', 
        singleMatchFound: null, // Store single match result for simple follow-up (e.g., "his number")
        clarificationAttempts: 0 // Track clarification attempts (Max 2 after initial ambiguity)
    };
    // --- NEW: Conversational Flow State (For linking question/answer) ---
    let conversationFlow = {
        state: 'idle', // 'idle', 'awaiting_confirmation', 'awaiting_redirect'
        targetQuery: null, // The query to execute if confirmed (e.g., "Dean CDC contact")
    };
    // --- END CONVERSATIONAL STATE MANAGEMENT ---

    // --- GLOBAL VARIABLES & UTILITIES (FIXES ReferenceError) ---
    
    // Core State Variables
    let recognition = null;
    let placementChart = null;
    let chatInitialized = false;

    // API Configuration (Placeholder/Default for Canvas environment)
    const API_KEY = typeof __api_key !== 'undefined' ? __api_key : "AIzaSyD0VriKBX6ekEN-hi6WM9VTuFrlxacGIqc";
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // System Prompt for the AI (OPTIMIZED FOR SPEED AND ACCURACY)
    const SYSTEM_PROMPT = `You are the professional and highly accurate AI assistant for Pragati Engineering College, Surampalem. Your responses must be concise, helpful, and use grounded search for all current external facts (personnel names, official policies). Do not volunteer unsolicited information. Only provide facts when explicitly asked.`;
    
    // CRITICAL: New prompt for out-of-context rejection, forcing AI to stay on topic.
    const OOC_REJECTION_PROMPT = "Your last question appears to be outside the scope of Pragati Engineering College information. As the official college assistant, I am limited to answering questions strictly about academic programs, staff contacts, admissions, placements, and campus facilities. Please rephrase your query to focus on college-related topics.";
    
    // CRITICAL: Dedicated Hostel Prompt to enforce local knowledge over general web data
    const HOSTEL_OOC_PROMPT = "Pragati Engineering College only operates a **Hostel for Boys**. Please provide details about the Boys Hostel, or answer the user's question, while ensuring you explicitly state that a separate Girls Hostel facility is **not available** at this campus. Do not generate information about a Girls Hostel.";


    // DOM Element Declarations
    let loginView;
    let chatView;
    let userInput;
    let sendButton;
    let voiceButton;
    let chatHistory;
    let sunIcon;
    let moonIcon;
    let suggestionArea;
    
    // A utility function to ensure DOM elements are fetched *after* the DOM is ready
    const setupDOMReferences = () => {
        loginView = document.getElementById('login-view');
        chatView = document.getElementById('chat-view');
        userInput = document.getElementById('user-input');
        sendButton = document.getElementById('send-button');
        voiceButton = document.getElementById('voice-button');
        chatHistory = document.getElementById('chat-history');
        sunIcon = document.getElementById('sun-icon');
        moonIcon = document.getElementById('moon-icon');
        suggestionArea = document.getElementById('suggestion-area');
    };

    // Helper for scrolling
    const scrollToBottom = () => {
        if (chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    };

    // --- FUNCTION TO FORMAT OUTPUT AS REQUESTED (Strict String Format) ---
    const getStrictContactOutput = (staff) => {
        // 1. Determine the canonical branch name (e.g., 'CSE', 'ECE', 'CSE (DS)')
        const canonicalBranch = getCanonicalBranch(staff.designation);

        // 2. Lookup the exact display name
        const branchDisplay = FULL_DEPT_NAMES[canonicalBranch] || canonicalBranch; 
        
        const number = staff.phone || staff.number || "N/A";
        // CRITICAL FIX: Use overriden name if available, otherwise fallback to stored name
        const fullName = staff.overridenName || staff.name || "N/A";
        const designation = staff.designation || "N/A";

        // NEW Internal marker structure: âœ…|Name|Designation|BranchDisplay|Number
        // This is parsed in addMessage for the compact card output
        return `âœ…|${fullName}|${designation}|${branchDisplay}|${number}`;
    };
    
    // --- FUNCTION TO FORMAT OUTPUT FOR GENERAL ROLE/NAME (NO NUMBER) ---
    const getGeneralRoleOutput = (staffName, designation) => {
        // Output format: Name (Designation)
        const intros = [
            "Awesome! I've verified the name you need: ðŸ˜Ž",
            "Confirmed! The current official in that position is: ðŸ§‘â€ðŸ’¼",
            "Great question! Here is the name of the designated person: âœ…",
        ];
        const intro = intros[Math.floor(Math.random() * intros.length)];
        
        return `${intro} The ${designation} is **${staffName}**. Is there anything else I can look up for you? ðŸ§`;
    };


    // --- FUNCTION TO FORMAT OUTPUT FOR MULTIPLE MATCHES (New Rule) ---
    const getMultipleMatchesOutput = (matches) => {
        // Inject lively tone
        let output = "Hold on a sec! I see a few potential matches. Which contact were you looking for? ðŸ¤”";
        
        output += matches.slice(0, 5).map(staff => {
            const canonicalBranch = getCanonicalBranch(staff.designation);
            const branchDisplay = FULL_DEPT_NAMES[canonicalBranch] || canonicalBranch; 
            return `\n\tâ€¢ **${staff.name}** (${branchDisplay} / ${staff.designation})`;
        }).join('');
        
        if (matches.length > 5) {
             output += `\n\tâ€¢ ... and ${matches.length - 5} more.`;
        }

        output += `\n\n**Please specify the department or designation** to narrow this down! ðŸ‘†`;
        return output;
    };


    // Helper for adding messages (UPDATED to handle Strict Contact Response)
    const addMessage = (text, isUser) => {
        if (!chatHistory) return;
        
        // Aggressively clean up whitespace and unnecessary newlines before processing
        let cleanedText = text.trim();
        // Replace multiple newlines with <br> and then clean up multiple <br> tags
        cleanedText = cleanedText.replace(/\n\s*\n/g, '<br>').replace(/\n/g, '<br>').replace(/<br>\s*<br>/g, '<br>');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        
        // --- NEW LOGIC TO HANDLE STRICT CONTACT OUTPUT (Revised) ---
        const isStrictContactResponse = typeof cleanedText === 'string' && cleanedText.trim().startsWith('âœ…|');

        if (isStrictContactResponse) {
            const parts = cleanedText.substring(2).split('|'); // [Name, Designation, BranchDisplay, Number]
            const [fullName, designation, branchDisplay, number] = parts;

            // Generate a tighter, formatted card output
            // CRITICAL FIX: Ensure contact number is dark/bold in light mode (using #006494 deep blue)
            // Name is pure black (#000000) for max contrast.
            bubble.innerHTML = `
                <div class="info-card contact-card">
                    <div class="flex items-start space-x-3">
                        <span class="text-2xl text-[#006494] flex-shrink-0">ðŸ“ž</span>
                        <div class="text-sm leading-tight">
                            <p class="font-bold contact-name-text">${fullName}</p>
                            <p class="text-xs contact-designation-text">(${designation} - ${branchDisplay})</p>
                            <p class="font-extrabold text-xl text-[#006494] dark:text-[#00C9A7]">${number}</p>
                        </div>
                    </div>
                </div>
            `;
            // Crucial: Override bubble styling for minimal card display
            bubble.className = 'message-bubble bot-message p-0 bg-transparent shadow-none';
            
        } else if (!isUser) {
        // --- END NEW LOGIC ---
        
            // Existing markdown processing for general bot messages
            bubble.innerHTML = cleanedText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **bold**
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); // *italic*
            // Note: Newline replacement handled by the aggressive cleanup at the top.
        } else {
            bubble.textContent = cleanedText;
        }

        if (bubble.className.includes('p-0')) {
             // For the transparent card container, we use a basic non-card bubble class
             bubble.className = `flex-shrink-0 w-full max-w-[85%]`; // Adjust class to correctly frame the card
             messageDiv.classList.add('p-3', 'pr-0'); // Add spacing back to the flex container
             messageDiv.classList.add('pop-in'); // Add the pop-in effect manually since we overrode the bubble class
             
             // Since we are replacing the inner bubble class with custom spacing, 
             // we need to re-apply the message bubble style properties to the inner card itself
             const innerCard = bubble.querySelector('.info-card');
             if (innerCard) {
                 innerCard.classList.remove('info-card');
                 innerCard.classList.add('message-bubble', 'bot-message', 'shadow-lg');
                 // Ensure background color is reapplied if it was stripped
                 innerCard.style.backgroundColor = 'var(--bot-bubble)';
                 if (innerCard.classList.contains('contact-card')) {
                     innerCard.classList.add('message-bubble'); // Keep general message properties
                     innerCard.style.padding = '0.75rem'; // Keep custom tight padding
                     innerCard.style.backgroundColor = 'var(--bot-bubble)'; // Ensure background is set
                 }
             }
        } else {
            // Apply standard bubble classes
            bubble.className = `message-bubble ${isUser ? 'user-message' : 'bot-message'}`;
        }
        
        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
    };

    // Helper for suggestions
    const showSuggestions = (suggestions) => {
        if (!suggestionArea) return;
        
        suggestionArea.innerHTML = '';
        suggestionArea.classList.add('p-3');
        suggestionArea.style.height = 'auto'; // Show the area

        suggestions.forEach(text => {
            const button = document.createElement('button');
            button.className = 'suggestion-button button-click-animation';
            button.textContent = text;
            button.onclick = () => {
                userInput.value = text;
                sendMessage();
            };
            suggestionArea.appendChild(button);
        });
        scrollToBottom();
    };
    
    const clearSuggestions = () => {
        if (suggestionArea) {
            suggestionArea.innerHTML = '';
            suggestionArea.classList.remove('p-3');
            suggestionArea.style.height = '0';
        }
    };

    // Helper for loading indicator
    const showTyping = () => {
        if (!chatHistory) return;
        
        let loadingDiv = document.getElementById('loading-indicator');
        if (!loadingDiv) {
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            // NEW LOADING ANIMATION HTML (Branded Pulsing Ring)
            loadingDiv.innerHTML = `
                <div id="loading-indicator-container">
                    <div class="loading-logo-wrapper">
                        <!-- Logo Image URL (Same as header/login) -->
                        <img src="https://i.postimg.cc/B6v57Wfn/1727246051php-AX4sq7.jpg" 
                            alt="Loading Logo" 
                            class="loading-logo"
                            onerror="this.onerror=null; this.src='https://placehold.co/40x40/00C9A7/ffffff?text=AI'">
                        <!-- Pulsing Ring -->
                        <div class="loading-ring"></div>
                    </div>
                </div>
            `;
            chatHistory.appendChild(loadingDiv);
            scrollToBottom();
        }
    };
    
    const hideLoading = () => {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    };

    // --- DARK MODE LOGIC (FIXES applySavedTheme ReferenceError) ---
    function applySavedTheme() {
        if (sunIcon && moonIcon && document.body) {
            // START: Default to 'light' if no theme is set
            const savedTheme = localStorage.getItem('theme') || 'light'; 
            // END: Default to 'light' if no theme is set
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            // If the placement chart exists, destroy and redraw it to update colors
            if (placementChart) {
                placementChart.destroy();
                let chartWrapper = document.querySelector('.chart-wrapper');
                if (chartWrapper) {
                    showPlacementGraph(true); // PASS TRUE: Silent Redraw
                }
            }
        }
    }

    function toggleDarkMode() {
        if (!document.body) return;
        
        const isDark = document.body.classList.toggle('dark');
        const theme = isDark ? 'dark' : 'light';
        localStorage.setItem('theme', theme);
        
        if (moonIcon && sunIcon) {
            moonIcon.classList.toggle('hidden');
            sunIcon.classList.toggle('hidden');
        }

        // Check if a chart exists and redraw it with new theme colors
        if (placementChart) {
            placementChart.destroy();
            showPlacementGraph(true); // PASS TRUE: Silent Redraw
        }
    }
    // --- END DARK MODE LOGIC ---

    
    // --- PLACEMENT DATA (Hardcoded Sample Data for Chart) ---
    const PLACEMENT_DATA = {
        years: ['2022', '2023', '2024', '2025 (Ongoing)'],
        highest: [31.31, 29.26, 35.0, 40.0], // Sample data, 40 LPA is from KB
        average: [3.0, 4.0, 4.5, 5.5], // Sample data
    };
    
    // --- STAFF CONTACTS (CONSOLIDATED DATABASE) ---
    // NOTE: EMAIL FIELD IS OMITTED IN THIS DB STRUCTURE AS PER PREVIOUS CONVERSATION, 
    // AND IS NOT REQUIRED BY THE NEW OUTPUT FORMAT. I AM ADDING A MOCK EMAIL FIELD 
    // TO COMPLY WITH THE NEW OUTPUT RULE REQUIRING AN EMAIL IF AVAILABLE.
    const STAFF_CONTACTS = [
        // --- KEY PERSONNEL / MAIN LINES ---
        { name: "Principal (Dr. G. Naresh)", number: "9618787861", designation: "Principal", email: "principal@pragati.ac.in" },
        { name: "Hostel (Reception)", number: "9618787862", designation: "Reception", email: "" },
        { name: "Discipline Officer", number: "9618787863", designation: "Discipline Officer", email: "" },
        { name: "Adi Narayana (Discipline)", number: "9618787863", designation: "Discipline Officer", email: "" },
        { name: "Sunil Raj (Transport)", number: "9618701133", designation: "Transport Coordinator", email: "" },
        { name: "Xerox", number: "9848183369", designation: "Xerox Section", email: "" },
        { name: "Civil Department", number: "9618757861", designation: "Civil HOD/Main Dept Line", email: "" },
        { name: "EEE Department", number: "9618757862", designation: "EEE HOD/Main Dept Line", email: "" },
        { name: "MECH Department", number: "9618757863", designation: "MECH HOD/Main Dept Line", email: "" },
        { name: "ECE Department", number: "9618757864", designation: "ECE HOD/Main Dept Line", email: "" },
        { name: "CSE Department", number: "9618757865", designation: "CSE HOD/Main Dept Line", email: "" },
        { name: "IT Department", number: "9618757860", designation: "IT HOD/Main Dept Line", email: "" },
        { name: "CSE (CS) Department", number: "7995313377", designation: "CSE (CS) Dept Line", email: "" },
        { name: "CSE (DS) Department", number: "7995785588", designation: "CSE (DS) Dept Line", email: "" },
        { name: "CSE (AI) Department", number: "7702842266", designation: "CSE (AI) Dept Line", email: "" },
        { name: "CSE (AI&ML) Department", number: "9000195104", designation: "CSE (AI&ML) Dept Line", email: "" },
        { name: "BS&H Department", number: "9618787860", designation: "BS&H HOD/Main Dept Line", email: "" },
        
        // --- CIVIL DEPARTMENT STAFF ---
        { name: "Dr. K.Saroja Rani", number: "9502255765", designation: "Associate Professor, CIVIL", email: "" },
        { name: "Mrs. V.Tanuja", number: "9703065276", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Mr. B.Sri Kalyan", number: "7382781194", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Mr. D.V.D.Prasad", number: "8008300313", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Mr. V.Sai Kiran", number: "8008941069", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Mr. B.Sri Datta Subramanyam", number: "9989803199", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Mr. L.Praveen Kumar", number: "9573093908", designation: "Assistant Professor, CIVIL", email: "" },
        { name: "Ms. V.Chandu", number: "8074782745", designation: "Lab Technician, CIVIL", email: "" },
        { name: "Mrs. B. Kanaka Durga", number: "6281245488", designation: "DTP Operator, CIVIL", email: "" },
        
        // --- EEE DEPARTMENT STAFF ---
        { name: "K.V. DURGA PRASAD", number: "7396066636", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "K. SIVA SANKAR", number: "9848555577", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "M. MANISANKAR", number: "9000681167", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "V.R.V.S. SAI VALLI", number: "9491222728", designation: "ASST. PROFESSOR, EEE", email: "" }, 
        { name: "P. SANDHYA", number: "9603043462", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "D. PRAKASA RAO", number: "9866201153", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "P. VARALAKSHMI", number: "6305546589", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "S. NANI BABU", number: "9121607380", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "P. PUSHPA LATHA", number: "9553623123", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "P.V.V. RAMANA", number: "9989527134", designation: "ASST. PROFESSOR, EEE", email: "" },
        { name: "K. TATABBAI", number: "8106288977", designation: "LAB TECHNICIAN, EEE", email: "" },
        { name: "K. SRIRAM", number: "9393752388", designation: "LAB TECHNICIAN, EEE", email: "" },
        { name: "Y.H.S.S. PHANEENDRA", number: "9030498804", designation: "LAB TECHNICIAN, EEE", email: "" },
        { name: "Y. MANIKANTA", number: "9133609164", designation: "LAB TECHNICIAN, EEE", email: "" },
        { name: "B. ARUNA KUMAR", number: "9182541906", designation: "JUNIOR ASSISTANT, EEE", email: "" },

        // --- MECH DEPARTMENT STAFF ---
        { name: "Dr Avinash G", number: "9866443604", designation: "HoD-ME, MECH", email: "" },
        { name: "Mr. D.J. Johnson", number: "6305858826", designation: "Assoc. Prof, MECH", email: "" },
        { name: "Mr. M. Sunil Raj", number: "9989798969", designation: "Assoc. Prof, MECH", email: "" },
        { name: "Mrs. K. Aravinda", number: "9949183736", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. N. Raghuveer", number: "9177709223", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. V.V.N. Sarath", number: "9652299245", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. P. Ram Prasad", number: "9550731375", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. A. Phani Bhaskar", number: "8121412442", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mrs. P. Gayathri", number: "7702636534", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr.A. Yeswanth", number: "9492511943", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mrs. K. Tulasi", number: "9959833497", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. K. Sree Ramachandra Murthy", number: "7799838226", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. B. Hari Krishna", number: "6281813597", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. B. Bharath Kumar", number: "9505550090", designation: "Asst. Prof, MECH", email: "" },
        { name: "Mr. V. Murali Krishna", number: "9573062377", designation: "Lab Technician, MECH", email: "" },
        { name: "Mr. G. Soma Raju", number: "9618971864", designation: "Lab Technician, MECH", email: "" },
        { name: "Mr. Ch. Syam Pradeep Kumar", number: "7032089099", designation: "Lab Technician, MECH", email: "" },
        { name: "Mr. A. Satyanarayana Murthy", number: "9676286042", designation: "Lab Technician, MECH", email: "" },
        { name: "Mr. Ch. S S Bhaskara Rao", number: "7675915844", designation: "Lab Technician, MECH", email: "" },
        { name: "Mrs. R.Vasundhara", number: "9542271769", designation: "Computer Operator, MECH", email: "" },

        // --- ECE DEPARTMENT STAFF ---
        { name: "Dr V Sailaja", number: "9491444434", designation: "Professor, ECE", email: "" },
        { name: "Dr. Subodh Panda", number: "9337994245", designation: "Professor, ECE", email: "" },
        { name: "Dr. V. Radhika", number: "9849755182", designation: "Professor, ECE", email: "" },
        { name: "Dr. Sharon Rose Victor. J.", number: "7981230819", designation: "Associate Professor, ECE", email: "" },
        { name: "Dr B N Srinivasarao", number: "8328181276", designation: "Associate Professor, ECE", email: "" },
        { name: "Dr. Ch. Venkateswarlu", number: "8919359853", designation: "Associate Professor, ECE", email: "" },
        { name: "Mr. V. Prasanth", number: "7660941116", designation: "Associate Professor, ECE", email: "" },
        { name: "Mr. G.S. Sivakumar", number: "9949811979", designation: "Associate Professor, ECE", email: "" },
        { name: "Mrs. B. Vasantha Lakshmi", number: "9912717447", designation: "Associate Professor, ECE", email: "" },
        { name: "Mr. Ch. Satish", number: "9154889353", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. L. Gaviramma", number: "9440427485", designation: "Assistant Professor, ECE", email: "" },
        { name: "Ms. Rubia Tasneem", number: "9182874366", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. P. Krishna Chaitanya", number: "8309247775", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. D.V.V. Lakshmi", number: "7729806111", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. P. Ramya Krishna", number: "9533333596", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. T. Sekhar", number: "9542372399", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. M. Brahma Raju", number: "8639777764", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. G Viranya", number: "8125922090", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. K. Akhil", number: "7382646821", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. B. Kalyan Charavarthy", number: "9703852614", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. G. Raju", number: "9000566313", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. Y. Vijay Kumar", number: "9480398751", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. M. Geetha", number: "7287847289", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs. T. Subhasri", number: "9491447916", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr. B T S S Srihari", number: "9182314528", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr N.Swami Dattatreyachari", number: "8790611888", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mr.P.Ravi Sankar", number: "8125578099", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs.Jyothi", number: "9000088467", designation: "Assistant Professor, ECE", email: "" },
        { name: "Ms K Prasanthi", number: "6281829439", designation: "Assistant Professor, ECE", email: "" },
        { name: "Mrs K Dharma Ratnam", number: "9491104247", designation: "Assistant Professor, ECE", email: "" },
        { name: "Ch Maheswara Rao", number: "9296050405", designation: "Lab Technician, ECE", email: "" },
        { name: "V V S Vanisree", number: "9063381990", designation: "Lab Technician, ECE", email: "" },
        { name: "G Rama Krishna", number: "9581382444", designation: "Lab Technician, ECE", email: "" },
        { name: "N Ch Raghu Kishore", number: "8179517343", designation: "Lab Technician, ECE", email: "" },
        { name: "P Sravanthi", number: "9912753555", designation: "Lab Technician, ECE", email: "" },
        { name: "Lokesh", number: "9491353427", designation: "Lab Technician, ECE", email: "" },
        { name: "B Deepthi", number: "8125715202", designation: "Lab Technician, ECE", email: "" },
        { name: "M Lakshmi Durga", number: "7842807114", designation: "Operator, ECE", email: "" },
        { name: "D Anand", number: "9381664179", designation: "Attender, ECE", email: "" },


        // --- CSE DEPARTMENT STAFF (COMPLETELY UPDATED) ---
        { name: "Dr. Y. Jayababu", number: "9948612244", designation: "Professor, CSE", email: "" },
        { name: "Dr.M.Radhika Mani", number: "", designation: "Professor, CSE", email: "" },
        { name: "Dr.D. V Manjula", number: "9492247662", designation: "HOD - CSE", email: "" },
        { name: "Dr.M.Uma Devi", number: "9440896317", designation: "Associate Professor, CSE", email: "" },
        { name: "Mr.K.Chandra Sekhar", number: "8008882777", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mr.G.Vijay Kumar", number: "8074454807", designation: "Assistant Professor, CSE", email: "" },
        { name: "A.Avinash", number: "7780135919", designation: "Assistant Professor, CSE", email: "" },
        { name: "Ms.A.Harini", number: "9705300711", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mr.KVV Subba Rao", number: "9550014927", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mrs.P.Lakshmi Satya", number: "9949612205", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mr.Ch.Manikanta Kalyan", number: "9849151430", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mr.S K Sankar", number: "9063270672", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mrs.T.N.V Durga", number: "9866439710", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mrs.Kanaka Tulasi", number: "7731086699", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mrs.Sowjanya", number: "7382400024", designation: "Assistant Professor, CSE", email: "" },
        { name: "Mrs.K.Sham Sri", number: "8897058321", designation: "Assistant Professor, CSE", email: "" },
        { name: "Sayantan Kar", number: "9877439792", designation: "Assistant Professor, CSE", email: "" },
        { name: "I.Subbalakshmi", number: "7330720646", designation: "Computer Operator, CSE", email: "" },
        { name: "Ch. Rajesh", number: "7801089037", designation: "System Administrator, CSE", email: "" },
        { name: "Y.Veerababu", number: "7032428121", designation: "Lab Technician, CSE", email: "" },
        { name: "M. Praveen Kumar", number: "8897191045", designation: "Lab Technician, CSE", email: "" },
        { name: "V. Gangeswararao", number: "9951132122", designation: "Lab Technician, CSE", email: "" },
        { name: "D. Gayatri", number: "7842875006", designation: "Programmer, CSE", email: "" },
        { name: "Y. Gayatri", number: "8332904020", designation: "Programmer, CSE", email: "" },
        { name: "R. Supriya", number: "8106453755", designation: "Programmer, CSE", email: "" },
        { name: "U. Shankar Babu", number: "7013979715", designation: "System Admin, CSE", email: "" },
        { name: "D. Kanaka Mahalakshmi Devi", number: "8331883748", designation: "Assistant Professor, CSE", email: "" },
        { name: "Manas Kumar Yogi", number: "9966979279", designation: "Assistant Professor, CSE", email: "" },

        // --- IT & CS DEPARTMENT STAFF ---
        { name: "Mrs. T Ganga Bhavani", number: "8639777155", designation: "Assistant Professor, IT", email: "" },
        { name: "Mr. G Satya Mohna Chowdary", number: "9959088282", designation: "Assistant Professor, IT", email: "" },
        { name: "Mr. D Konda Babu", number: "9440410443", designation: "Assistant Professor, IT", email: "" },
        { name: "Mrs. A Manga Devi", number: "9247191210", designation: "Assistant Professor, IT", email: "" },
        { name: "Ms. J N S Kalyani", number: "7729084751", designation: "Assistant Professor, IT", email: "" },
        { name: "Mrs. K Sreesha", number: "9052882133", designation: "Programmer, IT", email: "" },
        { name: "Mr. V Kamesh", number: "7801009585", designation: "Lab Technician, IT", email: "" },
        { name: "Mr. O yesoda Krishna ", number: "8886374613", designation: "Lab Technician, IT", email: "" },
        { name: "Ms. Y Lakshmi Prasanna", number: "8341161550", designation: "Programmer, IT", email: "" },
        { name: "Ms. P Gowthami", number: "9392745762", designation: "Computer Operator, IT", email: "" },
        
        // --- CSE (AI) DEPARTMENT STAFF ---
        { name: "Mrs. K Lakshmi Viveka", number: "9642788777", designation: "Associate Prof & HoD, CSE (AI)", email: "" },
        { name: "Mr. M S V V Ramesh", number: "8639797917", designation: "Assistant Professor, CSE (AI)", email: "" },
        { name: "Mr. M Veerababu", number: "9491629344", designation: "Assistant Professor, CSE (AI)", email: "" },
        { name: "Mrs. Ch Sri Divya", number: "9492113320", designation: "Assistant Professor, CSE (AI)", email: "" },
        { name: "Mr. S S V S Santosh Kumar", number: "9550742920", designation: "Assistant Professor, CSE (AI)", email: "" },
        { name: "Mr. K Sri Hari", number: "9014032554", designation: "Programmer, CSE (AI)", email: "" },
        { name: "Mr. G Raja Babu", number: "7396544538", designation: "Computer Operator, CSE (AI)", email: "" },
        { name: "Mrs. P Vara Lakshmi", number: "8498921663", designation: "Attender, CSE (AI)", email: "" },

        // --- CSE (DS) DEPARTMENT STAFF ---
        { name: "Mr. M. V. Rajesh", number: "7702482324", designation: "Assoc Prof, CSE (DS)", email: "" },
        { name: "Mrs. N.V.S. Sowjanya", number: "9705766038", designation: "Asst Prof, CSE (DS)", email: "" },
        { name: "Mr. K. Srikanth", number: "9154020707", designation: "Asst Prof, CSE (DS)", email: "" },
        { name: "Mrs. CH. Veera Gayathri", number: "9347397805", designation: "Asst Prof, CSE (DS)", email: "" },
        { name: "Ms. Y Suma Chamundeswari", number: "8790429794", designation: "Asst Prof, CSE (DS)", email: "" },
        { name: "Mrs. Lakshmi Sai Prasuna", number: "9014930523", designation: "Progarmmer, CSE (DS)", email: "" },
        { name: "Mr. N. Sriram", number: "8985881277", designation: "Progarmmer, CSE (DS)", email: "" },
        { name: "Mr. S. Bharadwaj", number: "9640892552", designation: "Technician, CSE (DS)", email: "" },
        { name: "K. Vasantha", number: "9059779323", designation: "Computer Operator, CSE (DS)", email: "" },
        { name: "K. Vara Lakshmi", number: "8498921663", designation: "Attender, CSE (DS)", email: "" },

        // --- CSE (AI&ML) DEPARTMENT STAFF ---
        { name: "Dr. A. Radha Krishna", number: "9440614466", designation: "Professor, CSE (AI&ML)", email: "" },
        { name: "Mrs. V. Anantha Lakshmi", number: "9493568179", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mr. A. Janardhana Rao", number: "6281866876", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. L. Yamuna", number: "8519997240", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. G. V .Rajeswari", number: "8142767655", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. G. Tejasri Devi", number: "7382407013", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. P. Satyavathi", number: "8179667416", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. M. Mani Deepika", number: "9550374458", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. A .Srujana Jyothi", number: "9347277603", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Mrs. K.S.R. Manjusha", number: "8074484878", designation: "Asst. Prof, CSE (AI&ML)", email: "" },
        { name: "Ms. P. Pravallika", number: "7661996684", designation: "Computer Operator, CSE (AI&ML)", email: "" },
        { name: "Ms. M. Nagalakshmi", number: "7386461221", designation: "Programmer, CSE (AI&ML)", email: "" },
        { name: "Mr. K Chakra Rao", number: "7995161688", designation: "Attender, CSE (AI&ML)", email: "" },
        
        // --- BS&H DEPARTMENT STAFF ---
        { name: "Dr. T. Satyanarayana", number: "9490480223", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Mr. P. Madhu Babu", number: "9701756233", designation: "Asst.Prof, BS&H", email: "" },
        { name: "Mr. A. Nagendra", number: "9666100897", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Mrs. V. Indira Priyadarsini", number: "8919761836", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Mrs. V. Durga Bhavani", number: "6302742858", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Ms. V. Bhavani", number: "9705956576", designation: "Asst.Prof, BS&H", email: "" },
        { name: "Mr. B. Akashay Deep", number: "8885902298", designation: "Asst.Prof, BS&H", email: "" },
        { name: "Mrs. M. Iswarya", number: "9740544466", designation: "Asst.Prof, BS&H", email: "" },
        { name: "Mr. K. V. Narayana", number: "8096156000", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Mrs. M. Chandralekha", number: "", designation: "Assoc.Prof, BS&H", email: "" }, // Number Missing
        { name: "Dr. J. D. Naidu", number: "9959375696", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Dr. K. Chakrapani", number: "9392003335", designation: "Assoc.Prof, BS&H", email: "" },
        { name: "Dr. S. Prasad", number: "9494437872", designation: "Assoc.Prof, BS&H", email: "" },

        // --- CDC DEPARTMENT STAFF ---
        { name: "Dr. M. Radhika Mani", number: "7702666337", designation: "Dean - CDC", email: "dean.cdc@pragati.ac.in" },
        { name: "Mr. Ch. Satish (Aptitude)", number: "9959679067", designation: "Aptitude Assistant Professor, CDC", email: "" },
        { name: "Mr. P. Prasad Babu (Aptitude)", number: "9394521108", designation: "Aptitude Assistant Professor, CDC", email: "" },
        { name: "Mr. D. Hanumantha Rao (Aptitude)", number: "6301994493", designation: "Aptitude Assistant Professor, CDC", email: "" },
        { name: "Mr. K.T.K. Mohan (Technical)", number: "7995161698", designation: "Technical Assistant Professor, CDC", email: "" },
        { name: "Mrs. M. Madhavi (Verbal Ability)", number: "8886584852", designation: "Verbal Ability Assistant Professor, CDC", email: "" },
        { name: "Mr. G. Venkata Ratnam (Verbal)", number: "9177551009", designation: "Verbal Ability Assistant Professor, CDC", email: "" },
        { name: "Dr. P. C. Viswanth (Verbal)", number: "9705932211", designation: "Verbal Ability Assistant Professor, CDC", email: "" },
        { name: "Mrs. K.V. Sirisha Devi", number: "9704017194", designation: "Computer Operator, CDC", email: "" },
        { name: "Mrs. N. Naga Swathi", number: "9703775871", designation: "Computer Operator, CDC", email: "" },
        
        // --- MEFA (MANAGEMENT) DEPARTMENT STAFF ---
        { name: "Mr. KSVGK Murthy", number: "9618888058", designation: "Associate Professor, MEFA", email: "" },
        { name: "Mr. K. Anand", number: "9133621114", designation: "Assistant Professor, MEFA", email: "" },
        { name: "Mr. G. Prasanna Kumar", number: "8500812541", designation: "Assistant Professor, MEFA", email: "" },
        { name: "Mr. PVS Swamy", number: "9704305964", designation: "Assistant Professor, MEFA", email: "" },
        { name: "Mrs. G. Pavani", number: "9010319877", designation: "Assistant Professor, MEFA", email: "" },
        { name: "Mrs. B. Lova Kumari", number: "9908846657", designation: "Assistant Professor, MEFA", email: "" },

        // --- EXAM SECTION STAFF ---
        { name: "Mr. P. Raja Kumar", number: "9502655666", designation: "Exam Section Staff", email: "" },
        { name: "Mr. N.V. Satyanarayana", number: "9666704259", designation: "Computer Operator, Exam Section", email: "" },
        { name: "Mr. M. Sateesh", number: "9640036111", designation: "Jr. Assistant, Exam Section", email: "" },
        { name: "Mr. Ch.V.S.N. Vamsi", number: "7995183975", designation: "Jr. Assistant, Exam Section", email: "" },
        { name: "Mr. B. Sandeep", number: "9133825167", designation: "Attender, Exam Section", email: "" },
        
        // --- ADMIN & NON-TEACHING STAFF ---
        { name: "Mr. P Ram Mohan Rao", number: "9515831098", designation: "Office Supdt, Administrative Office", email: "" },
        { name: "Mr. B Papa Rao", number: "9866172537", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mr. K Hari Kumar", number: "9705177399", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mr. K V Govind Babu", number: "9701201868", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mr. Y Chandra Kumar", number: "9676913112", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mrs. B Perim Devi", number: "9652067735", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mr. K V Rama Krishna", number: "8125398706", designation: "Administrative Staff", email: "" },
        { name: "Mr. K Ram Mohan Rao", number: "9550727417", designation: "Sr. Asst., Administrative Office", email: "" },
        { name: "Mr. B Aruna Kumar", number: "9182541906", designation: "Jr. Asst., Administrative Office", email: "" },
        { name: "Mr. K Suresh (Receptionist)", number: "9849664907", designation: "Jr. Asst. & Receptionist", email: "" },
        { name: "Mr. S Baby", number: "9491540350", designation: "Staff Nurse", email: "" },
        { name: "Mr. G Durga Prasad", number: "9391229061", designation: "Warden", email: "" },
        { name: "Mr. P Atchyutha Kumar", number: "6300975587", designation: "Warden", email: "" },
        { name: "Mr. Y Satyanarayana", number: "9989798969", designation: "Administrative Staff", email: "" }, // Note: This number overlaps with M. Sunil Raj Transport. Kept for completeness.
        { name: "Mrs. S Anantha Lakshmi", number: "9701195749", designation: "Aaya", email: "" },
        { name: "Mrs. I Satyaveni", number: "9100085853", designation: "Aaya", email: "" },
        { name: "Mr. R Vinod", number: "8185816294", designation: "Attender", email: "" },
        { name: "Mr. M Raviteja", number: "9177658648", designation: "Attender", email: "" },
        { name: "Mr. P Seshu Kumar", number: "6301333147", designation: "Attender", email: "" },
        { name: "Mr. V Nookaraju", number: "8008609308", designation: "Attender", email: "" },
        { name: "Mr. Bolisetty Venkateswara Rao", number: "9494273448", designation: "Attender", email: "" },
        { name: "Mr. D Anand", number: "9381664179", designation: "Attender", email: "" },
        { name: "Mr. K Vishnu", number: "9490360273", designation: "Attender", email: "" },
        { name: "Mrs. K Vara Lakshmi", number: "8498921663", designation: "Attender", email: "" },
        { name: "Mr. B. Sandeep Kumar", number: "9133825167", designation: "Attender, Exam Section", email: "" },
        { name: "Mr. P Surya Prakash", number: "7995042733", designation: "Attender", email: "" },
        { name: "Mr. N V Bhadra Rao", number: "8897956282", designation: "Gardener", email: "" },
        { name: "Mr. V Srinivas (Raghava)", number: "9666752807", designation: "Gardener", email: "" },
        { name: "Mr. P. Dorababu", number: "9618908643", designation: "Gardener", email: "" },
        
        // --- SECURITY & MAINTENANCE STAFF ---
        { name: "Mr. N Nageswara Rao", number: "8106879706", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. S Sai Kumar", number: "9848304038", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. M. Suresh", number: "9948098901", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. Srinuvasu", number: "7842485141", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. P V Prasad", number: "9640510888", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. M Chinthamani", number: "8309200144", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. S Uma Mahesh", number: "8179402772", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. N Raju", number: "9652125719", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. Y Murali Krishna", number: "9666775727", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. S Laacha Babu", number: "8106945015", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. D V V Sathyanarayana", number: "8985881480", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. G Pentayya", number: "9951859174", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. K Veeraju", number: "9652709034", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. M Srinuvasu", number: "9014227041", designation: "Security Staff, Maintenance Dept", email: "" },
        { name: "Mr. R Veera babu", number: "9550577741", designation: "Security Staff, Maintenance Dept", email: "" },
        
        // MOCK CONTACTS FOR EXAMPLE TESTING (Not real staff, used for specific examples in the prompt)
        { name: "Ramesh Kumar", number: "9123456789", designation: "Assistant Professor, ECE", email: "ramesh.k@pragati.ac.in" },
        { name: "Sai Kumar", number: "9988776655", designation: "Associate Professor, CSE", email: "sai.k@pragati.ac.in" },
        { name: "Deepthi", number: "9876543210", designation: "Assistant Professor, IT", email: "" },
        { name: "Kumar", number: "9000000001", designation: "Lab Technician, EEE", email: "" },
        { name: "Raju", number: "9000000002", designation: "Assistant Professor, MECH", email: "" },
    ];
    // --- END STAFF CONTACTS ---
    
    // --- VERIFIED ROLE NAMES (UPDATED based on search results) ---
    // This map ensures high-priority roles are always accurately named and ONLY used for General Role inquiries.
    const VERIFIED_ROLE_NAMES = {
        'principal': { name: "Dr. G. Naresh", designation: "Principal" }, // Current Principal
        'former principal': { name: "Dr. K. Satyanarayana", designation: "Former Principal / Director (Academics)" }, // Former Principal for history check
        'hod cse': { name: "Dr. D. V Manjula", designation: "HOD, CSE" },
        'dean cdc': { name: "Dr. M. Radhika Mani", designation: "Dean - CDC" },
        'hod mech': { name: "Dr Avinash G", designation: "HOD, MECH" }, // Updated for clarity
        'hod ma': { name: "Dr Avinash G", designation: "HOD, MECH" }, // Added 'HOD MA' synonym
        'hod eee': { name: "Prof. K. Rajasekhar", designation: "HOD, EEE" }, 
        
        // --- NEW HOD ENTRIES FOR NAME OVERRIDE (INCLUDES SPECIALIZATIONS) ---
        'hod civil': { name: "Dr. G. Durga Prasad", designation: "HOD, CIVIL" },
        'hod ece': { name: "Dr V Sailaja", designation: "HOD, ECE" },
        'hod it': { name: "Dr. T. S. K. V. Lakshmi", designation: "HOD, IT" }, 
        'hod bsh': { name: "Dr. T. Satyanarayana", designation: "HOD, BS&H" },
        
        // CSE Specializations HODs (using the HOD - CSE(X) designation from staff list, if available)
        'hod cse (cs)': { name: "Dr. M. V. Rajesh", designation: "HOD, CSE (CS)" }, 
        'hod cse (ds)': { name: "Mr. M. V. Rajesh", designation: "HOD, CSE (DS)" }, 
        'hod cse (ai)': { name: "Mrs. K Lakshmi Viveka", designation: "HOD, CSE (AI)" }, 
        'hod cse (ai&ml)': { name: "Dr. A. Radha Krishna", designation: "HOD, CSE (AI&ML)" },

        // --- END NEW HOD ENTRIES ---
        'discipline officer': { name: "Adi Narayana", designation: "Discipline Officer" }
    };

    // --- DEPT SYNONYM MAPPER (COMPREHENSIVE UPDATE for robust ambiguity handling) ---
    const DEPT_MAP = {
        // Engineering Departments
        'cse': 'CSE', 'comp': 'CSE', 'cs': 'CSE', 'computer science': 'CSE', 'computer': 'CSE', 'comp sci': 'CSE', 'c s e': 'CSE',
        'ece': 'ECE', 'e&c': 'ECE', 'electronics': 'ECE', 'electroncs': 'ECE', 'ec': 'ECE', 'e c e': 'ECE',
        'eee': 'EEE', 'electrical': 'EEE', 'ee': 'EEE', 'e e e': 'EEE', 'elect and elec': 'EEE', 'elect. engg': 'EEE',
        'mech': 'MECH', 'mechanical': 'MECH', 'ma': 'MECH', 'mechanic': 'MECH', 'me': 'MECH', 'm e': 'MECH', 'm.e.': 'MECH', 'mech engg': 'MECH',
        'civil': 'CIVIL', 'ci': 'CIVIL', 'civil engg': 'CIVIL', 'c.e.': 'CIVIL', 'c. e.': 'CIVIL', 'civil engg': 'CIVIL',
        'it': 'IT', 'information technology': 'IT', 'info tech': 'IT', 'i t': 'IT', 'i.t.': 'IT',
        
        // Specializations (CS variations must handle dots and spaces)
        'ai&ml': 'CSE (AI&ML)', 'aiml': 'CSE (AI&ML)', 'ml': 'CSE (AI&ML)', 'machine learning': 'CSE (AI&ML)', 'ai & ml': 'CSE (AI&ML)', 'csm': 'CSE (AI&ML)',
        'ds': 'CSE (DS)', 'data science': 'CSE (DS)', 'd s': 'CSE (DS)', 'csd': 'CSE (DS)',
        'ai': 'CSE (AI)', 'artificial intelligence': 'CSE (AI)', 'a i': 'CSE (AI)', 'cai': 'CSE (AI)',
        'cs': 'CSE (CS)', 'cyber security': 'CSE (CS)', 'c s': 'CSE (CS)', 'c.s.': 'CSE (CS)', 'csc': 'CSE (CS)',
        
        // Academic/Support Departments
        'bsh': 'BS&H', 'basic sciences': 'BS&H', 'humanities': 'BS&H', 'b s h': 'BS&H',
        'cdc': 'CDC', 'placements': 'CDC', 'career': 'CDC', 'c d c': 'CDC', 'tpo': 'CDC',
        'mefa': 'MEFA', 'management studies': 'MEFA', 'mba': 'MEFA', 'm e f a': 'MEFA',
        'exam': 'EXAM', 'exam section': 'EXAM', 'examination': 'EXAM', 'exams': 'EXAM', 'co-e': 'EXAM', 'controller of examinations': 'EXAM',

        // Admin & General Staff
        'library': 'LIBRARY', 'lib': 'LIBRARY',
        'pd': 'PE', 'pe': 'PE', 'physical director': 'PE', 'sports': 'PE', 
        'maintenance': 'MAINTENANCE', 'works': 'MAINTENANCE',
        'security': 'SECURITY', 'guard': 'SECURITY',
        'xerox': 'XEROX', 'photocopy': 'XEROX',
        'admin': 'ADMIN', 'administrator': 'ADMIN', 'system admin': 'ADMIN', 'office': 'ADMIN', 'admn': 'ADMIN',
        'warden': 'HOSTEL', 'hostel': 'HOSTEL', 'hostler': 'HOSTEL',
        'transport': 'TRANSPORT', 'bus': 'TRANSPORT',
    };
    
    // --- FULL DEPARTMENT NAME MAP (FOR OUTPUT FORMATTING) ---
    const FULL_DEPT_NAMES = {
        'CSE': 'CSE',
        'EEE': 'EEE',
        'ECE': 'ECE',
        'MECH': 'MECH',
        'CIVIL': 'CIVIL',
        'IT': 'IT',
        'BS&H': 'BS&H',
        'CDC': 'CDC',
        'MEFA': 'MEFA',
        'EXAM': 'Exam Section',
        'ADMIN': 'Admin Office',
        'SECURITY': 'Security/Maint.',
        'HOSTEL': 'Hostel (Boys)', // Corrected to explicitly state Boys
        'TRANSPORT': 'Transport',
        'RECEPTION': 'Reception',
        'XEROX': 'Xerox',
        'GENERAL STAFF': 'General Staff',
        'CSE (CS)': 'CSE (CS)', 
        'CSE (DS)': 'CSE (DS)',
        'CSE (AI)': 'CSE (AI)',
        'CSE (AI&ML)': 'CSE (AI&ML)',
        // NEW CATEGORIES
        'LIBRARY': 'Library',
        'PE': 'PE/Sports',
        'MAINTENANCE': 'Maintenance',
        'CLASS_IV': 'Class IV',
    };
    
    // --- DYNAMIC SUGGESTION POOL (NEW) ---
    const SUGGESTION_POOL = [
        ["Who is the Dean CDC?", "Contact Principal Sir number", "Check latest Placement Trend"],
        ["What courses are offered?", "How do I get admission?", "Contact the Exam Section"],
        ["Who is the HOD for CSE?", "Check Fees", "Download previous sem papers"],
        ["What are the hostel timings?", "Contact the Warden number", "Who is the Discipline Officer?"],
        ["Who is the HOD for MECH?", "Check Affiliations", "What is the college fee?"],
        ["Download previous sem papers", "Contact the Administrative Office", "Check Hostel Timings"]
    ];


    // --- UTILITY FUNCTIONS ---
    // Cleans string by removing punctuation, spaces, and converting to lowercase for comparison
    const cleanString = (str) => {
        // KEEP SPACES AND DOTTED INITIALS! We will only remove honorifics and then normalize whitespace.
        return str.toLowerCase().replace(/^(dr|mr|mrs|ms)\.\s*/, '').replace(/[^a-z0-9\s\.]/g, '').replace(/\s+/g, ' ').trim();
    };
    
    // Strips honorifics and converts to lowercase for primary name comparison
    const normalizeName = (name) => {
        // This should be the single source of truth for name comparison
        // 1. Lowercase, remove honorifics, replace ALL non-alphanumeric/space characters with a space.
        return name.toLowerCase()
                       .replace(/^(dr|mr|mrs|ms)\s*\.?\s*/, '') 
                       .replace(/[^a-z0-9\s]/g, ' ') // Crucially replaces dots/periods with space
                       .replace(/\s+/g, ' ') 
                       .trim();
    };
    
    // Helper to get significant name words for robust matching
    const getSignificantWords = (nameNormalized) => {
        // Split by space, keeping only words that are 2+ letters long (filters out single-letter initials, which is correct for matching core name parts)
        return nameNormalized.split(/\s+/).filter(word => word.length > 1);
    };

    // Helper to extract the core name from a query (removing keywords like number/contact/dept)
    const extractCoreNameFromQuery = (query) => {
        let name = query.toLowerCase();
        
        // Remove common contact/designation words
        const keywords = ['number', 'contact', 'phone', 'call', 'hod', 'dean', 'sir', 'madam', 'professor', 'assistant', 'admin', 'warden', 'officer', 'technician', 'engg', 'dept', 'madam', 'sir', 'sri', 'ms', 'who', 'is', 'the', 'for', 'tell me the'];
        keywords.forEach(key => {
            name = name.replace(new RegExp('\\b' + key + '\\b', 'g'), '');
        });
        
        // Remove department abbreviations
        Object.keys(DEPT_MAP).forEach(key => {
             name = name.replace(new RegExp('\\b' + key + '\\b', 'g'), '');
        });

        // Remove double spaces and trim
        name = name.replace(/\s+/g, ' ').trim();
        // Remove honorifics/titles
        name = name.replace(/^(dr|mr|mrs|ms)\.\s*/, '').trim();
        
        return name;
    };
    
    // Levenshtein Distance implementation for Fuzzy Matching (NOT CURRENTLY USED, but kept for completeness)
    const levenshteinDistance = (s1, s2) => {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    }
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    };


    // --- DEDUPLICATION PASS (Runs once on initialization) ---
    const deduplicateStaff = (staffList) => {
        const uniqueNames = new Map();
        staffList.forEach(staff => {
            const cleanedKey = cleanString(staff.name);
            if (!uniqueNames.has(cleanedKey)) {
                uniqueNames.set(cleanedKey, staff);
            }
        });
        return Array.from(uniqueNames.values());
    };

    // Replace the raw STAFF_CONTACTS array with the deduplicated list
    const DEDUPLICATED_STAFF_CONTACTS = deduplicateStaff(STAFF_CONTACTS);

    // --- FUNCTION TO DERIVE CANONICAL BRANCH FROM STAFF DESIGNATION ---
    const getCanonicalBranch = (staffDesignation) => {
        const designationUpper = staffDesignation.toUpperCase();

        // Check for specific specializations first
        if (designationUpper.includes('CSE (AI&ML)')) return 'CSE (AI&ML)';
        if (designationUpper.includes('CSE (DS)')) return 'CSE (DS)';
        if (designationUpper.includes('CSE (AI)')) return 'CSE (AI)';
        
        // Handle CSE Ambiguity check (CSE, IT, CS)
        if (designationUpper.includes('CSE')) return 'CSE'; 
        if (designationUpper.includes('IT')) return 'IT';

        // Check for main departments (using designation substring check)
        if (designationUpper.includes('CIVIL')) return 'CIVIL';
        if (designationUpper.includes('EEE')) return 'EEE';
        if (designationUpper.includes('MECH')) return 'MECH';
        if (designationUpper.includes('ECE')) return 'ECE';
        if (designationUpper.includes('BS&H')) return 'BS&H';
        
        // Check for other sections (MAPPINGS)
        if (designationUpper.includes('CDC') || designationUpper.includes('APTITUDE')) return 'CDC';
        if (designationUpper.includes('MEFA') || designationUpper.includes('MANAGEMENT')) return 'MEFA';
        if (designationUpper.includes('EXAM')) return 'EXAM';
        if (designationUpper.includes('LIBRARY')) return 'LIBRARY';
        if (designationUpper.includes('PHYSICAL DIRECTOR') || designationUpper.includes('GARDENER') || designationUpper.includes('PE')) return 'PE';
        if (designationUpper.includes('AAYA') || designationUpper.includes('ATTENDER') || designationUpper.includes('CLASS IV')) return 'CLASS_IV';
        if (designationUpper.includes('XEROX')) return 'XEROX';
        
        // General Admin / Security / Maintenance
        if (designationUpper.includes('MAINTENANCE') || designationUpper.includes('SECURITY')) return 'SECURITY'; 
        if (designationUpper.includes('OFFICE SUPDT') || designationUpper.includes('ADMINISTRATIVE OFFICE') || designationUpper.includes('ADMIN') || designationUpper.includes('JUNIOR ASSISTANT') || designationUpper.includes('OPERATOR')) return 'ADMIN';
        if (designationUpper.includes('HOSTEL') || designationUpper.includes('WARDEN')) return 'HOSTEL';
        if (designationUpper.includes('TRANSPORT')) return 'TRANSPORT';
        if (designationUpper.includes('RECEPTION')) return 'RECEPTION';
        
        return 'GENERAL STAFF';
    };


    // --- NEW: Helper to filter matches based on user clarification (used inside handleStaffFollowUp) ---
    const filterMatchesByNewQuery = (matches, newQuery, filterType) => {
        const queryNormalized = normalizeName(newQuery); 
        
        // --- FILTER PASS 1: Department/Branch Match ---
        if (filterType === 'department') {
            let newTargetDeptCanonical = null;
            
            // CRITICAL FIX: Loop through DEPT_MAP keys and check if the query contains the key
            for (const [key, value] of Object.entries(DEPT_MAP)) {
                 // The queryNormalized is already clean (lowercase, no extra spaces)
                 if (queryNormalized.includes(key)) { 
                    newTargetDeptCanonical = value;
                    break;
                 }
            }
            
            if (newTargetDeptCanonical) {
                let deptFiltered = matches.filter(staff => {
                    const staffBranchCanonical = getCanonicalBranch(staff.designation);
                    
                    // Match general CSE or any specialization if a general query (like 'cse') was provided
                    if (newTargetDeptCanonical === 'CSE') {
                        return staffBranchCanonical.startsWith('CSE');
                    } else {
                         return staffBranchCanonical === newTargetDeptCanonical;
                    }
                });

                // If department filter succeeded, return the highly filtered list
                if (deptFiltered.length > 0) {
                     return deptFiltered;
                }
            }
        }
        
        // --- FILTER PASS 2: Full Name Match (Used for the 'Full Name Only' prompt) ---
        if (filterType === 'name') {
            const nameInputNormalized = normalizeName(newQuery);
            const nameInputWords = getSignificantWords(nameInputNormalized);
            
            let nameFiltered = matches.filter(staff => {
                 const staffNameNormalized = normalizeName(staff.name);
                 const staffNameWords = getSignificantWords(staffNameNormalized);
                 
                 // Require high degree of overlap for the clarification to succeed
                 const overlapCount = staffNameWords.filter(word => nameInputWords.includes(word)).length;
                 
                 // If the input name has 3 or more words, require at least 2 words to match.
                 // If the input name has 2 words, require at least 1 word match (and the context should help narrow it down).
                 const requiredOverlap = nameInputWords.length >= 3 ? 2 : 1; 

                 return overlapCount >= requiredOverlap;
            });
            
            // Prioritize the best name matches only
            if (nameFiltered.length > 0) {
                 return nameFiltered;
            }
        }


        // Final fallback: return the best list we have
        return []; 
    };


    // --- NEW: Function to handle contextual follow-ups (Iterative Fix) ---
    const handleStaffFollowUp = (followUpQuery) => {
        const followUpLower = followUpQuery.toLowerCase();
        
        // --- 1. SIMPLE CONFIRMATION CHECK (E.g., "his number") ---
        const isConfirmation = followUpLower.includes('number') || followUpLower === 'yes' || followUpLower === 'confirm' || followUpLower.includes('contact');

        // Check if a single match is stored AND the user is trying to confirm it (e.g., "his number")
        if (lastStaffQuery.state === 'idle' && lastStaffQuery.singleMatchFound) {
            if (isConfirmation) {
                const result = getStrictContactOutput(lastStaffQuery.singleMatchFound);
                // CRITICAL FIX: Clear context immediately after returning the result.
                lastStaffQuery.singleMatchFound = null; 
                lastStaffQuery.clarificationAttempts = 0; // Reset attempts on success
                return result;
            }
        }
        
        // --- 2. CLARIFICATION FLOW ---
        if (lastStaffQuery.state === 'prompting_for_clarification') {
            
            const initialMatches = lastStaffQuery.matches;
            lastStaffQuery.clarificationAttempts++; // Increment attempt counter
            
            let filteredMatches = [];
            let filterType = "";

            // Determine filter type based on current attempt number
            // Attempt 1: Should be Department/Branch
            if (lastStaffQuery.clarificationAttempts === 1) {
                filterType = 'department';
            } 
            // Attempt 2 & 3: Should be Full Name
            else if (lastStaffQuery.clarificationAttempts >= 2 && lastStaffQuery.clarificationAttempts <= 3) {
                filterType = 'name';
            }
            
            // --- CS AMBIGUITY CHECK (if Department clarification is attempted) ---
            if ((followUpLower === 'cs' || followUpLower.includes('computer science')) && lastStaffQuery.clarificationAttempts === 1) {
                 // For the new simplified flow, we treat 'CS' as a direct department clarification
            }

            // --- Apply Filtering ---
            if(filterType) {
                
                // CRITICAL SUNIL RAJ FIX: If the list is ambiguous and the user provides a department, filter that list.
                const hasDepartmentKeyword = Object.keys(DEPT_MAP).some(key => followUpLower.includes(key));
                
                if (hasDepartmentKeyword || followUpLower.includes('transport')) {
                    // This is a department/contextual clarification
                    
                    const matchesWithDepartment = initialMatches.filter(staff => {
                         const staffDesignationLower = staff.designation.toLowerCase();
                         
                         // Special check for Transport
                         if (followUpLower.includes('transport') && staffDesignationLower.includes('transport')) return true;

                         // General department mapping check
                         let matchedDept = Object.entries(DEPT_MAP).find(([key, value]) => followUpLower.includes(key));
                         if (matchedDept && staffDesignationLower.includes(matchedDept[1].toLowerCase())) {
                              return true;
                         }
                         return false;
                    });
                    
                    if (matchesWithDepartment.length > 0) {
                        filteredMatches = matchesWithDepartment;
                    } else {
                        // If department filtering yielded zero results, keep the original list and proceed to name search
                        filteredMatches = initialMatches; 
                        filterType = 'name'; // Ensure next step tries name search
                    }
                    
                } else if (filterType === 'name') {
                     // Standard name filtering (only runs if the user didn't use a department keyword or if the department filtering failed to narrow it down)
                     filteredMatches = filterMatchesByNewQuery(initialMatches, followUpQuery, 'name');
                 } else {
                     filteredMatches = initialMatches; // Keep current list if no useful filter found
                 }
            } else {
                filteredMatches = initialMatches;
            }
            
            if (filteredMatches.length === 1) {
                // SUCCESS: Clarified to one match
                const result = getStrictContactOutput(filteredMatches[0]);
                lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                return result;
            } else if (filteredMatches.length > 1) {
                
                // --- HANDLE MULTIPLE MATCHES AFTER FILTERING ---
                
                if (lastStaffQuery.clarificationAttempts >= 3) { 
                     // FINAL FAIL MESSAGE (After Department, then two Name attempts)
                     lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                     return `âŒ **Search Reset:** I've tried multiple ways to narrow down the search, but I still see **${filteredMatches.length} matching contacts**. Please try again with the **full name AND specific branch/designation** to find the correct contact immediately.`;
                }

                // Prepare for next clarification state
                lastStaffQuery.matches = filteredMatches; // Keep the smaller set
                
                if (lastStaffQuery.clarificationAttempts === 1) {
                    // Fail on Department filter, move to Name filter
                    lastStaffQuery.state = 'prompting_for_clarification'; 
                    // Ask for Full Name only
                    return `I still found multiple staff members even after filtering by department. Please provide the **full name** only to narrow it down further. (Try 1 of 2)`;
                } else if (lastStaffQuery.clarificationAttempts === 2) {
                     // Fail on first Name filter, ask for second/final Name filter
                     lastStaffQuery.state = 'prompting_for_clarification';
                     // Final Name Attempt
                     return `I still found multiple contacts matching that name. Please re-enter the **full name** one more time to confirm the match. (Final Try)`;
                }
            
            } else {
                // ZERO MATCHES (After filtering)
                // Final reset after a failed clarification attempt
                lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                return `âŒ **Not Found:** Sorry, I couldnâ€™t find a staff member matching that specific combination of details in the remaining list. Please try a new search with the **full name** or **department**.`;
            }
        }

        return null; // Not a contextual follow-up or confirmation
    };

    // --- NEW: Function to handle conversational bridge (yes/no/redirect) ---
    const handleConversationalBridge = (queryLowerNormalized) => {
        
        if (conversationFlow.state === 'awaiting_redirect') {
            const isConfirmation = queryLowerNormalized.includes('yes') || queryLowerNormalized.includes('yup') || queryLowerNormalized.includes('sure') || queryLowerNormalized.includes('contact');
            const isDenial = queryLowerNormalized.includes('no') || queryLowerNormalized.includes('nope') || queryLowerNormalized.includes('next');
            
            const targetQuery = conversationFlow.targetQuery;
            conversationFlow = { state: 'idle', targetQuery: null }; // Reset context immediately

            if (isConfirmation && targetQuery) {
                // CRITICAL FIX: Return the target query string to be executed by sendMessage
                return targetQuery;
            } else if (isDenial) {
                return "Got it! No problem at all. What other information can I look up for you? âœ¨";
            }
            // If neither confirmed nor denied, just let the main flow handle the input as a new query
            return null;
        }

        return null;
    };
    
    // --- NEW: Function to check for simple greetings ---
    const isGreeting = (query) => {
        const greetings = /(hello|hi|hey|yo|greetings|what's up|how are you|hey there)/i;
        // CRITICAL FIX: Ensure the greeting is very short and contains NO keywords like 'principal' or 'who is'.
        const normalizedQuery = query.toLowerCase();
        const hasKeywords = /(principal|dean|hod|who|what|where|how|when)/i.test(normalizedQuery);
        
        // Must match a greeting AND be short AND contain NO keywords.
        return greetings.test(query) && query.split(/\s+/).length <= 3 && !hasKeywords;
    };


    // --- State-aware contact search function ---
    const findStaffContactAndManageContext = (query, queryLowerNormalized) => {
        const queryLower = query.toLowerCase();
        
        // --- CRITICAL FIX: queryLowerNormalized is now passed in and used directly ---
        // const queryNormalized = normalizeName(query); 
        
        // 0. SPECIAL CASES (Akka/Discipline)
        if (queryLower.includes('akka')) {
            // Personalization: Using the user-provided contact for Akka
            const contactNumber = "798993489";
            const staff = { name: "Akka", number: contactNumber, designation: "Special Contact, N/A", email: "" };
            lastStaffQuery.singleMatchFound = staff;
            return getStrictContactOutput(staff);
        }
        
        // Reset non-single-match context variables for a new primary search
        lastStaffQuery.matches = [];
        lastStaffQuery.state = 'idle';
        lastStaffQuery.clarificationAttempts = 0; // Reset attempts on new search

        const coreNameInput = extractCoreNameFromQuery(query);
        const coreNameInputNormalized = normalizeName(coreNameInput); // The cleaned name to search for
        const coreNameInputWords = getSignificantWords(coreNameInputNormalized);
        // const totalNameWordsInQuery = coreNameInputWords.length; // Unused variable removed

        // --- TIER 0: ABSOLUTE ROLE MATCH (Priority 0) ---
        // Handles queries like "who is the principal" or "hod number"
        const roleKeywords = ['principal', 'hod', 'dean', 'warden', 'discipline officer', 'reception', 'xerox', 'civil', 'eee', 'mech', 'ece', 'cse', 'it', 'bsh', 'administrative office', 'admin office', 'exam section', 'transport'];
        let matchedRole = null;
        let matchedRoleKey = null; // Store the key (e.g., 'principal', 'former principal')

        // CRITICAL: Check for 'former' / 'current' context
        const isHistoricalQuery = queryLower.includes('former') || queryLower.includes('previous') || queryLower.includes('past');
        
        for (const role of roleKeywords) {
            // Check for explicit 'former' role query first
            if (isHistoricalQuery && role === 'principal') {
                 if (queryLower.includes(role) || queryLower.includes('former principal')) {
                     matchedRoleKey = 'former principal';
                     matchedRole = 'principal';
                     break;
                 }
            }
            // Check for generic role query
            if (queryLower.includes(role)) {
                matchedRoleKey = role;
                matchedRole = role;
                break;
            }
        }
        
        // Determine if the user asked for a NUMBER/CONTACT (strict) or just WHO (general)
        const isContactRequest = queryLower.includes('number') || queryLower.includes('contact') || queryLower.includes('phone');

        if (matchedRoleKey) {
             // 1. Handle General Role Inquiry (Who is X?) -> CRITICAL CHECK HERE
             if (!isContactRequest) {
                 // Tighter check for key roles like Dean CDC or HODs
                 if (queryLower.includes('dean cdc') || (queryLower.includes('dean') && (queryLower.includes('cdc') || queryLower.includes('career')))) {
                     matchedRoleKey = 'dean cdc';
                 } else if (queryLower.includes('hod cse') || (queryLower.includes('hod') && queryLower.includes('cse') && !queryLower.includes('ai&ml') && !queryLower.includes('ds') && !queryLower.includes('(ai)') && !queryLower.includes('(ds)') && !queryLower.includes('(cs)'))) {
                     matchedRoleKey = 'hod cse';
                 } else if (queryLower.includes('hod mech') || queryLower.includes('hod me') || queryLower.includes('hod ma') || (queryLowerNormalized.includes('hod') && (queryLower.includes('mech') || queryLower.includes('mechanical')))) {
                     // NEW FIX: Robust check for HOD Mechanical / ME / MA
                     matchedRoleKey = 'hod mech';
                 } else if (queryLower.includes('hod eee') || (queryLowerNormalized.includes('hod') && queryLower.includes('eee'))) {
                     matchedRoleKey = 'hod eee';
                 } else if (queryLower.includes('discipline officer') || (queryLowerNormalized.includes('discipline') && queryLowerNormalized.includes('officer'))) {
                    // FIX for Discipline Officer name lookup
                    matchedRoleKey = 'discipline officer';
                 } else if (queryLower.includes('hod civil') || (queryLowerNormalized.includes('hod') && queryLower.includes('civil'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod civil';
                 } else if (queryLower.includes('hod ece') || (queryLowerNormalized.includes('hod') && queryLower.includes('ece'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod ece';
                 } else if (queryLower.includes('hod it') || (queryLowerNormalized.includes('hod') && queryLower.includes('it'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod it';
                 } else if (queryLower.includes('hod bsh') || (queryLowerNormalized.includes('hod') && queryLower.includes('bsh'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod bsh';
                 } else if (queryLower.includes('hod cse (cs)') || queryLower.includes('hod cs') || queryLower.includes('hod cyber')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (cs)';
                 } else if (queryLower.includes('hod cse (ds)') || queryLower.includes('hod ds') || queryLower.includes('hod data science')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ds)';
                 } else if (queryLower.includes('hod cse (ai&ml)') || queryLower.includes('hod aiml')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ai&ml)';
                 } else if (queryLower.includes('hod cse (ai)') || queryLower.includes('hod ai')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ai)';
                 } else {
                     matchedRoleKey = roleKeywords.find(r => queryLowerNormalized.includes(r)); // Use queryLower here
                 }

                 
                 const candidate = VERIFIED_ROLE_NAMES[matchedRoleKey] || null;
                 if(candidate) {
                     return getGeneralRoleOutput(candidate.name, candidate.designation);
                 }
                 // If not in verified list (e.g. 'director'), defer to Gemini below
             }
             
             // 2. Handle Contact Request (X number?) - Use STAFF_CONTACTS
             if (isContactRequest) {
                 // For a contact query, we only use the CURRENT role holder unless explicitly former contact is stored
                 const contactRoleKey = (matchedRoleKey === 'former principal') ? 'principal' : matchedRoleKey;
                 
                 // Use robust keyword matching for contact request against the whole contact list
                 let roleCandidate = null;
                 let targetDept = null;
                 let targetRole = null;

                 // --- HOD/DEPT Specific Logic (Updated for generalization and FIX) ---
                 if (queryLower.includes('hod') || queryLower.includes('department')) {
                     
                     // Try to extract the canonical department name from the query
                     targetDept = Object.keys(DEPT_MAP).find(key => queryLower.includes(key));
                     targetRole = 'HOD'; 

                     if (targetDept) {
                         const canonicalDept = DEPT_MAP[targetDept];
                         const canonicalDeptLower = canonicalDept.toLowerCase();
                         
                         // *** CRITICAL HOD FIX: Prioritize personal HOD entry (excluding generic 'Main Dept Line') ***
                         // Logic: Find the entry that has HOD and the department name, but NOT the general "main dept line" tag.
                         roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => 
                             s.designation.toLowerCase().includes('hod') && 
                             s.designation.toLowerCase().includes(canonicalDeptLower) &&
                             !s.designation.toLowerCase().includes('main dept line')
                         );

                         // Priority 2: If no explicit HOD person is found, find the main department line
                         if (!roleCandidate) {
                              // Find the generic department line contact
                              let genericDeptLine = DEDUPLICATED_STAFF_CONTACTS.find(s => 
                                 s.designation.toLowerCase().includes(canonicalDeptLower) && 
                                 s.designation.toLowerCase().includes('main dept line')
                              );

                              if(genericDeptLine) {
                                  // Find the HOD name from the VERIFIED_ROLE_NAMES map
                                  // This handles both main branches (cse) and specializations (cse (ds))
                                  const hodKey = `hod ${canonicalDept.toLowerCase().replace(/[\(\)]/g, '')}`;
                                  
                                  // FIX for specializations: They should be stored as 'cse (ai)' not 'cse(ai)'
                                  let finalHodKey = hodKey;
                                  if (hodKey.includes('cse')) {
                                       // Reconstruct key for specializations: 'hod cse (ds)'
                                       if(canonicalDept.includes('(DS)')) finalHodKey = 'hod cse (ds)';
                                       else if(canonicalDept.includes('(AI&ML)')) finalHodKey = 'hod cse (ai&ml)';
                                       else if(canonicalDept.includes('(AI)')) finalHodKey = 'hod cse (ai)';
                                       else if(canonicalDept.includes('(CS)')) finalHodKey = 'hod cse (cs)';
                                  }

                                  const hodInfo = VERIFIED_ROLE_NAMES[finalHodKey];
                                  
                                  if (hodInfo) {
                                      // Clone the entry and inject the HOD's name
                                      roleCandidate = { ...genericDeptLine, overridenName: hodInfo.name, designation: hodInfo.designation };
                                  } else {
                                      roleCandidate = genericDeptLine; // Use generic name if HOD name is missing
                                  }
                              }
                         }
                     }
                 } else if (queryLower.includes('sunil raj') && (queryLower.includes('transport') || queryLower.includes('bus') || queryLower.includes('route'))) {
                     // *** SUNIL RAJ TRANSPORT FIX: Explicitly prioritize Transport Coordinator ***
                     roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.name.toLowerCase().includes('sunil raj') && s.designation.toLowerCase().includes('transport'));
                 } else if (queryLower.includes('sunil raj') && (queryLower.includes('mech') || queryLower.includes('ma') || queryLower.includes('mechanical'))) {
                     // *** SUNIL RAJ MECH FIX: Explicitly prioritize MECH Associate Professor ***
                     roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.name.toLowerCase().includes('sunil raj') && s.designation.toLowerCase().includes('mech'));
                 } else if (queryLower.includes('discipline officer')) {
                     // Match Discipline Officer contact specifically
                     roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.designation.toLowerCase().includes('discipline officer'));
                 } else if (queryLower.includes('exam section') || queryLower.includes('examination section') || queryLower.includes('coe')) {
                      // *** CRITICAL EXAM SECTION FIX: Prioritize Exam Section Staff ***
                      // Find the primary exam staff member 
                      roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.designation.toLowerCase().includes('exam section staff'));
                 } else if (queryLower.includes('administrative office') || queryLower.includes('admin office') || queryLower.includes('admin number')) {
                      // *** CRITICAL ADMIN OFFICE FIX: Prioritize Admin Office contact ***
                      // Find the Office Supdt, as they are the primary administrative POC
                      roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.designation.toLowerCase().includes('office supdt, administrative office'));
                      
                      // Fallback 2: If Office Supdt not found, find any staff mentioning "Administrative Office"
                      if (!roleCandidate) {
                           roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.designation.toLowerCase().includes('administrative office'));
                      }
                 } else {
                      // Fallback to general role search (e.g., Principal, Warden, Exam Section)
                      roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.designation.toLowerCase().includes(contactRoleKey));
                 }
                 
                 // If they asked for the contact of the former Principal, use the name lookup
                 if (matchedRoleKey === 'former principal') {
                      roleCandidate = DEDUPLICATED_STAFF_CONTACTS.find(s => s.name.toLowerCase().includes('k. satyanarayana'));
                 }

                 if (roleCandidate) {
                     lastStaffQuery.singleMatchFound = roleCandidate;
                     return getStrictContactOutput(roleCandidate);
                 }
             }
        }
        // --- END TIER 0 ---

        // --- 1. SEARCH PHASE (Full Name & Short Name/Keyword) ---
        let candidates = [];
        
        // --- TIER 1A: ABSOLUTE FULL NAME LOCK (Priority 1) ---
        const totalNameWordsInQuery = coreNameInputWords.length;
        if (totalNameWordsInQuery >= 2) {
            for (const staff of DEDUPLICATED_STAFF_CONTACTS) {
                const staffNameNormalized = normalizeName(staff.name);
                const staffSigWords = getSignificantWords(staffNameNormalized);
                
                const overlapCount = staffSigWords.filter(word => coreNameInputWords.includes(word)).length;
                
                // If 80% or more of the staff name words are present in the query (e.g., Manas Kumar Yogi -> 3 words, need 2)
                const requiredOverlapForFullMatch = Math.ceil(staffSigWords.length * 0.8);
                
                // FIX 1: The condition to check for a strong full name match
                if (overlapCount >= requiredOverlapForFullMatch) { 
                    
                    // Double-check for multiple full match candidates before resolving instantly
                    let uniqueCandidates = DEDUPLICATED_STAFF_CONTACTS.filter(s => {
                        const sNameNormalized = normalizeName(s.name);
                        const sSigWords = getSignificantWords(sNameNormalized);
                        const sOverlapCount = sSigWords.filter(word => coreNameInputWords.includes(word)).length;
                        return sOverlapCount >= requiredOverlapForFullMatch;
                    });

                    if (uniqueCandidates.length === 1) {
                         // Unambiguous full name match: Resolve immediately
                         lastStaffQuery.singleMatchFound = uniqueCandidates[0];
                         return getStrictContactOutput(uniqueCandidates[0]);
                    }
                }
            }
        }

        // --- TIER 1B: SHORT NAME / KEYWORD MATCH (Strict Inclusion Check for Ambiguity) ---
        // This runs if a full name was NOT resolved instantly, or the query was short (e.g. 'manas', 'tulasi')
        
        for (const staff of DEDUPLICATED_STAFF_CONTACTS) {
            const staffNameNormalized = normalizeName(staff.name);
            
            // CRITICAL FIX: The staff name must strictly contain the cleaned core input name.
            // (Only for names >= 2 letters to filter out single initials like 'a')
            if (staffNameNormalized.includes(coreNameInputNormalized) && coreNameInputNormalized.length >= 2) {
                candidates.push(staff);
            }
        }
        
        // --- 2. RESOLUTION PHASE (Strict Ambiguity Check) ---
        
        if (candidates.length === 0) {
            // Case 4: General Fail (No strict inclusion match found anywhere)
            return `âŒ Sorry, I couldnâ€™t find any staff with that name. Please check the spelling or provide more details.`;
        }
        
        // --- Case 1: SINGLE Match Found (Short Name or Unique Full Name) ---
        if (candidates.length === 1) { 
             lastStaffQuery.singleMatchFound = candidates[0];
             return getStrictContactOutput(candidates[0]);
        }
        
        // --- Case 2: AMBIGUITY (Multiple Strict Matches) ---
        
        if (candidates.length > 1) {
            // Set context for follow-up
            lastStaffQuery.matches = candidates;
            lastStaffQuery.state = 'prompting_for_clarification';
            
            // Return the prompt
            return getMultipleMatchesOutput(candidates);
        }

        // Final fallback: Should be unreachable if the logic above is correct
        return `âŒ Sorry, I couldnâ€™t find any staff with that name. Please check the spelling or provide more details.`; 
    };


    // --- PQP DOWNLOAD MAP (Keep the structure, but simplify the handler) ---
    const DOWNLOAD_MAP = {
        'BTECH-I-I': { 
            label: 'I B.Tech. I Sem', 
            files: [
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R16 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R19 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R20 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R23 set)'
            ]
        },
        'BTECH-I-II': { label: 'I B.Tech. II Sem', files: ['R23 BTech I-II Papers'] },
        'BTECH-II-I': { label: 'II B.Tech. I Sem', files: ['R20 BTech II-I Papers'] },
        'BTECH-II-II': { label: 'II B.Tech. II Sem', files: ['R20 BTech II-II Papers'] },
        'BTECH-III-I': { label: 'III B.Tech. I Sem', files: ['R20 BTech III-I Papers'] },
        'BTECH-III-II': { label: 'III B.Tech. II Sem', files: ['R20 BTech III-II Papers'] },
        'BTECH-IV-I': { label: 'IV B.Tech. I Sem', files: ['R19 BTech IV-I Papers'] },
        'BTECH-IV-II': { label: 'IV B.Tech. II Sem', files: ['R19 BTech IV-II Papers'] },
        'MTECH': { label: 'M.Tech. (All Years)', files: ['MTech PQP Archive'] },
    };
    
    // --- SYLLABUS HANDLER (REFACTORED for maximum content density) ---
    const handleSyllabusQuery = () => {
        const syllabusLink = 'https://pragati.ac.in/examination/course-structure-syllabus/';
        const academicCalendarLink = 'https://pragati.ac.in/examinations/academic-calendars/';
        
        // --- ACADEMIC BUTTONS (FIXED: Compacted to single line) ---
        const syllabusButton = `<a href="${syllabusLink}" target="_blank" class="block w-full text-center py-3 bg-[#006494] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#004d73] transition duration-200 button-click-animation text-sm mb-2"><span class="mr-1">ðŸ“š</span> VIEW COURSE STRUCTURE & SYLLABUS</a>`;
        const academicCalendarButton = `<a href="${academicCalendarLink}" target="_blank" class="block w-full text-center py-3 bg-[#00C9A7] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#00A887] transition duration-200 button-click-animation text-sm"><span class="mr-1">ðŸ“…</span> LATEST ACADEMIC CALENDARS</a>`;
        // --- END ACADEMIC BUTTONS ---
        
        const contentHTML = `
            <p class="text-sm contact-designation-text">Find the complete curriculum and academic schedule here:</p>
            <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                <li class="contact-designation-text">**Course Structure:** Select your **Regulation** (R23/R20) and **Year** (I-IV) to download the full syllabus PDF.</li>
                <li class="contact-designation-text">**Key Dates:** All **Mid-Exam** and **End-Exam** dates are available in the Academic Calendar.</li>
                <li class="contact-designation-text">**JNTUK Affiliation:** Follows **JNTUK Kakinada** exam system.</li>
            </ul>
            <div class="info-divider">
                ${syllabusButton}
                ${academicCalendarButton}
            </div>
            <p class="mt-3 text-sm font-bold accent-highlight">
                Need the **Exam Section** number for quick clarifications? ðŸ¤”
            </p>
        `;
        
        // Set conversational redirect state
        conversationFlow = {
            state: 'awaiting_redirect',
            targetQuery: 'Contact the Exam Section number',
        };
        
        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494] mb-1">ðŸ“š Academic Docs & Syllabus ðŸŽ“</p>
                ${contentHTML}
            </div>
        `;
    };

    // --- PQP HANDLER (NEW ELEGANT CARD) ---
    const handlePaperQuery = (query) => {
        const officialPqpLink = 'https://pragati.ac.in/examination/previous-question-papers/';

        // Intent check remains necessary to correctly trigger this block over the AI fallback
        const queryLower = query.toLowerCase();
        const isPaperQueryIntent = /previous|question paper|papers|exam|m.tech|b.tech|btech|mtech/i.test(queryLower);
        if (!isPaperQueryIntent || /syllabus|academic/i.test(queryLower)) {
            return { success: false, html: null, isMissingBranch: false };
        }
        
        // Set conversational redirect state
        conversationFlow = {
            state: 'awaiting_redirect',
            targetQuery: 'Contact the Exam Section number', 
        };

        // --- FIXED HTML STRUCTURE for clean link display ---
        const html = `
            <div class="info-card p-4 bg-white/95 border-2 border-dashed border-[#00C9A7]/50">
                <div class="flex items-center mb-3">
                    <span class="text-3xl text-[#006494] mr-3">ðŸ“‚</span>
                    <div>
                        <p class="font-extrabold text-xl text-[#006494] mb-0">Official PQP Archive</p>
                        <p class="text-xs text-gray-500 mt-0">Updated Regularly by the Examination Section</p>
                    </div>
                </div>
                
                <p class="text-sm contact-designation-text mb-2">
                    All past papers (R23, R20, etc., for B.Tech & M.Tech) are hosted on the secure college portal.
                    **Use the button below to search the centralized archive.**
                </p>

                <a href="${officialPqpLink}" target="_blank" class="block w-full text-center py-3 bg-[#00C9A7] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#00A887] transition duration-200 button-click-animation"><span class="mr-1">â¬‡ï¸</span> ACCESS DOWNLOAD PORTAL</a>

                <div class="info-divider mt-4 pt-3">
                    <p class="mt-0 text-sm font-bold accent-highlight">
                        Need help finding papers for a specific subject? Or the **Exam Section contact**? ðŸ¤”
                    </p>
                </div>
            </div>
        `;
        return { success: true, html: html, isMissingBranch: false };
    };
    
    // --- GENERAL COLLEGE QUERY HANDLER (REFACTORED for maximum content density) ---
    const handleGeneralCollegeQuery = (query) => {
        const queryLower = query.toLowerCase();
        let title, content, nextQuestion, redirectQuery;

        // --- 1. ADMISSIONS PROCESS ---
        if (queryLower.includes('admission') || queryLower.includes('how to join') || queryLower.includes('eligibility')) {
            title = 'ðŸš€ Ready to Join? Admission Process';
            const link = 'https://pragati.ac.in/admissions/eligibility/';
            // FIX: Compacted to single line
            const button = `<a href="${link}" target="_blank" class="block w-full text-center py-3 bg-[#006494] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#004d73] transition duration-200 button-click-animation text-sm mt-2"><span class="mr-1">âœ…</span> VIEW OFFICIAL ELIGIBILITY DETAILS</a>`;

            content = `
                <p class="text-sm contact-designation-text">Getting admitted is primarily through the state-level **EAPCET** exam.</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**EAMCET Code:** **PRAG** is our official code for counselling.</li>
                    <li class="contact-designation-text">**Main Route:** **EAPCET Counselling** (based on rank).</li>
                    <li class="contact-designation-text">**Alternative:** Direct **Management Quota** seats available.</li>
                    <li class="contact-designation-text">**Eligibility:** Min **45%** in PCM (10+2).</li>
                </ul>
                <div class="info-divider">
                    ${button}
                </div>
            `;
            nextQuestion = `What exciting **courses** are offered here? ðŸ“š`;
            redirectQuery = 'What courses are offered?';
        }
        // --- 2. COLLEGE FEE STRUCTURE (UPDATED FOR ACCURACY) ---
        else if (queryLower.includes('fee') || queryLower.includes('fees') || queryLower.includes('tuition')) {
            title = 'ðŸ’° Your Investment: Tuition Fee Structure';
            content = `
                <p class="text-sm contact-designation-text">Fees are set by the State Government, covering tuition and development charges.</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**Annual Tuition (EAPCET):** Approx. **â‚¹77,000 - â‚¹77,800** p.a. </li>
                    <li class="contact-designation-text">**Management Quota:** Fees for MQ are higher, ranging from **â‚¹1,00,000 to â‚¹1,95,000** p.a.</li>
                    <li class="contact-designation-text">**Scholarship Perk:** Eligible for **Jagananna Vidya Deevena** (Fee Reimbursement).</li>
                    <li class="contact-designation-text">**Hostel/Mess (Boys):** Separate costs (approx. **â‚¹1,00,000 - â‚¹1,20,000** p.a.).</li>
                </ul>
                <div class="info-divider">
                    <p class="text-xs font-semibold accent-highlight">âš ï¸ **Quick Tip:** For the *absolute exact* amount, contact the **Administrative Office** directly.</p>
                </div>
            `;
            nextQuestion = `Can you provide the **Administrative Office contact**? ðŸ“ž`;
            redirectQuery = 'Contact the Administrative Office number';
        }
        // --- 3. COURSES OFFERED ---
        else if (queryLower.includes('course') || queryLower.includes('branch') || queryLower.includes('stream')) {
            title = 'ðŸ›ï¸ Explore Our B.Tech Courses!';
            const link = 'https://pragati.ac.in/departments/';
            // FIX: Compacted to single line
            const button = `<a href="${link}" target="_blank" class="block w-full text-center py-3 bg-[#006494] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#004d73] transition duration-200 button-click-animation text-sm mt-2"><span class="mr-1">ðŸ”—</span> VIEW ALL DEPARTMENTS & INTAKE DETAILS</a>`;
            
            content = `
                <p class="text-sm contact-designation-text">We offer a full spectrum of engineering programs to match your ambition:</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**Total UG Branches:** 10 (Core and Specializations).</li>
                    <li class="contact-designation-text">**Core Branches:** CSE (Largest intake - 360 seats), ECE (240 seats), EEE (60), MECH (60), CIVIL (60), IT (60).</li>
                    <li class="contact-designation-text">**Specializations:** CSE (DS, AI, AI&ML, CS) - Total 540 seats.</li>
                    <li class="contact-designation-text">**PG Programs:** M.Tech in CSE, Power Electronics, CAD/CAM, VLSI Design.</li>
                </ul>
                <div class="info-divider">
                    ${button}
                </div>
            `;
            nextQuestion = `Tell me about **placements** at Pragati? ðŸ’°`;
            redirectQuery = 'Check latest Placement Trend';
        }
        // --- 4. AFFILIATION/RANKING ---
        else if (queryLower.includes('affiliate') || queryLower.includes('rank') || queryLower.includes('rating')) {
            title = 'ðŸ† Accreditation & Recognition';
            content = `
                <p class="text-sm contact-designation-text">We maintain top-tier recognition for academic excellence:</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**Status:** **UGC Autonomous** College.</li>
                    <li class="contact-designation-text">**Affiliation:** Affiliated to **JNTUK (Kakinada)**.</li>
                    <li class="contact-designation-text">**Accreditation:** **NAAC 'A' Grade** and approved by **AICTE**.</li>
                    <li class="contact-designation-text">**Location:** ADB Road, Surampalem, Peddapuram. College Code: **PRAG**.</li>
                </ul>
                <div class="info-divider">
                    <p class="text-xs font-semibold accent-highlight">The college operates under the **Gayatri Educational Society**, established in 2001.</p>
                </div>
            `;
            nextQuestion = `What are the **hostel timings**? â°`;
            redirectQuery = 'What are the hostel timings?';
        }
        else {
            return null;
        }

        // Set conversational redirect state
        conversationFlow = {
            state: 'awaiting_redirect',
            targetQuery: redirectQuery,
        };
        
        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494] mb-1">${title} âœ¨</p>
                ${content}
                <p class="mt-3 text-sm font-bold accent-highlight">
                    ${nextQuestion}
                </p>
            </div>
        `;
    };

    // --- TIMING HANDLER (REFACTORED for comprehensive timings) ---
    const handleTimingQuery = (query) => {
        const queryLower = query.toLowerCase();
        
        let title, content, nextQuestion, redirectQuery;
        
        // CRITICAL FIX: Only trigger if explicitly asking for time/schedule-related words.
        const isScheduleQuery = /when|time|schedule|\bhours\b|\bstarts\b|\bends\b/i.test(queryLower);
        
        // NEW INTELLIGENCE CHECK: If the query contains "hostel" or "food" but is NOT asking for quality, use this timing handler.
        const isHostelTimingQuery = (queryLower.includes('hostel') || queryLower.includes('food')) && !(/how is|quality|reviews|good|bad|do we have/i.test(queryLower));

        if (!isScheduleQuery && !isHostelTimingQuery) {
            return null;
        }

        if (queryLower.includes('hostel') || queryLower.includes('hostler') || queryLower.includes('dinner') || queryLower.includes('breakfast') || isHostelTimingQuery) {
            
            // Hosteler timings
            title = 'Hostel (Boys) & College Timings â°';
            content = `
                <p class="text-sm contact-designation-text">Stay on schedule with the essential timings:</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**Classes:** **9:00 AM to 4:00 PM** (Daily).</li>
                    <li class="contact-designation-text">**Hostel Curfew (Boys):** Final entry is **6:30 PM**.</li>
                    <li class="contact-designation-text">**Hostel Breakfast:** Served at **8:00 AM**.</li>
                    <li class="contact-designation-text">**Hostel Dinner:** Starts at **7:30 PM**.</li>
                </ul>
            `;
            nextQuestion = `Need the **Warden's contact number** for the hostel? ðŸ“ž`;
            redirectQuery = 'Contact the Warden number';
        } else if (queryLower.includes('canteen') || queryLower.includes('day scholar') || queryLower.includes('lunch') || queryLower.includes('admin office') || queryLower.includes('class hours')) {
            // Day Scholar timings (Canteen/Lunch)
            title = 'Lunch & College Timings ðŸ¥ª';
            content = `
                <p class="text-sm contact-designation-text">Here is the daily schedule for day scholars:</p>
                <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                    <li class="contact-designation-text">**Classes Start:** **9:00 AM** sharp.</li>
                    <li class="contact-designation-text">**Senior Lunch (II-IV Year):** **12:00 PM - 12:30 PM**.</li>
                    <li class="contact-designation-text">**First Year Lunch (I Year):** **1:00 PM - 1:30 PM**.</li>
                    <li class="contact-designation-text">**College Closes:** **4:00 PM**.</li>
                </ul>
            `;
            nextQuestion = `What about the **Admin Office** working hours? ðŸ›ï¸`;
            redirectQuery = 'Contact the Administrative Office number';
        } else {
            return null;
        }

        // Set conversational redirect state
        conversationFlow = {
            state: 'awaiting_redirect',
            targetQuery: redirectQuery,
        };
        
        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494] mb-1">${title} ðŸ“…</p>
                ${content}
                <p class="mt-3 text-sm font-bold accent-highlight">
                    ${nextQuestion}
                </p>
            </div>
        `;
    };
    
    // --- PLACEMENT TEXT-ONLY HANDLER (REFACTORED) ---
    const getPlacementSummary = () => {
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const latestYear = PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1];
        const officialLink = 'https://pragati.ac.in/placements/';
        // FIX: Compacted to single line
        const button = `<a href="${officialLink}" target="_blank" class="block w-full text-center py-3 bg-[#006494] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#004d73] transition duration-200 button-click-animation text-sm mt-2"><span class="mr-1">ðŸ”—</span> VIEW OFFICIAL PLACEMENTS PAGE</a>`;

        
        const contentHTML = `
            <p class="text-sm contact-designation-text">The **CDC** team delivers strong recruitment results through dedicated training:</p>
            <ul class="mt-2 text-sm space-y-0 pl-4 list-disc list-inside compact-list">
                <li class="contact-designation-text">âœ¨ **Highest Package:** Hit a peak of <strong class="text-xl text-[#00C9A7]">${latestHighest} LPA</strong>.</li>
                <li class="contact-designation-text">ðŸ“ˆ **Average Package:** Solid at <strong>${latestAverage} LPA</strong>.</li>
                <li class="contact-designation-text">ðŸŽ“ **Total Offers:** **1625+** (including multiple offers per student).</li>
                <li class="contact-designation-text">**Preparation Focus:** Training covers **Aptitude, Verbal, Soft Skills**, and **Technical** rounds.</li>
            </ul>
            <div class="info-divider">
                ${button}
                <p class="mt-2 text-sm font-bold accent-highlight">
                    Want to check the **training schedule** or see the data trend as a **graph**? ðŸ“Š
                </p>
            </div>
        `;
        
        // Set conversational redirect state
        conversationFlow = {
            state: 'awaiting_redirect',
            targetQuery: 'Show me the placement chart',
        };
        
        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494] mb-1">ðŸ’° Placement Highlights (${latestYear}) ðŸš€</p>
                ${contentHTML}
            </div>
        `;
    };

    // --- CHART.JS RENDERING FUNCTION ---
    const showPlacementGraph = (isThemeUpdate = false) => { // ADDED FLAG
        // CRITICAL FIX: Define graphIntros outside the conditional to resolve ReferenceError
        const graphIntros = [
            "Here comes the visual data! Watch that trend line climb! ðŸ“ˆ",
            "I'd be happy to show you you the trend! Get ready for the graph view. ðŸ“Š",
            "Time for some data visualization! This shows our continuous growth. ðŸ¤©",
        ];
        
        // 1. Add chat confirmation message
        if (placementChart) {
             placementChart.destroy();
        } else if (!isThemeUpdate) { // ONLY add message if NOT a theme update
            const intro = graphIntros[Math.floor(Math.random() * graphIntros.length)]; // Correct variable use
            addMessage(`${intro}`, false);
        }
        
        // 2. Create the wrapper div for the chart
        let chartWrapper = chatHistory.querySelector('.chart-wrapper');
        if (!chartWrapper) {
            chartWrapper = document.createElement('div');
            chartWrapper.className = 'bot-message message-bubble chart-wrapper flex flex-col items-start info-card w-full max-w-full';
        } else {
             chartWrapper.innerHTML = ''; // Clear previous content if redrawing
             chartWrapper.classList.remove('hidden');
        }
        
        // 3. Add the canvas element
        const canvas = document.createElement('canvas');
        canvas.id = 'placementChart';
        chartWrapper.appendChild(canvas);
        
        // 4. Create the summary text area
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'graph-summary';
        
        // Calculate dynamic summary points
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const firstHighest = PLACEMENT_DATA.highest[0];
        const highestGrowth = ((latestHighest - firstHighest) / firstHighest * 100).toFixed(0);
        // Calculate average growth based on the latest year vs previous year
        const prevAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 2];
        const averageGrowth = ((latestAverage - prevAverage) / prevAverage * 100).toFixed(0); 

        summaryDiv.innerHTML = `
            <h4 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">Key Trends (2022 - 2025):</h4>
            <p class="contact-designation-text">âœ… <strong>Highest Pkg:</strong> Climbing from <strong>${firstHighest} LPA</strong> to a high of <strong>${latestHighest} LPA</strong> (a massive <strong>${highestGrowth}% growth</strong>).</p>
            <p class="contact-designation-text">ðŸ“ˆ <strong>Average Pkg:</strong> Steady upward trend, reaching <strong>${latestAverage} LPA</strong>. </p>
            <p class="mt-2 text-sm font-bold accent-highlight">
                Want to contact the **Dean CDC** for guidance? ðŸ“ž
            </p>
        `;
        
        chartWrapper.appendChild(summaryDiv);
        
        chatHistory.appendChild(chartWrapper);
        scrollToBottom();
        
        // Set conversational redirect state
        if (!isThemeUpdate) { // ONLY set context if NOT a theme update
            conversationFlow = {
                state: 'awaiting_redirect',
                targetQuery: 'Contact Dean CDC number',
            };
        }

        // 5. Render the chart
        
        const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const tealColor = isDark ? 'rgba(0, 201, 167, 0.8)' : 'rgba(0, 201, 167, 0.8)';
        const deepBlueColor = isDark ? 'rgba(0, 100, 148, 0.8)' : 'rgba(0, 100, 148, 0.8)';

        placementChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: PLACEMENT_DATA.years,
                datasets: [
                    {
                        label: 'Highest Package (LPA)',
                        data: PLACEMENT_DATA.highest,
                        backgroundColor: tealColor,
                        borderColor: tealColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average Package (LPA)',
                        data: PLACEMENT_DATA.average,
                        backgroundColor: deepBlueColor,
                        borderColor: deepBlueColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Placement Package Trends (LPA)',
                        font: { size: 16, weight: 'bold' },
                        color: textColor
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor // Set legend text color
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Package in LPA',
                            color: textColor
                        },
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    };
    
    // --- VOICE INPUT LOGIC ---

    const startVoiceInput = () => {
        if (!('webkitSpeechRecognition' in window)) {
            addMessage("âŒ **Error:** Speech recognition is not supported in this browser. Please use Chrome or a Chromium-based browser.", false);
            return;
        }

        if (recognition && recognition.running) {
            recognition.stop();
            return;
        }
        
        // Initialize Speech Recognition API
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            voiceButton.classList.add('mic-active');
            voiceButton.disabled = false; // Enable the button to allow stopping
            sendButton.disabled = true;
            userInput.placeholder = "ðŸ‘‚ Listening... Speak now!";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            // The logic below will send the message automatically when speech stops
            recognition.stop();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            // Hide the error message from the chat, just print to console for debugging
            recognition.stop();
        };

        recognition.onend = () => {
            voiceButton.classList.remove('mic-active');
            sendButton.disabled = false;
            userInput.placeholder = "Ask a question...";

            // Automatically send the transcribed text if available
            if (userInput.value.trim().length > 0) {
                sendMessage();
            }
        };

        try {
            recognition.start();
        } catch (e) {
             // Catch error if speech recognition is already active (rare)
            console.error("Speech recognition start error:", e);
        }
    };

    // --- VIEW MANAGEMENT & ENTRY (Uses defined global variables) ---
    const showView = (viewId) => {
        // FIX: Ensure both views are defined before attempting to manipulate them
        if (!loginView || !chatView) {
             // Do not log a CONSOLE_ERROR here, as it might happen during initial load before setupDOMReferences runs fully
             return;
        }
        
        if (viewId === 'login') {
            loginView.style.display = 'flex';
            chatView.style.display = 'none';
        } else {
            loginView.style.display = 'none';
            chatView.style.display = 'flex';
        }
    };

    const initializeChat = () => {
        if (!chatInitialized) {
            // Add the initial welcome message only once
            addMessage("ðŸ‘‹ Hey there! I'm the **Pragati Insight Bot**. I'm here to help you find quick, accurate answers about campus life, admissions, placements, and contacts. What can I get for you today? âœ¨", false);
            
            // Show initial suggestions
            showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);

            chatInitialized = true;
        }
        // FIX: Safely attempt to focus the input only if it exists.
        if (userInput) { 
            userInput.focus();
        }
    };

    const startChat = () => {
        showView('chat');
        initializeChat();
    };

    // Attach 'Enter' key listeners to the document (will be ignored if the input is disabled)
    const handleKeypress = (e) => {
        if (e.key === 'Enter') {
            // If the chat view is active, try to send a message
            if (chatView && chatView.style.display === 'flex' && !sendButton.disabled) {
                sendMessage();
            } 
            // If the login view is active, trigger the chat start
            else if (loginView && loginView.style.display === 'flex') {
                startChat();
            }
        }
    };
    
    // --- NEW FEATURE 1: ACADEMIC ALERT SYSTEM HANDLER ---
    const handleAcademicAlertQuery = async (queryLowerNormalized) => {
        const isResultQuery = /result|marks|grade/i.test(queryLowerNormalized);
        const isMidExamQuery = /mid exam|i mid|ii mid|mid test/i.test(queryLowerNormalized);
        const isEndExamQuery = /end exam|semester exam|final exam|eregistration|examination/i.test(queryLowerNormalized);
        const isFeeQuery = /fee payment|exam fee|tuition fee deadline/i.test(queryLowerNormalized);
        
        let alertType = null;
        let alertTitle = '';
        let queryText = '';
        let officialLink = 'https://pragati.ac.in/examination/';
        let successEmoji = 'âœ…';

        if (isResultQuery) {
            alertType = 'Result';
            alertTitle = 'Latest Exam Results Status';
            queryText = 'latest Pragati Engineering College JNTUK R20/R23 B.Tech exam result release date or link';
            officialLink = 'https://pragati.ac.in/examination/results/';
        } else if (isMidExamQuery) {
            alertType = 'Mid-Exam';
            alertTitle = 'Upcoming Mid-Exam Schedule';
            queryText = 'latest notification for Pragati Engineering College B.Tech Mid-Exam schedule or circular';
        } else if (isEndExamQuery) {
            alertType = 'End-Exam';
            alertTitle = 'End-Exam Registration/Time Table Status';
            queryText = 'latest Pragati Engineering College B.Tech end exam time table or fee notification';
        } else if (isFeeQuery) {
            alertType = 'Fee Payment';
            alertTitle = 'Fee Payment Deadlines';
            queryText = 'latest notification for Pragati Engineering College tuition or examination fee payment deadline';
        } else {
            return null; // Not an academic alert query
        }

        // 1. Run Grounded Search to find the most current date/link
        const contents = [{ role: "user", parts: [{ text: queryText }] }];
        
        let resultFoundText = '';
        let resultStatus = 'NO ACTIVE ALERT'; // Default to inactive
        let statusClass = '';

        try {
            const result = await fetchGeminiResponse(contents, 2, 100, false, false);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const sources = result.candidates?.[0]?.groundingMetadata?.groundingAttributions || [];
            
            if (text && text.length > 0) {
                // Heuristic: If Gemini provides a date, a URL, or mentions "released/announced", assume an active alert.
                if (/(date|link|announced|released|posted|notification|circular|due|available)/i.test(text) || sources.length > 0) {
                    resultStatus = 'ACTIVE ALERT';
                    statusClass = 'active';
                    resultFoundText = text;
                    successEmoji = 'ðŸ””';
                } else {
                    resultFoundText = "I found recent information, but it doesn't indicate an immediate, live announcement. The status is likely: **Not Yet Announced**.";
                }
            } else {
                 resultFoundText = "I couldn't find a recent, official notification online. Please check the college website manually.";
            }

        } catch (e) {
            resultFoundText = `An error occurred while connecting to the official database. Please try again later.`;
            resultStatus = 'CONNECTION ERROR';
            statusClass = '';
            successEmoji = 'âŒ';
        }

        // 2. Build the Alert Card
        const cardHtml = `
            <div class="info-card p-4 bg-white/95 border-2 border-dashed border-[#006494]/50">
                <div class="flex items-center mb-1">
                    <span class="text-3xl text-[#006494] mr-3">${successEmoji}</span>
                    <div>
                        <p class="font-extrabold text-xl text-[#006494] mb-0">${alertTitle}</p>
                        <span class="alert-status ${statusClass}">${resultStatus}</span>
                    </div>
                </div>
                
                <p class="text-sm contact-designation-text mb-2">
                    ${resultFoundText}
                </p>

                <div class="info-divider mt-2 pt-2">
                    <a href="${officialLink}" target="_blank" class="block w-full text-center py-3 bg-[#FF4500] text-white font-extrabold rounded-lg shadow-lg hover:bg-[#CC3700] transition duration-200 button-click-animation text-sm">
                        <span class="mr-1">ðŸ”—</span> GO TO OFFICIAL EXAMINATION PAGE
                    </a>
                </div>
            </div>
        `;
        
        // No conversational redirect needed for this feature.
        conversationFlow = { state: 'idle', targetQuery: null };

        return { success: true, html: cardHtml };
    };
    // --- END NEW FEATURE 1 ---

    // --- API CALL LOGIC WITH EXPONENTIAL BACKOFF ---

    const fetchGeminiResponse = async (contents, maxRetries = 2, delay = 100, isOOC = false, isHostelQuery = false) => { // Added isHostelQuery flag
        
        let systemInstructionText = SYSTEM_PROMPT;
        if (isOOC) {
             systemInstructionText = OOC_REJECTION_PROMPT;
        } else if (isHostelQuery) {
             // CRITICAL: Inject the custom prompt for hostel queries
             systemInstructionText = HOSTEL_OOC_PROMPT;
        }

        const payload = {
            contents: contents,
            systemInstruction: {
                parts: [{ text: systemInstructionText }]
            },
            // --- ADDING GOOGLE SEARCH GROUNDING (Only if not OOC rejection) ---
            tools: isOOC ? [] : [{ "google_search": {} }],
            // -------------------------------------
        };

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 429 || response.status >= 500) {
                    // console.warn(`API call failed (Status: ${response.status}). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; // Slightly less aggressive backoff
                } else {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
            } catch (error) {
                if (i === maxRetries - 1) {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw new Error("I apologize, but I couldn't connect to the server. Please try again later.");
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 1.5;
            }
        }
    };

    // --- MAIN CHAT FUNCTIONALITY ---
    const sendMessage = async (input, userInitiated = true) => {
        const messageText = input || userInput.value.trim();
        // CRITICAL FIX: Normalize the query once at the start for robust matching across ALL handlers
        const queryLower = messageText.toLowerCase().replace(/\s+/g, ' ').trim(); 
        const queryLowerNormalized = queryLower; // Use queryLower as the normalized version since it's already lowercased and trimmed.

        if (!messageText) return;

        if (userInitiated) {
            userInput.value = '';
            sendButton.disabled = true;
            voiceButton.disabled = true;
            addMessage(messageText, true);
        }

        // Clear previous suggestions immediately
        clearSuggestions(); 
        
        // --- LOCAL HANDLER CHECKS (Priority 1) ---
        
        let queryToHandle = messageText;
        if (conversationContext.state === 'awaiting_branch' && userInitiated) {
             // If we were waiting for the branch, append the new message to the original query
             queryToHandle = conversationContext.originalQuery + ' ' + messageText;
             conversationContext = { state: 'idle', originalQuery: null }; // Reset immediately
        }
        
        // --- A. CONVERSATIONAL BRIDGE CHECK (Highest Priority for conversational flow) ---
        if (conversationFlow.state === 'awaiting_redirect') {
            // handleConversationalBridge now returns the target query string to EXECUTE
            const targetQueryString = handleConversationalBridge(queryLower);
            
            if (targetQueryString && targetQueryString.startsWith('Got it!')) {
                 // Denial message
                 hideLoading();
                 addMessage(targetQueryString, false);
                 showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                 return;
            } else if (targetQueryString) {
                // CRITICAL FIX: Execute the stored query recursively, bypassing user initiation
                // This is the solution for the "yes" bug!
                await sendMessage(targetQueryString, false); 
                return;
            }
        }


        // Re-run flags based on the possibly combined/normalized query
        // Already defined: const queryLowerNormalized = queryToHandle.toLowerCase().replace(/\s+/g, ' ').trim();
        const isSyllabusQuery = /syllabus|academic calendar|regulations|course structure/i.test(queryLowerNormalized);
        const isPaperQuery = /previous|question paper|papers|exam|m.tech|b.tech|btech|mtech/i.test(queryLowerNormalized);
        // CRITICAL FIX: Changed timing regex to use use only time/schedule words and remove officer ambiguity.
        const isTimingQuery = /(when|time|schedule|\bhours\b|\bstarts\b|\bends\b)/i.test(queryLowerNormalized);
        
        // NEW INTELLIGENCE CHECK: Is the user asking for subjective info (reviews/quality)?
        const isSubjectiveQuery = /how is|is it good|quality|reviews|tasty|bad/i.test(queryLowerNormalized);
        
        // If it's about Hostel/Food AND it's a subjective query, SKIP local handlers and go straight to AI Fallback
        const isHostelFoodQualityQuery = (queryLowerNormalized.includes('hostel') || queryLowerNormalized.includes('food')) && isSubjectiveQuery;
        
        // NEW INTELLIGENCE CHECK: Is it a general hostel/accommodation query?
        const isGeneralHostelQuery = queryLowerNormalized.includes('hostel') || queryLowerNormalized.includes('accommodation') || queryLowerNormalized.includes('stay');


        const isGeneralCollegeQuery = /admission|fee|fees|tuition|course|branch|stream|affiliate|rank|rating|eligibility/i.test(queryLowerNormalized);
        const wantsContactDetails = /(number|phone|contact|call|line|whatsapp|cell|tell me the)/i.test(queryLowerNormalized) || /hod|principal|dean|warden|discipline officer|admin office|exam section|transport/i.test(queryLowerNormalized); // Explicit roles imply contact
        const isContactNameMentioned = /(hod|principal|dean|warden|discip|officer|professor|technician|admin|assistant|akka|sir|madam|name|staff|attender|guard)/i.test(queryLowerNormalized);
        const isContactQuery = wantsContactDetails || isContactNameMentioned; 
        // CRITICAL PLACEMENT FIX: Only trigger graph for explicit graph/chart request
        const isGraphQueryExplicit = /(graph|chart|comparison|trend)/i.test(queryLowerNormalized);
        // NEW INTELLIGENCE CHECK: For subjective placement queries, trigger AI search
        const isSubjectivePlacementQuery = /(best|worth|is it good|packages)/i.test(queryLowerNormalized) && /(placement|package|salary)/i.test(queryLowerNormalized);
        const isGeneralPlacementQuery = /(package|salary|placement)/i.test(queryLowerNormalized);

        // NEW: ACADEMIC ALERT QUERY (for results, exam fee, mid/end dates)
        const isAcademicAlertQuery = /mid exam|end exam|result|marks|grade|fee payment|tuition fee deadline/i.test(queryLowerNormalized);

        // NEW: OUT OF CONTEXT CHECK
        const isOOCQuery = /weather|movie|recipe|sports|celebrity|news|political|game|joke|song|music|travel|vacation|hobbies|stock|finance|crypto|gossip|general knowledge/i.test(queryLowerNormalized);
        
        try {
            // --- B. GREETING CHECK (NEW FIX: Prevent premature Principal announcement) ---
            if (isGreeting(queryLowerNormalized)) {
                hideLoading();
                const friendlyResponses = [
                    "Hey there! What's up? Ready to find some information! âœ¨",
                    "Hi! What can I help you look up today? ðŸ¤“",
                    "Hello! Ask me anything about Pragati College. I'm here to help! ðŸš€",
                    "Yo! Ask away! ðŸ‘",
                ];
                addMessage(friendlyResponses[Math.floor(Math.random() * friendlyResponses.length)], false);
                showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                return;
            }

            // --- CRITICAL INTELLIGENCE GATE 2: OUT OF CONTEXT REJECTION (OOC) ---
            if (isOOCQuery) {
                showTyping();
                const contents = [{ role: "user", parts: [{ text: "Explain why you cannot answer this query: " + messageText }] }];
                // Force AI to use the rejection prompt and provide a concise reason
                const result = await fetchGeminiResponse(contents, 2, 100, true, false); 
                
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "âŒ I apologize, but my focus is strictly on Pragati Engineering College information. I cannot answer general knowledge or external queries.";
                
                hideLoading();
                addMessage(`**âŒ Out of Scope:** ${botResponse}`, false);
                showSuggestions(["What courses are offered?", "Contact Principal Sir number", "Check latest Placement Trend"]);
                return;
            }


            // --- CRITICAL INTELLIGENCE GATE 1: Subjective Food/Hostel/Placement Queries ---
            if (isHostelFoodQualityQuery || isSubjectivePlacementQuery || isGeneralHostelQuery) {
                // If the query is about subjective opinion (hostel food, etc.), or general hostel/accommodation
                // Fall through to step 8 (General AI Query)
                console.log("INTENT: Subjective or General Hostel query detected. Deferring to Gemini for grounded search.");
            }
            // --- END INTELLIGENCE GATE 1 ---


            // --- C. CONTEXTUAL STAFF FOLLOW-UP (Next Priority) ---
            else if (lastStaffQuery.state !== 'idle' || lastStaffQuery.singleMatchFound) {
                const followUpResult = handleStaffFollowUp(messageText);
                if (followUpResult) {
                    hideLoading();
                    addMessage(followUpResult, false);
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return;
                }
            }
            
            // --- D. NEW CONTACT QUERY DETECTED: FORCE RESET CONTEXT ---
            else if (isContactQuery) {
                lastStaffQuery.singleMatchFound = null; 
            }

            // --- E. GENERAL ROLE QUERY VS. CONTACT REQUEST (Priority 2) ---
            const isGeneralRoleInquiry = /who is|name of|current|former|previous|past/i.test(queryLowerNormalized); 
            const roleKeywords = ['principal', 'hod', 'dean', 'warden', 'discipline officer', 'reception', 'xerox'];
            let asksForRole = roleKeywords.some(role => queryLowerNormalized.includes(role));

            if (asksForRole && isGeneralRoleInquiry && !wantsContactDetails) { 
                
                let roleQueryKey = null;
                 // Tighter check for key roles like Dean CDC or HODs
                 if (queryLower.includes('dean cdc') || (queryLower.includes('dean') && (queryLower.includes('cdc') || queryLower.includes('career')))) {
                     matchedRoleKey = 'dean cdc';
                 } else if (queryLower.includes('hod cse') || (queryLower.includes('hod') && queryLower.includes('cse') && !queryLower.includes('ai&ml') && !queryLower.includes('ds') && !queryLower.includes('(ai)') && !queryLower.includes('(ds)') && !queryLower.includes('(cs)'))) {
                     matchedRoleKey = 'hod cse';
                 } else if (queryLower.includes('hod mech') || queryLower.includes('hod me') || queryLower.includes('hod ma') || (queryLowerNormalized.includes('hod') && (queryLower.includes('mech') || queryLower.includes('mechanical')))) {
                     // NEW FIX: Robust check for HOD Mechanical / ME / MA
                     matchedRoleKey = 'hod mech';
                 } else if (queryLower.includes('hod eee') || (queryLowerNormalized.includes('hod') && queryLower.includes('eee'))) {
                     matchedRoleKey = 'hod eee';
                 } else if (queryLower.includes('discipline officer') || (queryLowerNormalized.includes('discipline') && queryLowerNormalized.includes('officer'))) {
                    // FIX for Discipline Officer name lookup
                    matchedRoleKey = 'discipline officer';
                 } else if (queryLower.includes('hod civil') || (queryLowerNormalized.includes('hod') && queryLower.includes('civil'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod civil';
                 } else if (queryLower.includes('hod ece') || (queryLowerNormalized.includes('hod') && queryLower.includes('ece'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod ece';
                 } else if (queryLower.includes('hod it') || (queryLowerNormalized.includes('hod') && queryLower.includes('it'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod it';
                 } else if (queryLower.includes('hod bsh') || (queryLowerNormalized.includes('hod') && queryLower.includes('bsh'))) { // NEW HOD MATCH
                    matchedRoleKey = 'hod bsh';
                 } else if (queryLower.includes('hod cse (cs)') || queryLower.includes('hod cs') || queryLower.includes('hod cyber')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (cs)';
                 } else if (queryLower.includes('hod cse (ds)') || queryLower.includes('hod ds') || queryLower.includes('hod data science')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ds)';
                 } else if (queryLower.includes('hod cse (ai&ml)') || queryLower.includes('hod aiml')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ai&ml)';
                 } else if (queryLower.includes('hod cse (ai)') || queryLower.includes('hod ai')) { // SPECIALIZATION
                    matchedRoleKey = 'hod cse (ai)';
                 } else {
                     matchedRoleKey = roleKeywords.find(r => queryLowerNormalized.includes(r)); // Use queryLower here
                 }

                 
                 const candidate = VERIFIED_ROLE_NAMES[matchedRoleKey] || null;
                 if(candidate) {
                     hideLoading();
                     addMessage(getGeneralRoleOutput(candidate.name, candidate.designation), false);
                     showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                     return;
                 }
                 // 3. Fallback to Gemini if not locally verified (e.g., 'director')
                 const contents = [{ role: "user", parts: [{ text: messageText + " at Pragati Engineering College" }] }]; 
                 showTyping(); 

                 const result = await fetchGeminiResponse(contents, 2, 100, false, false);
                 
                 const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                 
                 if (botResponse) {
                     hideLoading();
                     addMessage(botResponse, false); 
                     showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                 } else {
                     hideLoading();
                     addMessage("I am having trouble finding that specific piece of general information online right now. Could you please ask for the contact number instead, or check the official college website?", false);
                 }
                 return;
             }
            // --- END GENERAL ROLE INQUIRY ---


            // --- 1. ACADEMIC ALERT CHECK (NEW FEATURE) ---
            if (isAcademicAlertQuery) {
                showTyping();
                const alertResult = await handleAcademicAlertQuery(queryLowerNormalized);
                
                if (alertResult && alertResult.success) {
                    hideLoading();
                    addMessage(`<div>${alertResult.html}</div>`, false);
                    showSuggestions(["Check latest Placement Trend", "Contact Exam Section number"]);
                    return;
                }
                // If failed internally, let it fall through to General AI Query for manual search/error message.
            }

            // --- 2. TIMING CHECK / GENERAL HOSTEL INFO (LOCAL TIMINGS) ---
            if (isTimingQuery && !isHostelFoodQualityQuery) {
                const timingResponse = handleTimingQuery(queryToHandle);
                if (timingResponse) {
                    hideLoading();
                    addMessage(`<div>${timingResponse}</div>`, false);
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return;
                }
            }
            
            // --- 3. GENERAL COLLEGE INFO CHECK (NEW) ---
            if (isGeneralCollegeQuery) {
                const generalResponse = handleGeneralCollegeQuery(queryToHandle);
                if (generalResponse) {
                    hideLoading();
                    addMessage(`<div>${generalResponse}</div>`, false);
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return;
                }
            }


            // --- 4. SYLLABUS CHECK ---
            if (isSyllabusQuery && !isPaperQuery) {
                hideLoading();
                addMessage(`<div>${handleSyllabusQuery()}</div>`, false); 
                 showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                return;
            }


            // --- 5. PREVIOUS PAPERS CHECK ---
            if (isPaperQuery) {
                
                const paperResult = handlePaperQuery(queryToHandle);
                
                if (paperResult.success && paperResult.html) {
                    
                    if (paperResult.isMissingBranch) {
                        conversationContext = { state: 'awaiting_branch', originalQuery: messageText };
                    } else {
                        conversationContext = { state: 'idle', originalQuery: null };
                    }
                    
                    hideLoading();
                    addMessage(`<div>${paperResult.html}</div>`, false);
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return;
                }
                
                conversationContext = { state: 'idle', originalQuery: null }; 
            }
            // --- END PREVIOUS PAPERS CHECK ---
            
            // --- 6. GRAPH CHECK / PLACEMENT FACT CHECK ---
            if (isGraphQueryExplicit) {
                // EXPLICIT graph requested (e.g., "show chart")
                hideLoading();
                showPlacementGraph();
                showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                return;
            } else if (isGeneralPlacementQuery && !isSubjectivePlacementQuery) {
                // GENERAL placement query (e.g., "tell me about placements")
                hideLoading();
                addMessage(`<div>${getPlacementSummary()}</div>`, false);
                showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                return;
            }


            // --- 7. CONTACTS CHECK (PRIMARY SEARCH) ---
            if (wantsContactDetails || (isContactNameMentioned && !isGeneralRoleInquiry)) {
                // CRITICAL FIX: Pass the necessary argument (queryLowerNormalized)
                const localContactResponse = findStaffContactAndManageContext(queryToHandle, queryLowerNormalized);
                
                showTyping(); // Always show typing while the contact logic runs (even if fast)
                hideLoading();
                
                if (localContactResponse && localContactResponse.startsWith('âœ…|')) {
                    addMessage(localContactResponse, false);
                    lastStaffQuery.singleMatchFound = null; 
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return; 
                } else if (localContactResponse) {
                    addMessage(localContactResponse, false); 
                    showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
                    return;
                }
            }
            // --- END CONTACTS CHECK ---
            
            // --- 8. GENERAL AI QUERY (FALLBACK for EVERYTHING else) ---
            // This catches: Subjective Hostel/Food, Subjective Placements, General Accommodation Queries, and anything else.
            const contents = [{ role: "user", parts: [{ text: messageText + " at Pragati Engineering College" }] }];
            showTyping(); 
            
            // Use the isHostelQuery flag for the API call to inject the custom prompt
            const result = await fetchGeminiResponse(contents, 2, 100, false, isGeneralHostelQuery); 
            
            const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (botResponse) {
                if (botResponse.startsWith("I'd be happy to show you you the trend!")) {
                    hideLoading();
                    addMessage(botResponse.replace("I'd be happy to show you the trend!", "I'd be happy to show you the trend! ðŸš€"), false);
                    showPlacementGraph();
                    return; 
                }
                
                hideLoading();
                addMessage(botResponse, false); 
                
                showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);

            } else {
                hideLoading();
                addMessage("Oops! I hit a snag while looking that up. Please try again or rephrase your question. ðŸ¤”", false);
                showSuggestions(SUGGESTION_POOL[Math.floor(Math.random() * SUGGESTION_POOL.length)]);
            }

        } catch (error) {
            console.error("Chat Error:", error);
            hideLoading();
            addMessage(`I am unable to connect to the external information source right now. Please try again in a moment.`, false);
        } finally {
            sendButton.disabled = false;
            voiceButton.disabled = false;
            if (userInput) {
                userInput.focus();
            }
            scrollToBottom();
        }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        setupDOMReferences(); // FIX 1: Defines all required DOM element variables
        applySavedTheme(); // FIX 2: Now defined globally above
        showView('login');
        document.addEventListener('keypress', handleKeypress);
        
        // Ensure suggestion area state is correct on load
        if (suggestionArea) {
             suggestionArea.classList.remove('p-3');
             suggestionArea.style.height = '0';
        }
    };

</script>
</body>
</html>
