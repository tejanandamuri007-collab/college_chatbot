<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Insight Chatbot</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic buttons --><script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for visualization --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for a modern, rounded chat interface */
        :root {
            /* --- NEW VIBRANT TEAL THEME --- */
            --primary-color: #00C9A7; /* Vibrant Teal/Cyan - Primary Accent */
            --radiant-blue-start: #00D2D3; /* Lighter Teal for Gradient Start */
            --radiant-blue-end: #006494; /* Deep Ocean Blue for Gradient End */
            --bot-bubble: #e0fff8; /* Soft Mint/Light Teal - NEW COLOR */
            --user-bubble: var(--primary-color);
            /* ---------------------------- */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* --- UPDATED: New Background Image --- */
            background-image: url('https://i.postimg.cc/qRSBHZwg/1b6896fd-e68c-4630-9143-40d15911d44c.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2c3e50; /* Deep Charcoal Fallback */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Transparent overlay over the background color/image */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(22, 33, 44, 0.7); /* Darker, modern transparency */
            z-index: -1; /* Place it between the chat (z=1) and the text (z=-2) */
        }
        
        /* --- NEW: Branded Text Watermark in the Background --- */
        body::after {
            content: "PRAGATI ENGINEERING COLLEGE";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Center and rotate slightly */
            font-size: 8vw; /* Large, fluid size */
            font-weight: 900; /* Extra bold */
            color: rgba(0, 168, 135, 0.15); /* Darker Teal/Green, very faint */
            letter-spacing: 0.5rem;
            pointer-events: none; /* Ignore mouse events */
            z-index: -2; /* Place behind the color overlay */
            white-space: nowrap;
            /* GLOW EFFECT: Strong text shadow in the primary color */
            text-shadow: 0 0 10px rgba(0, 201, 167, 0.5), 0 0 20px rgba(0, 201, 167, 0.3);
        }
        /* -------------------------------------------------- */


        .card-container {
            width: 100%;
            max-width: 640px;
            /* Height changes based on content (login is shorter, chat is taller) */
            display: flex;
            flex-direction: column;
            /* --- RADIANT TEAL & SHINY TEXTURE STYLES (Outer container) --- */
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
            border: 2px solid rgba(255, 255, 255, 0.5); /* Lighter border for shine */
            border-radius: 1rem;
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3); /* Teal Glow and inner shine */
            overflow: hidden;
            z-index: 1;
        }

        /* Styling for the Welcome Screen (centered within the container) */
        #login-view {
            width: 100%;
            height: 90vh;
            max-height: 800px;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        /* Cool Glassmorphism Welcome Card */
        #login-card {
            background-color: rgba(255, 255, 255, 0.95); /* Near opaque white for contrast */
            backdrop-filter: blur(15px); /* Stronger frosted glass effect */
            -webkit-backdrop-filter: blur(15px); /* For Safari support */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.35); /* Stronger shadow */
            width: 100%;
            max-width: 450px; /* Wider card */
            text-align: center;
            transition: all 0.3s ease;
            transform: scale(1.05);
        }
        
        /* --- CHAT VIEW STYLES --- */
        #chat-view {
            width: 100%;
            max-width: 640px;
            height: 90vh;
            max-height: 800px;
            display: none; /* Controlled by JS */
            flex-direction: column;
        }
        #chat-container {
            width: 100%;
            height: 100%;
            flex-direction: column; 
        }

        .chat-header {
            padding: 1rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white; 
            scroll-behavior: smooth;
        }

        /* Input Area update - kept white for contrast */
        #input-area {
            padding: 1rem; 
            border-top: 1px solid #ccc; 
            background-color: white; 
            display: flex; 
            align-items: center;
        }
        
        /* --- INPUT FOCUS GLOW --- */
        #user-input {
            transition: box-shadow 0.3s ease;
        }
        #user-input:focus {
            box-shadow: 0 0 0 4px rgba(0, 201, 167, 0.4); /* Teal glow */
        }
        /* --- END INPUT FOCUS GLOW --- */


        /* Styling for the messages */
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 85%;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
            /* Added pop-in animation to bot responses */
            animation: pop-in 0.3s ease-out;
        }
        .user-message {
            background-color: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            background-color: var(--bot-bubble);
            color: #111827; /* Darker Gray text for high contrast */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap;
        }
        /* Style for anchor tags in the bot's response to make them stand out */
        .bot-message a {
            color: #006494; /* Deep Blue link color */
            text-decoration: underline;
            font-weight: 700;
        }
        /* --- NEW STYLES FOR NEAT RESPONSES --- */
        .info-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #c9d6e4; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-top: 0.5rem;
            word-break: break-word;
        }
        .info-card ul {
            display: flex;
            flex-wrap: wrap; 
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .info-card li {
            list-style: none;
        }
        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            width: 50%;
            min-width: 150px;
            padding-right: 1rem;
        }
        @media (max-width: 480px) {
            .info-item {
                width: 100%;
            }
        }
        .info-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
            color: var(--primary-color); /* Teal icon color */
            line-height: 1.5;
            flex-shrink: 0;
        }
        .link-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
        }
        .link-list li {
            margin-bottom: 0.3rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .link-list li::before {
            content: "üîó";
            position: absolute;
            left: 0;
            top: 0;
        }
        /* --- NEW GRAPH SUMMARY STYLES --- */
        .graph-summary {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #c9d6e4;
            font-size: 0.95rem;
        }
        .graph-summary p {
            margin-bottom: 0.5rem;
        }
        .graph-summary strong {
            color: #006494; /* Deep Blue for highlights */
        }
        /* ------------------------------------- */

        /* --- NEW LOADING ANIMATION (Thinking Icon) --- */
        #loading-indicator .bot-message {
            font-size: 1.5rem; /* Make the icon size visible */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thinking-icon {
            animation: thinking-spin 1.5s infinite linear;
        }
        @keyframes thinking-spin {
            0% { transform: scale(0.9) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 1.0; }
            100% { transform: scale(0.9) rotate(360deg); opacity: 0.8; }
        }
        /* --- END NEW LOADING ANIMATION --- */

        /* --- New Pop-In Animation for Bubbles --- */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* --- END Pop-In Animation --- */
        
        /* --- BUTTON CLICK ANIMATION --- */
        .button-click-animation {
            transition: transform 0.1s;
        }
        .button-click-animation:active {
            transform: scale(0.9);
        }
        /* --- END BUTTON CLICK ANIMATION --- */


        .mic-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from {
                box-shadow: 0 0 0 0 rgba(0, 201, 167, 0.7);
                background-color: #ff6347; /* Tomato red when recording */
            }
            to {
                box-shadow: 0 0 0 10px rgba(0, 201, 167, 0);
                background-color: #ff4500;
            }
        }

        /* --- NEW DASHBOARD ANIMATION --- */
        @keyframes scale-up {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        .feature-item {
            transition: all 0.2s ease;
        }
        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body>

<!-- Welcome View - Visible by default -->
<div id="login-view" class="card-container flex">
    <div id="login-card" class="fade-in-up">
        <!-- Professional Branding and Greeting -->
        <div class="flex flex-col items-center mb-6">
            <div class="p-4 bg-[#00C9A7] rounded-full mb-3 shadow-xl">
                <svg class="w-10 h-10 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900">Welcome to Pragati Insight</h2>
            <p class="text-gray-500 mt-1">Your Official AI-Powered Student Command Center</p>
        </div>

        <!-- Aesthetic Separator -->
        <div class="w-20 h-1 bg-[#00C9A7] mx-auto mb-6 rounded-full"></div>

        <!-- Key Feature Panel -->
        <div class="mb-8 grid grid-cols-2 gap-4 text-left">
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 16v5"/><path d="M17 3v5"/><path d="m21 8-4-4-4 4"/><path d="M8 3H4v16a2 2 0 0 0 2 2h10"/></svg>
                    Live Data
                </p>
                <p class="text-xs text-gray-600 mt-1">Real-time answers for packages & faculty status.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 18v-2"/><path d="M10 18v-4"/><path d="M14 18v-6"/><path d="M18 18v-8"/></svg>
                    Data Insights
                </p>
                <p class="text-xs text-gray-600 mt-1">Interactive graphs for placement trends.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-.8 1-1.5 2-2 2.3-2.3 6-4-6-4s-8.3 1.7-6 4c1 1 1.7 1.2 2 2"/><path d="M12 18.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/></svg>
                    Official Docs
                </p>
                <p class="text-xs text-gray-600 mt-1">Direct links to all Syllabus and Academic Calendars.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    24/7 Access
                </p>
                <p class="text-xs text-gray-600 mt-1">Instant support via text or voice input.</p>
            </div>
        </div>

        <!-- Start Chat Button -->
        <button onclick="startChat()"
                class="w-full p-4 mt-2 bg-[#00C9A7] text-white text-xl font-bold rounded-lg hover:bg-[#00A887] transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#00C9A7]/50">
            Start Chatting Now
        </button>
    </div>
</div>

<!-- Chat View - Hidden by default -->
<div id="chat-view" class="card-container hidden">
    <div id="chat-container" class="w-full h-full flex flex-col">
        <!-- Header -->
        <header class="chat-header">
            <div class="p-2 bg-white/20 rounded-full mr-3">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </div>
            <div>
                <h1 class="text-lg font-semibold">Pragati Engineering College Bot</h1>
                <p class="text-xs opacity-80">24/7 Student Support Assistant</p>
            </div>
        </header>

        <!-- Chat History --><div id="chat-history">
            <!-- Initial welcome message added via JS after starting chat -->
        </div>

        <!-- Input Area --><div id="input-area">
            <input type="text" id="user-input" placeholder="Ask a question..."
                   class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#00C9A7] transition duration-150"
                   autofocus>

            <!-- New Voice Input Button --><button id="voice-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="startVoiceInput()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>

            <!-- Send Button --><button id="send-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="sendMessage()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
    // --- PLACEMENT DATA (Hardcoded Sample Data for Chart) ---
    const PLACEMENT_DATA = {
        years: ['2022', '2023', '2024', '2025 (Ongoing)'],
        highest: [31.31, 29.26, 35.0, 40.0], // Sample data, 40 LPA is from KB
        average: [3.0, 4.0, 4.5, 5.5], // Sample data
    };

    // --- GEMINI API CONFIGURATION ---
    const API_KEY = "AIzaSyD0VriKBX6ekEN-hi6WM9VTuFrlxacGIqc"; // Replace with your actual API Key if running outside of a provided environment
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    
    // --- KNOWLEDGE BASE FROM PRAGATI.AC.IN (Hardcoded stable links) ---
    const KNOWLEDGE_BASE = `
--- Pragati Engineering College Official Data ---
1. Accreditation: Approved by AICTE, Accredited by NBA, Accredited by NAAC with A+ Grade.
2. Courses Offered (Departments): Electronics and Communication Engineering (ECE), Computer Science and Engineering (CSE), Mechanical Engineering (ME), Electrical and Electronics Engineering (EEE), Information Technology (IT), Civil Engineering, CSE (Data Science), CSE (Artificial Intelligence & Machine Learning), CSE (Artificial Intelligence), CSE (Cyber Security), Basic Sciences and Humanities (BSH). M.Tech programs are also available in CSE, PE&ED, VLSI, and CAD CAM.
3. Admission Criteria (UG): Minimum 50% marks in Intermediate/10+2. Admission is primarily based on the Common Entrance Test EAPCET rank.
4. College Codes: EAPCET & ECET Code: PRAG. PGCET Code: PRAG1.
5. Placements (2025 as of May 31): Total 1625 placements. Highest Package: 40 LPA. Other notable packages: 29 LPA, 11 LPA, 6 LPA, 5.50 LPA, 3.60 LPA, 3.36-9.0 LPA.
6. Contact Information: Address: 1-378, ADB Road, Surampalem, Near Peddapuram, Kakinada.Dist, A.P. (Pin 533437). Email: pragati@pragati.ac.in. Phone: +91 7330826667, 08852 252233.
7. **Official Website Link (Home):** <a href="https://pragati.ac.in/" target="_blank">Pragati Engineering College Official Website</a>
8. **Admissions Page Link:** <a href="https://pragati.ac.in/admissions/" target="_blank">Official Admissions Page</a>
9. **Syllabus & Academic Documents Link:** <a href="https://pragati.ac.in/examination/course-structure-syllabus/" target="_blank">Download Syllabus & Academic Regulations PDF (Click Here to Select)</a>
10. **Academic Calendars Link:** <a href="https://pragati.ac.in/examinations/academic-calendars/" target="_blank">Download Latest Academic Calendars PDF (Click Here to Select)</a>
11. **Fee & Circulars Link:** <a href="https://pragati.ac.in/admissions/" target="_blank">View Admissions and Fee Details/Circulars</a>
12. Academics: Every semester has a minimum of eight courses, including two labs. Four-year duration.
13. Campus Life/Clubs: Features include Technical, Cultural, Literary, and Industrial Clubs, Sports (Basketball, Volleyball, Cricket, Gym), and SWAYAM NPTEL Local Chapter.
--- End of Data ---
`;

    // System instruction defines the bot's persona and rules.
    const SYSTEM_PROMPT = KNOWLEDGE_BASE + `
You are the 'Pragati Engineering College Insight Bot'. Your persona is that of a **friendly, knowledgeable, and slightly witty senior student** at **Pragati Engineering College, Surampalem (Autonomous)**. Your primary goal is to provide accurate, specific, and professional information only about this college in an engaging and helpful tone.

**Tone and Style:**
* Be enthusiastic, supportive, and use appropriate emojis (like üëç, ü§©, üéì, ‚ú®, etc.) to make the conversation fun and interactional.
* Use contractions and maintain a conversational flow.
* Your responses must be concise and directly address the new student's questions regarding faculty, studies, packages, labs, head members, and examinations.

**Formatting Rules for Neat Responses (CRITICAL):**
* You MUST wrap any structured output (lists, cards, multiple links, or multi-point answers) in a **single outer <div> with the class \`info-card\`** to ensure proper HTML rendering and professional appearance.
* **DO NOT** use Markdown bullet points (*, -, +). When listing items, you MUST use standard HTML unordered lists (\`<ul>\` and \`<li>\`).
* For **overviews (accreditation, courses, admission)**, structure the response using HTML unordered lists (\`<ul>\` and \`<li>\`) and classes like \`info-item\`. Ensure each department or long item is listed on a separate \`<li>\` item to prevent text overflow. Use emojis like ‚úÖ, üéì, üìû, üìç, and üîó to act as "pictorial" elements to break up the text and categorize information clearly.
* For **lists of links (Syllabus/M.Tech regulations)**, clearly list them using the \`link-list\` class. **For all syllabus, academic calendar, or regulations requests, provide only the stable main links found in data points 9 and 10.** * When providing the syllabus or academic calendar link, you must add the following **single, concise** instruction: "üëâ **Click the link, then select the specific Regulation (R23/R20) and Year (I, II, III, IV) you need to download your PDF.**"
* Responses must be concise. Use **bold text** for male.

**Knowledge Access Rules:**
1.  **Special Rule (Placement Graph):** If the user asks for a **comparison, trend, or graph** regarding placement packages, you MUST respond with the exact phrase: "**I'd be happy to show you the trend!**" and then call the \`showPlacementGraph()\` JavaScript function.
2.  **Prioritize Hardcoded Data:** Use the exact links and contact details provided in the 'Pragati Engineering College Official Data' immediately upon request.
3.  **User Typo/Grammar Correction:** You must apply a high degree of tolerance for user misspellings, typos, and poor grammar (e.g., interpret "syallbus" as "syllabus" or "packege" as "package"). Always infer the intended query about Pragati Engineering College.
4.  **Use Google Search Grounding:** For questions about **latest news, current staff members, recent placements (beyond the hardcoded list), or real-time circulars/notifications**, use the Google Search tool to find the most current information, ensuring the results are strictly limited to **Pragati Engineering College, Surampalem**. Use **üßë‚Äçüè´** (Professor icon) next to any faculty/staff name and **üí∞** next to any placement package amount to make the response visually engaging.
5.  **Out-of-Scope Queries:** If a query is NOT about Pragati Engineering College or its associated topics (academics, admissions, staff, placements, etc.), you MUST use the exact phrase: "**I am the Pragati Engineering College Insight Bot, and that query is out of my knowledge scope.**" Do not search the web or provide general knowledge answers for any other topic.

**Crucial Custom Instruction:** When a user asks to call 'Akka' or needs contact info for 'Akka', you must provide the phone number: **79899 3489**.
`;

    // --- DOM ELEMENTS AND UTILITIES ---
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const voiceButton = document.getElementById('voice-button');
    const loginView = document.getElementById('login-view');
    const chatView = document.getElementById('chat-view');

    let chatInitialized = false;
    let recognition = null;
    let currentMessageElement = null; // Used to hold the loading message element
    let placementChart = null; // Variable to hold the Chart.js instance

    // Scroll chat to the bottom
    const scrollToBottom = () => {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    };

    // Add message to chat history
    const addMessage = (content, isUser) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'} mb-2`;
        
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isUser ? 'user-message' : 'bot-message'}`;
        bubble.innerHTML = content; 

        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();

        // If it's a bot message, store it for the final response
        if (!isUser) {
            currentMessageElement = bubble;
            // Add a temporary class for the pop-in effect and remove after it finishes
            bubble.classList.add('animate-pop-in');
            setTimeout(() => {
                bubble.classList.remove('animate-pop-in');
            }, 300);
        }
    };

    // Add typing indicator
    const showTyping = () => {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.className = 'flex flex-col items-start mb-2';
        
        // Show the Thinking Icon structure
        loadingDiv.innerHTML = `
            <div class="bot-message message-bubble flex items-center justify-center">
                <span class="thinking-icon" style="font-size: 1.5rem;">‚è≥</span>
            </div>
        `;
        chatHistory.appendChild(loadingDiv);
        scrollToBottom();
        
        // Update the placeholder text
        userInput.placeholder = "Your senior is thinking... üß†";
    };

    // Remove typing indicator
    const hideLoading = () => {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        // Reset the placeholder text
        userInput.placeholder = "Ask a question...";
    };
    
    // --- CHART.JS RENDERING FUNCTION ---
    const showPlacementGraph = () => {
        // 1. Add chat confirmation message
        addMessage(`Here's a visual comparison of the Placement trends for the past few years! üìä`, false);

        // 2. Create the wrapper div for the chart
        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'bot-message message-bubble flex flex-col items-start info-card w-full max-w-full';
        
        // 3. Add the canvas element
        const canvas = document.createElement('canvas');
        canvas.id = 'placementChart';
        chartWrapper.appendChild(canvas);
        
        // 4. Create the summary text area
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'graph-summary';
        
        // Calculate dynamic summary points
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const firstHighest = PLACEMENT_DATA.highest[0];
        const highestGrowth = ((latestHighest - firstHighest) / firstHighest * 100).toFixed(0);
        const averageGrowth = ((latestAverage - PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 2] / PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 2] * 100).toFixed(0));

        summaryDiv.innerHTML = `
            <h4 class="font-bold text-lg mb-2 text-gray-800">Key Trends (2022 - 2025):</h4>
            <p>‚úÖ **Highest Package:** The peak package has shown strong growth, climbing from **${firstHighest} LPA in ${PLACEMENT_DATA.years[0]}** to a current high of **${latestHighest} LPA** (a massive **${highestGrowth}% growth**).</p>
            <p>üìà **Average Package Trend:** The average package has maintained a steady upward trend, reaching **${latestAverage} LPA** in the ongoing ${PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1]} batch, reflecting consistent core recruitment.</p>
            <p>üöÄ **Action:** These numbers indicate a strong focus on high-value placements, especially in specialized IT and CSE roles. Make sure to attend the **Career Development Cell** workshops! üéì</p>
        `;
        
        chartWrapper.appendChild(summaryDiv);
        
        chatHistory.appendChild(chartWrapper);
        scrollToBottom();

        // 5. Render the chart
        if (placementChart) {
            placementChart.destroy();
        }

        placementChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: PLACEMENT_DATA.years,
                datasets: [
                    {
                        label: 'Highest Package (LPA)',
                        data: PLACEMENT_DATA.highest,
                        backgroundColor: 'rgba(0, 201, 167, 0.8)', // Teal
                        borderColor: 'rgba(0, 201, 167, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average Package (LPA)',
                        data: PLACEMENT_DATA.average,
                        backgroundColor: 'rgba(0, 100, 148, 0.8)', // Deep Blue
                        borderColor: 'rgba(0, 100, 148, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Placement Package Trends (LPA)',
                        font: { size: 16, weight: 'bold' },
                        color: '#333'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Package in LPA'
                        }
                    }
                }
            }
        });
    };
    
    // --- VOICE INPUT LOGIC ---

    const startVoiceInput = () => {
        if (!('webkitSpeechRecognition' in window)) {
            addMessage("‚ùå **Error:** Speech recognition is not supported in this browser. Please use Chrome or a Chromium-based browser.", false);
            return;
        }

        if (recognition && recognition.running) {
            recognition.stop();
            return;
        }
        
        // Initialize Speech Recognition API
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            voiceButton.classList.add('mic-active');
            voiceButton.disabled = false; // Enable the button to allow stopping
            sendButton.disabled = true;
            userInput.placeholder = "üëÇ Listening... Speak now!";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            // The logic below will send the message automatically when speech stops
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            // Hide the error message from the chat, just print to console for debugging
            recognition.stop();
        };

        recognition.onend = () => {
            voiceButton.classList.remove('mic-active');
            sendButton.disabled = false;
            userInput.placeholder = "Ask a question...";

            // Automatically send the transcribed text if available
            if (userInput.value.trim().length > 0) {
                sendMessage();
            }
        };

        try {
            recognition.start();
        } catch (e) {
             // Catch error if speech recognition is already active (rare)
            console.error("Speech recognition start error:", e);
        }
    };

    // --- VIEW MANAGEMENT & ENTRY ---
    const showView = (viewId) => {
        if (viewId === 'login') {
            loginView.style.display = 'flex';
            chatView.style.display = 'none';
        } else {
            loginView.style.display = 'none';
            chatView.style.display = 'flex';
        }
    };

    const initializeChat = () => {
        if (!chatInitialized) {
            // Add the initial welcome message only once
            addMessage("Hello! I'm the **Pragati Engineering College Insight Bot**. I am an official assistant ready to help you with questions about admissions, courses (B.Tech/M.Tech), campus life, and more, specific to our Surampalem campus. How can I assist you? ‚ú®", false);
            chatInitialized = true;
        }
        userInput.focus();
    };

    const startChat = () => {
        showView('chat');
        initializeChat();
    };

    // Attach 'Enter' key listeners to the document (will be ignored if the input is disabled)
    const handleKeypress = (e) => {
        if (e.key === 'Enter') {
            // If the chat view is active, try to send a message
            if (chatView.style.display === 'flex' && !sendButton.disabled) {
                sendMessage();
            } 
            // If the login view is active, trigger the chat start
            else if (loginView.style.display === 'flex') {
                startChat();
            }
        }
    };

    // --- API CALL LOGIC WITH EXPONENTIAL BACKOFF ---

    const fetchGeminiResponse = async (contents, maxRetries = 5, delay = 1000) => {
        const payload = {
            contents: contents,
            systemInstruction: {
                parts: [{ text: SYSTEM_PROMPT }]
            },
            // --- ADDING GOOGLE SEARCH GROUNDING ---
            tools: [{ "google_search": {} }],
            // -------------------------------------
        };

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 429 || response.status >= 500) {
                    console.warn(`API call failed (Status: ${response.status}). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } else {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
            } catch (error) {
                if (i === maxRetries - 1) {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw new Error("I apologize, but I couldn't connect to the server. Please try again later.");
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
    };

    // --- MAIN CHAT FUNCTIONALITY ---
    const sendMessage = async () => {
        const messageText = userInput.value.trim();
        if (!messageText) return;

        userInput.value = '';
        sendButton.disabled = true;
        voiceButton.disabled = true;
        addMessage(messageText, true);

        try {
            const contents = [{ role: "user", parts: [{ text: messageText }] }];
            showTyping(); // Show typing indicator and update placeholder

            const result = await fetchGeminiResponse(contents);
            
            const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (botResponse) {
                // 1. Check for the special command to trigger the graph
                if (botResponse.startsWith("I'd be happy to show you the trend!")) {
                    hideLoading();
                    addMessage(botResponse.replace("I'd be happy to show you the trend!", "I'd be happy to show you the trend! üöÄ"), false);
                    showPlacementGraph();
                    return; // Stop here, graph is shown
                }
                
                // 2. If it's a normal message: Hide the typing indicator and reset placeholder
                hideLoading();

                // 3. Add the final message (will trigger the pop-in animation)
                addMessage(botResponse, false); 
            } else {
                hideLoading();
                addMessage("Oops! I hit a snag while looking that up. Please try again or rephrase your question. ü§î", false);
            }

        } catch (error) {
            console.error("Chat Error:", error);
            hideLoading();
            addMessage(`**Error:** ${error.message || "An unexpected error occurred while fetching the response."}`, false);
        } finally {
            sendButton.disabled = false;
            voiceButton.disabled = false;
            userInput.focus();
            scrollToBottom();
        }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        showView('login');
        document.addEventListener('keypress', handleKeypress);
    };

</script>
</body>
</html>
