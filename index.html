<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Insight Chatbot</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic buttons --><script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for visualization --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for a modern, rounded chat interface */
        :root {
            /* --- NEW VIBRANT TEAL THEME --- */
            --primary-color: #00C9A7; /* Vibrant Teal/Cyan - Primary Accent */
            --radiant-blue-start: #00D2D3; /* Lighter Teal for Gradient Start */
            --radiant-blue-end: #006494; /* Deep Ocean Blue for Gradient End */
            --bot-bubble: #e0fff8; /* Soft Mint/Light Teal - NEW COLOR */
            --user-bubble: var(--primary-color);
            /* ---------------------------- */
        }
        
        /* --- DARK MODE VARIABLES AND BASE STYLES --- */
        .dark {
            --background-color: #121212; /* Deep Dark Background */
            --surface-color: #1f1f1f; /* Darker Surface */
            --bot-bubble: #333333; /* Darker grey for bot bubble */
            --text-color: #e0e0e0;
            --link-color: #00D2D3;
        }

        .dark body {
            background-color: var(--background-color);
            background-image: none; /* Remove bright background image in dark mode */
            color: var(--text-color);
        }

        .dark body::before {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .dark body::after {
            color: rgba(0, 168, 135, 0.08); /* Fainter watermark */
        }

        .dark .card-container {
            background: linear-gradient(145deg, var(--radiant-blue-end) 0%, var(--radiant-blue-start) 100%); /* Reverse gradient for visual distinction */
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.3); /* Softer glow */
        }

        .dark #login-card {
            background-color: rgba(31, 31, 31, 0.95);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
        }

        .dark h2, .dark p, .dark .feature-item p, .dark .chat-header h1, .dark .chat-header p, .dark .graph-summary h4, .dark .graph-summary p {
            color: var(--text-color); /* Light text color for dark mode */
        }
        .dark .feature-item {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
        }
        /* --- END DARK MODE BASE STYLES --- */

        body {
            font-family: 'Inter', sans-serif;
            /* --- UPDATED: New Background Image --- */
            background-image: url('https://i.postimg.cc/qRSBHZwg/1b6896fd-e68c-4630-9143-40d15911d44c.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2c3e50; /* Deep Charcoal Fallback */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Transparent overlay over the background color/image */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(22, 33, 44, 0.7); /* Darker, modern transparency */
            z-index: -1; /* Place it between the chat (z=1) and the text (z=-2) */
        }
        
        /* --- NEW: Branded Text Watermark in the Background --- */
        body::after {
            content: "PRAGATI ENGINEERING COLLEGE";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Center and rotate slightly */
            font-size: 8vw; /* Large, fluid size */
            font-weight: 900; /* Extra bold */
            color: rgba(0, 168, 135, 0.15); /* Darker Teal/Green, very faint */
            letter-spacing: 0.5rem;
            pointer-events: none; /* Ignore mouse events */
            z-index: -2; /* Place behind the color overlay */
            white-space: nowrap;
            /* GLOW EFFECT: Strong text shadow in the primary color */
            text-shadow: 0 0 10px rgba(0, 201, 167, 0.5), 0 0 20px rgba(0, 201, 167, 0.3);
        }
        /* -------------------------------------------------- */


        .card-container {
            width: 100%;
            max-width: 640px;
            /* Height changes based on content (login is shorter, chat is taller) */
            display: flex;
            flex-direction: column;
            /* --- RADIANT TEAL & SHINY TEXTURE STYLES (Outer container) --- */
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
            border: 2px solid rgba(255, 255, 255, 0.5); /* Lighter border for shine */
            border-radius: 1rem;
            box-shadow: 0 0 40px rgba(0, 201, 167, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3); /* Teal Glow and inner shine */
            overflow: hidden;
            z-index: 1;
        }

        /* Styling for the Welcome Screen (centered within the container) */
        #login-view {
            width: 100%;
            height: 90vh;
            max-height: 800px;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        /* Cool Glassmorphism Welcome Card */
        #login-card {
            background-color: rgba(255, 255, 255, 0.95); /* Near opaque white for contrast */
            backdrop-filter: blur(15px); /* Stronger frosted glass effect */
            -webkit-backdrop-filter: blur(15px); /* For Safari support */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.35); /* Stronger shadow */
            width: 100%;
            max-width: 450px; /* Wider card */
            text-align: center;
            transition: all 0.3s ease;
            transform: scale(1.05);
        }
        
        /* --- CHAT VIEW STYLES --- */
        #chat-view {
            width: 100%;
            max-width: 640px;
            height: 90vh;
            max-height: 800px;
            display: none; /* Controlled by JS */
            flex-direction: column;
        }
        #chat-container {
            width: 100%;
            height: 100%;
            flex-direction: column; 
        }

        .chat-header {
            padding: 1rem; 
            color: white; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, var(--radiant-blue-start) 0%, var(--radiant-blue-end) 100%);
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white; 
            scroll-behavior: smooth;
        }
        .dark #chat-history {
            background-color: var(--surface-color);
        }

        /* Input Area update - kept white for contrast */
        #input-area {
            padding: 1rem; 
            border-top: 1px solid #ccc; 
            background-color: white; 
            display: flex; 
            align-items: center;
        }
        .dark #input-area {
            background-color: var(--surface-color);
            border-top-color: #333;
        }

        /* --- NEW SUGGESTION BUTTON STYLES (Restored) --- */
        .suggestion-button {
            padding: 0.5rem 1rem;
            background-color: #f0fdfa; /* Lightest Teal/Mint */
            border: 1px solid #00C9A7;
            color: #006494; /* Deep Blue text for visibility */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px; /* Full rounded corners */
            cursor: pointer;
            transition: all 0.2s ease;
            transform: scale(0.95);
        }
        .suggestion-button:hover {
            background-color: #00C9A7;
            color: white;
            transform: scale(1.0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .dark .suggestion-button {
            background-color: #2e2e2e;
            border-color: #006494;
            color: #00C9A7;
        }
        .dark .suggestion-button:hover {
            background-color: #00A887;
            color: #1f1f1f;
        }
        /* --- END SUGGESTION STYLES --- */
        
        /* --- INPUT FOCUS GLOW --- */
        #user-input {
            transition: box-shadow 0.3s ease;
        }
        #user-input:focus {
            box-shadow: 0 0 0 4px rgba(0, 201, 167, 0.4); /* Teal glow */
        }
        .dark #user-input {
            background-color: #333;
            color: white;
            border-color: #555;
        }
        /* --- END INPUT FOCUS GLOW --- */


        /* Styling for the messages */
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 85%;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
            /* Added pop-in animation to bot responses */
            animation: pop-in 0.3s ease-out;
        }
        .user-message {
            background-color: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            background-color: var(--bot-bubble);
            color: #111827; /* Darker Gray text for high contrast */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap;
        }
        .dark .bot-message {
            background-color: var(--bot-bubble); /* Darker bot bubble */
            color: var(--text-color); /* Light text in dark mode */
        }

        /* Style for anchor tags in the bot's response to make them stand out */
        .bot-message a {
            color: #006494; /* Deep Blue link color */
            text-decoration: underline;
            font-weight: 700;
        }
        .dark .bot-message a {
            color: var(--link-color);
        }

        /* --- NEW STYLES FOR NEAT RESPONSES --- */
        .info-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #c9d6e4; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-top: 0.5rem;
            word-break: break-word;
        }
        .dark .info-card {
            background-color: #2e2e2e; /* Slightly lighter surface for nested card */
            border-color: #555;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .info-card ul {
            display: flex;
            flex-wrap: wrap; 
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .info-card li {
            list-style: none;
        }
        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            width: 50%;
            min-width: 150px;
            padding-right: 1rem;
        }
        @media (max-width: 480px) {
            .info-item {
                width: 100%;
            }
        }
        .info-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
            color: var(--primary-color); /* Teal icon color */
            line-height: 1.5;
            flex-shrink: 0;
        }
        .link-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
        }
        .link-list li {
            margin-bottom: 0.3rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .link-list li::before {
            content: "ðŸ”—";
            position: absolute;
            left: 0;
            top: 0;
        }
        /* --- NEW GRAPH SUMMARY STYLES --- */
        .graph-summary {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #c9d6e4;
            font-size: 0.95rem;
        }
        .dark .graph-summary {
            border-top-color: #555;
        }
        .graph-summary p {
            margin-bottom: 0.5rem;
        }
        .graph-summary strong {
            color: #006494; /* Deep Blue for highlights */
        }
        .dark .graph-summary strong {
            color: #00D2D3; /* Lighter highlight in dark mode */
        }
        /* ------------------------------------- */

        /* --- NEW LOADING ANIMATION (Thinking Icon) --- */
        #loading-indicator .bot-message {
            font-size: 1.5rem; /* Make the icon size visible */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thinking-icon {
            animation: thinking-spin 1.5s infinite linear;
        }
        @keyframes thinking-spin {
            0% { transform: scale(0.9) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 1.0; }
            100% { transform: scale(0.9) rotate(360deg); opacity: 0.8; }
        }
        /* --- END NEW LOADING ANIMATION --- */

        /* --- New Pop-In Animation for Bubbles --- */
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* --- END Pop-In Animation --- */
        
        /* --- BUTTON CLICK ANIMATION --- */
        .button-click-animation {
            transition: transform 0.1s;
        }
        .button-click-animation:active {
            transform: scale(0.9);
        }
        /* --- END BUTTON CLICK ANIMATION --- */


        .mic-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from {
                box-shadow: 0 0 0 0 rgba(0, 201, 167, 0.7);
                background-color: #ff6347; /* Tomato red when recording */
            }
            to {
                box-shadow: 0 0 0 10px rgba(0, 201, 167, 0);
                background-color: #ff4500;
            }
        }

        /* --- NEW DASHBOARD ANIMATION --- */
        @keyframes scale-up {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        .feature-item {
            transition: all 0.2s ease;
        }
        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body>

<!-- Welcome View - Visible by default -->
<div id="login-view" class="card-container flex">
    <div id="login-card" class="fade-in-up">
        <!-- Professional Branding and Greeting -->
        <div class="flex flex-col items-center mb-6">
            <div class="p-4 bg-[#00C9A7] rounded-full mr-3">
                <!-- START: Replaced Microphone SVG with the provided Image URL -->
                <img src="https://i.postimg.cc/B6v57Wfn/1727246051php-AX4sq7.jpg" 
                     alt="Pragati College Emblem" 
                     class="w-10 h-10 object-contain"
                     onerror="this.onerror=null; this.src='https://placehold.co/40x40/00C9A7/ffffff?text=LOGO'">
                <!-- END: Replaced Microphone SVG with the provided Image URL -->
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900">Welcome to Pragati Insight</h2>
            <p class="text-gray-500 mt-1">Your Official AI-Powered Student Command Center</p>
        </div>

        <!-- Aesthetic Separator -->
        <div class="w-20 h-1 bg-[#00C9A7] mx-auto mb-6 rounded-full"></div>

        <!-- Key Feature Panel -->
        <div class="mb-8 grid grid-cols-2 gap-4 text-left">
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 16v5"/><path d="M17 3v5"/><path d="m21 8-4-4-4 4"/><path d="M8 3H4v16a2 2 0 0 0 2 2h10"/></svg>
                    Live Data
                </p>
                <p class="text-xs text-gray-600 mt-1">Real-time answers for packages & faculty status.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><path d="M6 18v-2"/><path d="M10 18v-4"/><path d="M14 18v-6"/><path d="M18 18v-8"/></svg>
                    Data Insights
                </p>
                <p class="text-xs text-gray-600 mt-1">Interactive graphs for placement trends.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-.8 1-1.5 2-2 2.3-2.3 6-4-6-4s-8.3 1.7-6 4c1 1 1.7 1.2 2 2"/><path d="M12 18.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/></svg>
                    Official Docs
                </p>
                <p class="text-xs text-gray-600 mt-1">Direct links to all Syllabus and Academic Calendars.</p>
            </div>
            <div class="feature-item p-3 border border-gray-200 rounded-lg bg-white/70">
                <p class="font-bold text-[#006494] flex items-center">
                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    24/7 Access
                </p>
                <p class="text-xs text-gray-600 mt-1">Instant support via text or voice input.</p>
            </div>
        </div>

        <!-- Start Chat Button -->
        <button onclick="startChat()"
                class="w-full p-4 mt-2 bg-[#00C9A7] text-white text-xl font-bold rounded-lg hover:bg-[#00A887] transition duration-150 shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#00C9A7]/50">
            Start Chatting Now
        </button>
    </div>
</div>

<!-- Chat View - Hidden by default -->
<div id="chat-view" class="card-container hidden">
    <div id="chat-container" class="w-full h-full flex flex-col">
        <!-- Header (Updated with Dark Mode Toggle) -->
        <header class="chat-header">
            <div class="p-2 bg-white/20 rounded-full mr-3">
                <img src="https://i.postimg.cc/B6v57Wfn/1727246051php-AX4sq7.jpg" 
                     alt="Pragati Bot Logo" 
                     class="w-6 h-6 object-cover rounded-full"
                     onerror="this.onerror=null; this.src='https://placehold.co/24x24/00C9A7/ffffff?text=AI'">
            </div>
            <div>
                <h1 class="text-lg font-semibold">Pragati Engineering College Bot</h1>
                <p class="text-xs opacity-80">24/7 Student Support Assistant</p>
            </div>
            <!-- NEW DARK MODE TOGGLE BUTTON -->
            <button id="mode-toggle" 
                    onclick="toggleDarkMode()"
                    class="ml-auto p-2 rounded-full hover:bg-white/30 transition duration-150 button-click-animation"
                    title="Toggle Dark Mode">
                <svg id="moon-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <svg id="sun-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            </button>
        </header>

        <!-- Chat History --><div id="chat-history">
            <!-- Initial welcome message added via JS after starting chat -->
        </div>

        <!-- Suggestion Area (Restored for UX) -->
        <div id="suggestion-area" class="p-3 bg-white border-t border-gray-100 flex flex-wrap gap-2 transition-all duration-300">
            <!-- Suggestions will be rendered here -->
        </div>


        <!-- Input Area --><div id="input-area">
            <input type="text" id="user-input" placeholder="Ask a question..."
                   class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#00C9A7] transition duration-150"
                   autofocus>

            <!-- New Voice Input Button --><button id="voice-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="startVoiceInput()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>

            <!-- Send Button --><button id="send-button"
                    class="ml-3 p-3 bg-[#00C9A7] text-white rounded-full hover:bg-[#00A887] transition duration-150 shadow-md disabled:bg-[#00C9A7]/50 button-click-animation"
                    onclick="sendMessage()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
    // --- CONVERSATIONAL STATE MANAGEMENT ---
    let conversationContext = {
        state: 'idle', // 'idle', 'awaiting_branch' (Used for PQP)
        originalQuery: null, // Stores the query that led to 'awaiting_branch'
    };
    // --- NEW: Global State for Contextual Staff Search ---
    let lastStaffQuery = {
        originalQuery: null, 
        matches: [],         
        state: 'idle',        // 'idle', 'prompting_for_clarification', 'awaiting_cs_specialization'
        singleMatchFound: null, // Store single match result for simple follow-up (e.g., "his number")
        clarificationAttempts: 0 // NEW: Track clarification attempts
    };
    // --- END CONVERSATIONAL STATE MANAGEMENT ---

    // --- GLOBAL VARIABLES & UTILITIES (FIXES ReferenceError) ---
    
    // Core State Variables
    let recognition = null;
    let placementChart = null;
    let chatInitialized = false;

    // API Configuration (Placeholder/Default for Canvas environment)
    const API_KEY = typeof __api_key !== 'undefined' ? __api_key : "";
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // System Prompt for the AI
    const SYSTEM_PROMPT = `You are the friendly, official AI assistant for Pragati Engineering College, Surampalem. Your responses must be helpful, professional, and focus exclusively on information related to the college (admissions, courses, campus life, faculty, etc.). If asked non-college related questions, politely decline and redirect the user. Keep answers concise.`;

    // DOM Element Declarations
    let loginView;
    let chatView;
    let userInput;
    let sendButton;
    let voiceButton;
    let chatHistory;
    let sunIcon;
    let moonIcon;
    let suggestionArea;
    
    // A utility function to ensure DOM elements are fetched *after* the DOM is ready
    const setupDOMReferences = () => {
        loginView = document.getElementById('login-view');
        chatView = document.getElementById('chat-view');
        userInput = document.getElementById('user-input');
        sendButton = document.getElementById('send-button');
        voiceButton = document.getElementById('voice-button');
        chatHistory = document.getElementById('chat-history');
        sunIcon = document.getElementById('sun-icon');
        moonIcon = document.getElementById('moon-icon');
        suggestionArea = document.getElementById('suggestion-area');
    };

    // Helper for scrolling
    const scrollToBottom = () => {
        if (chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    };

    // --- FUNCTION TO FORMAT OUTPUT AS REQUESTED (Strict String Format) ---
    const getStrictContactOutput = (staff) => {
        // 1. Determine the canonical branch name (e.g., 'CSE', 'ECE', 'CSE (DS)')
        const canonicalBranch = getCanonicalBranch(staff.designation);

        // 2. Lookup the exact display name
        const branchDisplay = FULL_DEPT_NAMES[canonicalBranch] || canonicalBranch; 
        
        const number = staff.number || "Not Provided";
        const fullName = staff.name || "Not Provided";
        const designation = staff.designation || "Not Provided";

        // ADHERING TO NEW STRICT FORMAT AND ORDER
        // âœ… Name: [Full Name] ðŸ« Department: [Department / Branch] ðŸŽ“ Designation: [Position] ðŸ“ž Phone: [Phone Number]
        return `âœ… Name: ${fullName} ðŸ« Department: ${branchDisplay} ðŸŽ“ Designation: ${designation} ðŸ“ž Phone: ${number}`;
    };


    // Helper for adding messages (UPDATED to handle Strict Contact Response)
    const addMessage = (text, isUser) => {
        if (!chatHistory) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        
        // --- NEW LOGIC TO HANDLE STRICT CONTACT OUTPUT ---
        const isStrictContactResponse = typeof text === 'string' && text.trim().startsWith('âœ… Name:');

        if (isStrictContactResponse) {
            // Parse the required fields from the structured string for display
            // The format is: âœ… Name: [N] ðŸ« Department: [D] ðŸŽ“ Designation: [G] ðŸ“ž Phone: [P]
            const nameMatch = text.match(/Name: (.*?) ðŸ«/);
            const deptMatch = text.match(/Department: (.*?) ðŸŽ“/);
            const designationMatch = text.match(/Designation: (.*?) ðŸ“ž/);
            const contactMatch = text.match(/Phone: (.*)/);
            
            // Generate a clean, formatted card output
            bubble.innerHTML = `
                <div class="info-card">
                    <p class="font-semibold text-lg text-[#006494] mb-2">ðŸ“‡ Staff Contact Found</p>
                    <ul class="text-sm space-y-1">
                        <li>**Name:** ${nameMatch ? nameMatch[1].trim() : 'N/A'}</li>
                        <li>**Department:** ${deptMatch ? deptMatch[1].trim() : 'N/A'}</li>
                        <li>**Designation:** ${designationMatch ? designationMatch[1].trim() : 'N/A'}</li>
                        <li>**Phone:** <span class="font-bold text-lg text-[#dc2626]">${contactMatch ? contactMatch[1].trim() : 'N/A'}</span></li>
                    </ul>
                    <p class="mt-3 text-xs text-gray-500">_Raw Output: ${text}_</p>
                </div>
            `;
        } else if (!isUser) {
        // --- END NEW LOGIC ---
        
            // Existing markdown processing for general bot messages
            bubble.innerHTML = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **bold**
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // *italic*
                .replace(/\n/g, '<br>'); // preserve new lines
        } else {
            bubble.textContent = text;
        }

        bubble.className = `message-bubble ${isUser ? 'user-message' : 'bot-message'}`;
        
        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
    };

    // Helper for suggestions
    const showSuggestions = (suggestions) => {
        if (!suggestionArea) return;
        
        suggestionArea.innerHTML = '';
        suggestionArea.classList.add('p-3');
        suggestionArea.style.height = 'auto'; // Show the area

        suggestions.forEach(text => {
            const button = document.createElement('button');
            button.className = 'suggestion-button button-click-animation';
            button.textContent = text;
            button.onclick = () => {
                userInput.value = text;
                sendMessage();
            };
            suggestionArea.appendChild(button);
        });
        scrollToBottom();
    };
    
    const clearSuggestions = () => {
        if (suggestionArea) {
            suggestionArea.innerHTML = '';
            suggestionArea.classList.remove('p-3');
            suggestionArea.style.height = '0';
        }
    };

    // Helper for loading indicator
    const showTyping = () => {
        if (!chatHistory) return;
        
        let loadingDiv = document.getElementById('loading-indicator');
        if (!loadingDiv) {
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bot-message message-bubble text-center">
                    <svg class="w-6 h-6 thinking-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                </div>
            `;
            chatHistory.appendChild(loadingDiv);
            scrollToBottom();
        }
    };
    
    const hideLoading = () => {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    };

    // --- DARK MODE LOGIC (FIXES applySavedTheme ReferenceError) ---
    function applySavedTheme() {
        if (sunIcon && moonIcon && document.body) {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            // If the placement chart exists, destroy and redraw it to update colors
            if (placementChart) {
                placementChart.destroy();
                let chartWrapper = document.querySelector('.chart-wrapper');
                if (chartWrapper) {
                    showPlacementGraph();
                }
            }
        }
    }

    function toggleDarkMode() {
        if (!document.body) return;
        
        const isDark = document.body.classList.toggle('dark');
        const theme = isDark ? 'dark' : 'light';
        localStorage.setItem('theme', theme);
        
        if (moonIcon && sunIcon) {
            moonIcon.classList.toggle('hidden');
            sunIcon.classList.toggle('hidden');
        }

        // Check if a chart exists and redraw it with new theme colors
        if (placementChart) {
            placementChart.destroy();
            showPlacementGraph(); // Redraws the chart with the current theme settings
        }
    }
    // --- END DARK MODE LOGIC ---

    
    // --- PLACEMENT DATA (Hardcoded Sample Data for Chart) ---
    const PLACEMENT_DATA = {
        years: ['2022', '2023', '2024', '2025 (Ongoing)'],
        highest: [31.31, 29.26, 35.0, 40.0], // Sample data, 40 LPA is from KB
        average: [3.0, 4.0, 4.5, 5.5], // Sample data
    };
    
    // --- STAFF CONTACTS (CONSOLIDATED DATABASE) ---
    // This array is the single source of truth for all staff data provided across all 16 CSV sheets.
    const STAFF_CONTACTS = [
        // --- KEY PERSONNEL / MAIN LINES (from dept HoDs phone .csv) ---
        { name: "Principal Sir", number: "9618787861", designation: "Principal" },
        { name: "Hostel (Reception)", number: "9618787862", designation: "Reception" },
        { name: "Discipline Officer", number: "9618787863", designation: "Discipline Officer" },
        { name: "Adi Narayana (Discipline)", number: "9618787863", designation: "Discipline Officer" },
        { name: "Sunil Raj (Transport)", number: "9618701133", designation: "Transport Coordinator" },
        { name: "Xerox", number: "9848183369", designation: "Xerox Section" },
        { name: "Civil Department", number: "9618757861", designation: "Civil HOD/Main Dept Line" },
        { name: "EEE Department", number: "9618757862", designation: "EEE HOD/Main Dept Line" },
        { name: "MECH Department", number: "9618757863", designation: "MECH HOD/Main Dept Line" },
        { name: "ECE Department", number: "9618757864", designation: "ECE HOD/Main Dept Line" },
        { name: "CSE Department", number: "9618757865", designation: "CSE HOD/Main Dept Line" },
        { name: "IT Department", number: "9618757860", designation: "IT HOD/Main Dept Line" },
        { name: "CSE (CS) Department", number: "7995313377", designation: "CSE (CS) Dept Line" },
        { name: "CSE (DS) Department", number: "7995785588", designation: "CSE (DS) Dept Line" },
        { name: "CSE (AI) Department", number: "7702842266", designation: "CSE (AI) Dept Line" },
        { name: "CSE (AI&ML) Department", number: "9000195104", designation: "CSE (AI&ML) Dept Line" },
        { name: "BS&H Department", number: "9618787860", designation: "BS&H HOD/Main Dept Line" },
        
        // --- CIVIL DEPARTMENT STAFF ---
        { name: "Dr. K.Saroja Rani", number: "9502255765", designation: "Associate Professor, CIVIL" },
        { name: "Mrs. V.Tanuja", number: "9703065276", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. B.Sri Kalyan", number: "7382781194", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. D.V.D.Prasad", number: "8008300313", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. V.Sai Kiran", number: "8008941069", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. B.Sri Datta Subramanyam", number: "9989803199", designation: "Assistant Professor, CIVIL" },
        { name: "Mr. L.Praveen Kumar", number: "9573093908", designation: "Assistant Professor, CIVIL" },
        { name: "Ms. V.Chandu", number: "8074782745", designation: "Lab Technician, CIVIL" },
        { name: "Mrs. B. Kanaka Durga", number: "6281245488", designation: "DTP Operator, CIVIL" },
        
        // --- EEE DEPARTMENT STAFF ---
        { name: "K.V. DURGA PRASAD", number: "7396066636", designation: "ASST. PROFESSOR, EEE" },
        { name: "K. SIVA SANKAR", number: "9848555577", designation: "ASST. PROFESSOR, EEE" },
        { name: "M. MANISANKAR", number: "9000681167", designation: "ASST. PROFESSOR, EEE" },
        { name: "V.R.V.S. SAI VALLI", number: "9491222728", designation: "ASST. PROFESSOR, EEE" }, 
        { name: "P. SANDHYA", number: "9603043462", designation: "ASST. PROFESSOR, EEE" },
        { name: "D. PRAKASA RAO", number: "9866201153", designation: "ASST. PROFESSOR, EEE" },
        { name: "P. VARALAKSHMI", number: "6305546589", designation: "ASST. PROFESSOR, EEE" },
        { name: "S. NANI BABU", number: "9121607380", designation: "ASST. PROFESSOR, EEE" },
        { name: "P. PUSHPA LATHA", number: "9553623123", designation: "ASST. PROFESSOR, EEE" },
        { name: "P.V.V. RAMANA", number: "9989527134", designation: "ASST. PROFESSOR, EEE" },
        { name: "K. TATABBAI", number: "8106288977", designation: "LAB TECHNICIAN, EEE" },
        { name: "K. SRIRAM", number: "9393752388", designation: "LAB TECHNICIAN, EEE" },
        { name: "Y.H.S.S. PHANEENDRA", number: "9030498804", designation: "LAB TECHNICIAN, EEE" },
        { name: "Y. MANIKANTA", number: "9133609164", designation: "LAB TECHNICIAN, EEE" },
        { name: "B. ARUNA KUMAR", number: "9182541906", designation: "JUNIOR ASSISTANT, EEE" },

        // --- MECH DEPARTMENT STAFF ---
        { name: "Dr Avinash G", number: "9866443604", designation: "HoD-ME, MECH" },
        { name: "Mr. D.J. Johnson", number: "6305858826", designation: "Assoc. Prof, MECH" },
        { name: "Mr. M. Sunil Raj", number: "9989798969", designation: "Assoc. Prof, MECH" },
        { name: "Mrs. K. Aravinda", number: "9949183736", designation: "Asst. Prof, MECH" },
        { name: "Mr. N. Raghuveer", number: "9177709223", designation: "Asst. Prof, MECH" },
        { name: "Mr. V.V.N. Sarath", number: "9652299245", designation: "Asst. Prof, MECH" },
        { name: "Mr. P. Ram Prasad", number: "9550731375", designation: "Asst. Prof, MECH" },
        { name: "Mr. A. Phani Bhaskar", number: "8121412442", designation: "Asst. Prof, MECH" },
        { name: "Mrs. P. Gayathri", number: "7702636534", designation: "Asst. Prof, MECH" },
        { name: "Mr.A. Yeswanth", number: "9492511943", designation: "Asst. Prof, MECH" },
        { name: "Mrs. K. Tulasi", number: "9959833497", designation: "Asst. Prof, MECH" },
        { name: "Mr. K. Sree Ramachandra Murthy", number: "7799838226", designation: "Asst. Prof, MECH" },
        { name: "Mr. B. Hari Krishna", number: "6281813597", designation: "Asst. Prof, MECH" },
        { name: "Mr. B. Bharath Kumar", number: "9505550090", designation: "Asst. Prof, MECH" },
        { name: "Mr. V. Murali Krishna", number: "9573062377", designation: "Lab Technician, MECH" },
        { name: "Mr. G. Soma Raju", number: "9618971864", designation: "Lab Technician, MECH" },
        { name: "Mr. Ch. Syam Pradeep Kumar", number: "7032089099", designation: "Lab Technician, MECH" },
        { name: "Mr. A. Satyanarayana Murthy", number: "9676286042", designation: "Lab Technician, MECH" },
        { name: "Mr. Ch. S S Bhaskara Rao", number: "7675915844", designation: "Lab Technician, MECH" },
        { name: "Mrs. R.Vasundhara", number: "9542271769", designation: "Computer Operator, MECH" },

        // --- ECE DEPARTMENT STAFF ---
        { name: "Dr V Sailaja", number: "9491444434", designation: "Professor, ECE" },
        { name: "Dr. Subodh Panda", number: "9337994245", designation: "Professor, ECE" },
        { name: "Dr. V. Radhika", number: "9849755182", designation: "Professor, ECE" },
        { name: "Dr. Sharon Rose Victor. J.", number: "7981230819", designation: "Associate Professor, ECE" },
        { name: "Dr B N Srinivasarao", number: "8328181276", designation: "Associate Professor, ECE" },
        { name: "Dr. Ch. Venkateswarlu", number: "8919359853", designation: "Associate Professor, ECE" },
        { name: "Mr. V. Prasanth", number: "7660941116", designation: "Associate Professor, ECE" },
        { name: "Mr. G.S. Sivakumar", number: "9949811979", designation: "Associate Professor, ECE" },
        { name: "Mrs. B. Vasantha Lakshmi", number: "9912717447", designation: "Associate Professor, ECE" },
        { name: "Mr. Ch. Satish", number: "9154889353", designation: "Assistant Professor, ECE" },
        { name: "Mrs. L. Gaviramma", number: "9440427485", designation: "Assistant Professor, ECE" },
        { name: "Ms. Rubia Tasneem", number: "9182874366", designation: "Assistant Professor, ECE" },
        { name: "Mr. P. Krishna Chaitanya", number: "8309247775", designation: "Assistant Professor, ECE" },
        { name: "Mrs. D.V.V. Lakshmi", number: "7729806111", designation: "Assistant Professor, ECE" },
        { name: "Mrs. P. Ramya Krishna", number: "9533333596", designation: "Assistant Professor, ECE" },
        { name: "Mr. T. Sekhar", number: "9542372399", designation: "Assistant Professor, ECE" },
        { name: "Mr. M. Brahma Raju", number: "8639777764", designation: "Assistant Professor, ECE" },
        { name: "Mrs. G Viranya", number: "8125922090", designation: "Assistant Professor, ECE" },
        { name: "Mr. K. Akhil", number: "7382646821", designation: "Assistant Professor, ECE" },
        { name: "Mr. B. Kalyan Charavarthy", number: "9703852614", designation: "Assistant Professor, ECE" },
        { name: "Mr. G. Raju", number: "9000566313", designation: "Assistant Professor, ECE" },
        { name: "Mr. Y. Vijay Kumar", number: "9480398751", designation: "Assistant Professor, ECE" },
        { name: "Mrs. M. Geetha", number: "7287847289", designation: "Assistant Professor, ECE" },
        { name: "Mrs. T. Subhasri", number: "9491447916", designation: "Assistant Professor, ECE" },
        { name: "Mr. B T S S Srihari", number: "9182314528", designation: "Assistant Professor, ECE" },
        { name: "Mr N.Swami Dattatreyachari", number: "8790611888", designation: "Assistant Professor, ECE" },
        { name: "Mr.P.Ravi Sankar", number: "8125578099", designation: "Assistant Professor, ECE" },
        { name: "Mrs.Jyothi", number: "9000088467", designation: "Assistant Professor, ECE" },
        { name: "Ms K Prasanthi", number: "6281829439", designation: "Assistant Professor, ECE" },
        { name: "Mrs K Dharma Ratnam", number: "9491104247", designation: "Assistant Professor, ECE" },
        { name: "Ch Maheswara Rao", number: "9296050405", designation: "Lab Technician, ECE" },
        { name: "V V S Vanisree", number: "9063381990", designation: "Lab Technician, ECE" },
        { name: "G Rama Krishna", number: "9581382444", designation: "Lab Technician, ECE" },
        { name: "N Ch Raghu Kishore", number: "8179517343", designation: "Lab Technician, ECE" },
        { name: "P Sravanthi", number: "9912753555", designation: "Lab Technician, ECE" },
        { name: "Lokesh", number: "9491353427", designation: "Lab Technician, ECE" },
        { name: "B Deepthi", number: "8125715202", designation: "Lab Technician, ECE" },
        { name: "M Lakshmi Durga", number: "7842807114", designation: "Operator, ECE" },
        { name: "D Anand", number: "9381664179", designation: "Attender, ECE" },


        // --- CSE DEPARTMENT STAFF (COMPLETELY UPDATED) ---
        { name: "Dr. Y. Jayababu", number: "9948612244", designation: "Professor, CSE" },
        { name: "Dr.M.Radhika Mani", number: "", designation: "Professor, CSE" },
        { name: "Dr.D. V Manjula", number: "9492247662", designation: "HOD - CSE" },
        { name: "Dr.M.Uma Devi", number: "9440896317", designation: "Associate Professor, CSE" },
        { name: "Mr.K.Chandra Sekhar", number: "8008882777", designation: "Assistant Professor, CSE" },
        { name: "Mr.G.Vijay Kumar", number: "8074454807", designation: "Assistant Professor, CSE" },
        { name: "A.Avinash", number: "7780135919", designation: "Assistant Professor, CSE" },
        { name: "Ms.A.Harini", number: "9705300711", designation: "Assistant Professor, CSE" },
        { name: "Mr.KVV Subba Rao", number: "9550014927", designation: "Assistant Professor, CSE" },
        { name: "Mrs.P.Lakshmi Satya", number: "9949612205", designation: "Assistant Professor, CSE" },
        { name: "Mr.Ch.Manikanta Kalyan", number: "9849151430", designation: "Assistant Professor, CSE" },
        { name: "Mr.S K Sankar", number: "9063270672", designation: "Assistant Professor, CSE" },
        { name: "Mrs.T.N.V Durga", number: "9866439710", designation: "Assistant Professor, CSE" },
        { name: "Mrs.Kanaka Tulasi", number: "7731086699", designation: "Assistant Professor, CSE" },
        { name: "Mrs.Sowjanya", number: "7382400024", designation: "Assistant Professor, CSE" },
        { name: "Mrs.K.Sham Sri", number: "8897058321", designation: "Assistant Professor, CSE" },
        { name: "Sayantan Kar", number: "9877439792", designation: "Assistant Professor, CSE" },
        { name: "I.Subbalakshmi", number: "7330720646", designation: "Computer Operator, CSE" },
        { name: "Ch. Rajesh", number: "7801089037", designation: "System Administrator, CSE" },
        { name: "Y.Veerababu", number: "7032428121", designation: "Lab Technician, CSE" },
        { name: "M. Praveen Kumar", number: "8897191045", designation: "Lab Technician, CSE" },
        { name: "V. Gangeswararao", number: "9951132122", designation: "Lab Technician, CSE" },
        { name: "D. Gayatri", number: "7842875006", designation: "Programmer, CSE" },
        { name: "Y. Gayatri", number: "8332904020", designation: "Programmer, CSE" },
        { name: "R. Supriya", number: "8106453755", designation: "Programmer, CSE" },
        { name: "U. Shankar Babu", number: "7013979715", designation: "System Admin, CSE" },
        { name: "D. Kanaka Mahalakshmi Devi", number: "8331883748", designation: "Assistant Professor, CSE" },
        { name: "Manas Kumar Yogi", number: "9966979279", designation: "Assistant Professor, CSE" },

        // --- IT & CS DEPARTMENT STAFF ---
        { name: "Mrs. T Ganga Bhavani", number: "8639777155", designation: "Assistant Professor, IT" },
        { name: "Mr. G Satya Mohna Chowdary", number: "9959088282", designation: "Assistant Professor, IT" },
        { name: "Mr. D Konda Babu", number: "9440410443", designation: "Assistant Professor, IT" },
        { name: "Mrs. A Manga Devi", number: "9247191210", designation: "Assistant Professor, IT" },
        { name: "Ms. J N S Kalyani", number: "7729084751", designation: "Assistant Professor, IT" },
        { name: "Mrs. K Sreesha", number: "9052882133", designation: "Programmer, IT" },
        { name: "Mr. V Kamesh", number: "7801009585", designation: "Lab Technician, IT" },
        { name: "Mr. O yesoda Krishna ", number: "8886374613", designation: "Lab Technician, IT" },
        { name: "Ms. Y Lakshmi Prasanna", number: "8341161550", designation: "Programmer, IT" },
        { name: "Ms. P Gowthami", number: "9392745762", designation: "Computer Operator, IT" },
        
        // --- CSE (AI) DEPARTMENT STAFF ---
        { name: "Mrs. K Lakshmi Viveka", number: "9642788777", designation: "Associate Prof & HoD, CSE (AI)" },
        { name: "Mrs. T Tejasvi", number: "9505150735", designation: "Assistant Professor, CSE (AI)" },
        { name: "Mr. M S V V Ramesh", number: "8639797917", designation: "Assistant Professor, CSE (AI)" },
        { name: "Mr. M Veerababu", number: "9491629344", designation: "Assistant Professor, CSE (AI)" },
        { name: "Mrs. Ch Sri Divya", number: "9492113320", designation: "Assistant Professor, CSE (AI)" },
        { name: "Mr. S S V S Santosh Kumar", number: "9550742920", designation: "Assistant Professor, CSE (AI)" },
        { name: "Mr. K Sri Hari", number: "9014032554", designation: "Programmer, CSE (AI)" },
        { name: "Mr. G Raja Babu", number: "7396544538", designation: "Computer Operator, CSE (AI)" },
        { name: "Mrs. P Vara Lakshmi", number: "8498921663", designation: "Attender, CSE (AI)" },

        // --- CSE (DS) DEPARTMENT STAFF ---
        { name: "Mr. M. V. Rajesh", number: "7702482324", designation: "Assoc Prof, CSE (DS)" },
        { name: "Mrs. N.V.S. Sowjanya", number: "9705766038", designation: "Asst Prof, CSE (DS)" },
        { name: "Mr. K. Srikanth", number: "9154020707", designation: "Asst Prof, CSE (DS)" },
        { name: "Mrs. CH. Veera Gayathri", number: "9347397805", designation: "Asst Prof, CSE (DS)" },
        { name: "Ms. Y Suma Chamundeswari", number: "8790429794", designation: "Asst Prof, CSE (DS)" },
        { name: "Mrs. Lakshmi Sai Prasuna", number: "9014930523", designation: "Progarmmer, CSE (DS)" },
        { name: "Mr. N. Sriram", number: "8985881277", designation: "Progarmmer, CSE (DS)" },
        { name: "Mr. S. Bharadwaj", number: "9640892552", designation: "Technician, CSE (DS)" },
        { name: "K. Vasantha", number: "9059779323", designation: "Computer Operator, CSE (DS)" },
        { name: "K. Vara Lakshmi", number: "8498921663", designation: "Attender, CSE (DS)" },

        // --- CSE (AI&ML) DEPARTMENT STAFF ---
        { name: "Dr. A. Radha Krishna", number: "9440614466", designation: "Professor, CSE (AI&ML)" },
        { name: "Mrs. V. Anantha Lakshmi", number: "9493568179", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mr. A. Janardhana Rao", number: "6281866876", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. L. Yamuna", number: "8519997240", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. G. V .Rajeswari", number: "8142767655", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. G. Tejasri Devi", number: "7382407013", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. P. Satyavathi", number: "8179667416", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. M. Mani Deepika", number: "9550374458", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. A .Srujana Jyothi", number: "9347277603", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Mrs. K.S.R. Manjusha", number: "8074484878", designation: "Asst. Prof, CSE (AI&ML)" },
        { name: "Ms. P. Pravallika", number: "7661996684", designation: "Computer Operator, CSE (AI&ML)" },
        { name: "Ms. M. Nagalakshmi", number: "7386461221", designation: "Programmer, CSE (AI&ML)" },
        { name: "Mr. K Chakra Rao", number: "7995161688", designation: "Attender, CSE (AI&ML)" },
        
        // --- BS&H DEPARTMENT STAFF ---
        { name: "Dr. T. Satyanarayana", number: "9490480223", designation: "Assoc.Prof, BS&H" },
        { name: "Mr. P. Madhu Babu", number: "9701756233", designation: "Asst.Prof, BS&H" },
        { name: "Mr. A. Nagendra", number: "9666100897", designation: "Assoc.Prof, BS&H" },
        { name: "Mrs. V. Indira Priyadarsini", number: "8919761836", designation: "Assoc.Prof, BS&H" },
        { name: "Mrs. V. Durga Bhavani", number: "6302742858", designation: "Assoc.Prof, BS&H" },
        { name: "Ms. V. Bhavani", number: "9705956576", designation: "Asst.Prof, BS&H" },
        { name: "Mr. B. Akashay Deep", number: "8885902298", designation: "Asst.Prof, BS&H" },
        { name: "Mrs. M. Iswarya", number: "9740544466", designation: "Asst.Prof, BS&H" },
        { name: "Mr. K. V. Narayana", number: "8096156000", designation: "Assoc.Prof, BS&H" },
        { name: "Mrs. M. Chandralekha", number: "", designation: "Assoc.Prof, BS&H" }, // Number Missing
        { name: "Dr. J. D. Naidu", number: "9959375696", designation: "Assoc.Prof, BS&H" },
        { name: "Dr. K. Chakrapani", number: "9392003335", designation: "Assoc.Prof, BS&H" },
        { name: "Dr. S. Prasad", number: "9494437872", designation: "Assoc.Prof, BS&H" },

        // --- CDC DEPARTMENT STAFF ---
        { name: "Dr. M. Radhika Mani", number: "7702666337", designation: "Dean - CDC" },
        { name: "Mr. Ch. Satish (Aptitude)", number: "9959679067", designation: "Aptitude Assistant Professor, CDC" },
        { name: "Mr. P. Prasad Babu (Aptitude)", number: "9394521108", designation: "Aptitude Assistant Professor, CDC" },
        { name: "Mr. D. Hanumantha Rao (Aptitude)", number: "6301994493", designation: "Aptitude Assistant Professor, CDC" },
        { name: "Mr. K.T.K. Mohan (Technical)", number: "7995161698", designation: "Technical Assistant Professor, CDC" },
        { name: "Mrs. M. Madhavi (Verbal Ability)", number: "8886584852", designation: "Verbal Ability Assistant Professor, CDC" },
        { name: "Mr. G. Venkata Ratnam (Verbal)", number: "9177551009", designation: "Verbal Ability Assistant Professor, CDC" },
        { name: "Dr. P. C. Viswanth (Verbal)", number: "9705932211", designation: "Verbal Ability Assistant Professor, CDC" },
        { name: "Mrs. K.V. Sirisha Devi", number: "9704017194", designation: "Computer Operator, CDC" },
        { name: "Mrs. N. Naga Swathi", number: "9703775871", designation: "Computer Operator, CDC" },
        
        // --- MEFA (MANAGEMENT) DEPARTMENT STAFF ---
        { name: "Mr. KSVGK Murthy", number: "9618888058", designation: "Associate Professor, MEFA" },
        { name: "Mr. K. Anand", number: "9133621114", designation: "Assistant Professor, MEFA" },
        { name: "Mr. G. Prasanna Kumar", number: "8500812541", designation: "Assistant Professor, MEFA" },
        { name: "Mr. PVS Swamy", number: "9704305964", designation: "Assistant Professor, MEFA" },
        { name: "Mrs. G. Pavani", number: "9010319877", designation: "Assistant Professor, MEFA" },
        { name: "Mrs. B. Lova Kumari", number: "9908846657", designation: "Assistant Professor, MEFA" },

        // --- EXAM SECTION STAFF ---
        { name: "Mr. P. Raja Kumar", number: "9502655666", designation: "Exam Section Staff" },
        { name: "Mr. N.V. Satyanarayana", number: "9666704259", designation: "Computer Operator, Exam Section" },
        { name: "Mr. M. Sateesh", number: "9640036111", designation: "Jr. Assistant, Exam Section" },
        { name: "Mr. Ch.V.S.N. Vamsi", number: "7995183975", designation: "Jr. Assistant, Exam Section" },
        { name: "Mr. B. Sandeep", number: "9133825167", designation: "Attender, Exam Section" },
        
        // --- ADMIN & NON-TEACHING STAFF ---
        { name: "Mr. P Ram Mohan Rao", number: "9515831098", designation: "Office Supdt, Administrative Office" },
        { name: "Mr. B Papa Rao", number: "9866172537", designation: "Sr. Asst., Administrative Office" },
        { name: "Mr. K Hari Kumar", number: "9705177399", designation: "Sr. Asst., Administrative Office" },
        { name: "Mr. K V Govind Babu", number: "9701201868", designation: "Sr. Asst., Administrative Office" },
        { name: "Mr. Y Chandra Kumar", number: "9676913112", designation: "Sr. Asst., Administrative Office" },
        { name: "Mrs. B Perim Devi", number: "9652067735", designation: "Sr. Asst., Administrative Office" },
        { name: "Mr. K V Rama Krishna", number: "8125398706", designation: "Administrative Staff" },
        { name: "Mr. K Ram Mohan Rao", number: "9550727417", designation: "Sr. Asst., Administrative Office" },
        { name: "Mr. B Aruna Kumar", number: "9182541906", designation: "Jr. Asst., Administrative Office" },
        { name: "Mr. K Suresh (Receptionist)", number: "9849664907", designation: "Jr. Asst. & Receptionist" },
        { name: "Mr. S Baby", number: "9491540350", designation: "Staff Nurse" },
        { name: "Mr. G Durga Prasad", number: "9391229061", designation: "Warden" },
        { name: "Mr. P Atchyutha Kumar", number: "6300975587", designation: "Warden" },
        { name: "Mr. Y Satyanarayana", number: "9989798969", designation: "Administrative Staff" }, // Note: This number overlaps with M. Sunil Raj Transport. Kept for completeness.
        { name: "Mrs. S Anantha Lakshmi", number: "9701195749", designation: "Aaya" },
        { name: "Mrs. I Satyaveni", number: "9100085853", designation: "Aaya" },
        { name: "Mr. R Vinod", number: "8185816294", designation: "Attender" },
        { name: "Mr. M Raviteja", number: "9177658648", designation: "Attender" },
        { name: "Mr. P Seshu Kumar", number: "6301333147", designation: "Attender" },
        { name: "Mr. V Nookaraju", number: "8008609308", designation: "Attender" },
        { name: "Mr. Bolisetty Venkateswara Rao", number: "9494273448", designation: "Attender" },
        { name: "Mr. D Anand", number: "9381664179", designation: "Attender" },
        { name: "Mr. K Vishnu", number: "9490360273", designation: "Attender" },
        { name: "Mrs. K Vara Lakshmi", number: "8498921663", designation: "Attender" },
        { name: "Mr. B. Sandeep Kumar", number: "9133825167", designation: "Attender" },
        { name: "Mr. P Surya Prakash", number: "7995042733", designation: "Attender" },
        { name: "Mr. N V Bhadra Rao", number: "8897956282", designation: "Gardener" },
        { name: "Mr. V Srinivas (Raghava)", number: "9666752807", designation: "Gardener" },
        { name: "Mr. P. Dorababu", number: "9618908643", designation: "Gardener" },
        
        // --- SECURITY & MAINTENANCE STAFF ---
        { name: "Mr. N Nageswara Rao", number: "8106879706", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. S Sai Kumar", number: "9848304038", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. M. Suresh", number: "9948098901", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. Srinuvasu", number: "7842485141", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. P V Prasad", number: "9640510888", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. M Chinthamani", number: "8309200144", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. S Uma Mahesh", number: "8179402772", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. N Raju", number: "9652125719", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. Y Murali Krishna", number: "9666775727", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. S Laacha Babu", number: "8106945015", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. D V V Sathyanarayana", number: "8985881480", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. G Pentayya", number: "9951859174", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. K Veeraju", number: "9652709034", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. M Srinuvasu", number: "9014227041", designation: "Security Staff, Maintenance Dept" },
        { name: "Mr. R Veera babu", number: "9550577741", designation: "Security Staff, Maintenance Dept" },
    ];
    // --- END STAFF CONTACTS ---

    // --- DEPT SYNONYM MAPPER (COMPREHENSIVE UPDATE) ---
    // Includes all variations for high precision filtering during clarification steps.
    const DEPT_MAP = {
        // Engineering Departments
        'cse': 'CSE', 'comp': 'CSE', 'cs': 'CSE', 'computer science': 'CSE', 'computer': 'CSE', 'comp sci': 'CSE',
        'ece': 'ECE', 'e&c': 'ECE', 'electronics': 'ECE', 'electroncs': 'ECE', 'ec': 'ECE',
        'eee': 'EEE', 'electrical': 'EEE', 'ee': 'EEE',
        'mech': 'MECH', 'mechanical': 'MECH', 'ma': 'MECH', 'mechanic': 'MECH',
        'civil': 'CIVIL', 'ci': 'CIVIL', 'civil engg': 'CIVIL',
        'it': 'IT', 'information technology': 'IT', 'info tech': 'IT',

        // Specializations
        'ai&ml': 'CSE (AI&ML)', 'aiml': 'CSE (AI&ML)', 'ml': 'CSE (AI&ML)', 'machine learning': 'CSE (AI&ML)',
        'ds': 'CSE (DS)', 'data science': 'CSE (DS)',
        'ai': 'CSE (AI)', 'artificial intelligence': 'CSE (AI)',
        
        // Academic/Support Departments
        'bsh': 'BS&H', 'basic sciences': 'BS&H', 'humanities': 'BS&H',
        'cdc': 'CDC', 'placements': 'CDC', 'career': 'CDC',
        'mefa': 'MEFA', 'management studies': 'MEFA', 'mba': 'MEFA',
        'exam': 'EXAM', 'exam section': 'EXAM', 'examination': 'EXAM', 'exams': 'EXAM',

        // Admin & General Staff
        'library': 'LIBRARY', 'lib': 'LIBRARY',
        'pd': 'PE', 'pe': 'PE', 'physical director': 'PE', 'sports': 'PE', // Physical Directors/PE
        'maintenance': 'MAINTENANCE', 'maintenance dept': 'MAINTENANCE', 'works': 'MAINTENANCE',
        'class iv': 'CLASS_IV', 'class 4': 'CLASS_IV', 'iv': 'CLASS_IV', 'attendant': 'CLASS_IV', 'aaya': 'CLASS_IV',
        'security': 'SECURITY', 'guard': 'SECURITY',
        'xerox': 'XEROX',
        
        // Titles/General Admin
        'admin': 'ADMIN', 'administrator': 'ADMIN', 'system admin': 'ADMIN', 'system administrator': 'ADMIN', 'sysadmin': 'ADMIN', 'office': 'ADMIN',
        
        // Special CS ambiguity mapping
        'cs': 'CSE (CS)', 
        'cyber security': 'CSE (CS)', 
    };
    
    // --- FULL DEPARTMENT NAME MAP (FOR OUTPUT FORMATTING) ---
    const FULL_DEPT_NAMES = {
        'CSE': 'CSE (Computer Science and Engineering)',
        'EEE': 'EEE (Electrical and Electronics Engineering)',
        'ECE': 'ECE (Electronics and Communication Engineering)',
        'MECH': 'MECH (Mechanical Engineering)',
        'CIVIL': 'CIVIL (Civil Engineering)',
        'IT': 'IT (Information Technology)',
        'BS&H': 'BS&H (Basic Sciences & Humanities)',
        'CDC': 'CDC (Career Development Cell)',
        'MEFA': 'MEFA (Management, Economics and Financial Analysis)',
        'EXAM': 'EXAM (Examinations Section)',
        'ADMIN': 'ADMIN (Administrative Office)',
        'SECURITY': 'Security Department',
        'HOSTEL': 'HOSTEL (Hostel Administration)',
        'TRANSPORT': 'TRANSPORT (Transport Coordination)',
        'RECEPTION': 'RECEPTION (General Reception)',
        'XEROX': 'Xerox Section',
        'GENERAL STAFF': 'General Staff',
        'CSE (CS)': 'CSE (Computer Science)', // Used for the CS ambiguity rule
        'CSE (DS)': 'CSE (Data Science)',
        'CSE (AI)': 'CSE (Artificial Intelligence)',
        'CSE (AI&ML)': 'CSE (AI & Machine Learning)',
        // NEW CATEGORIES
        'LIBRARY': 'Library Department',
        'PE': 'Physical Directors (PE)',
        'MAINTENANCE': 'Maintenance Department',
        'CLASS_IV': 'Class IV Staff (Aaya, Attenders)',
    };


    // --- UTILITY FUNCTIONS ---
    // Cleans string by removing punctuation, spaces, and converting to lowercase for comparison
    const cleanString = (str) => {
        // KEEP SPACES AND DOTTED INITIALS! We will only remove honorifics and then normalize whitespace.
        return str.toLowerCase().replace(/^(dr|mr|mrs|ms)\.\s*/, '').replace(/[^a-z0-9\s\.]/g, '').replace(/\s+/g, ' ').trim();
    };
    
    // Strips honorifics and converts to lowercase for primary name comparison
    const normalizeName = (name) => {
        // This is primarily for comparison, strip honorifics and non-alphanumeric/dot chars
        return name.toLowerCase().replace(/^(dr|mr|mrs|ms)\.\s*/, '').replace(/[^a-z0-9\s\.]/g, '').replace(/\s+/g, ' ').trim();
    };
    
    // Helper to get significant name words for robust matching
    const getSignificantWords = (nameNormalized) => {
        // Split by space or dot, filtering out single-letter initials UNLESS they are followed by a dot (which is normalized out later)
        // For example, 'a. harini' -> ['a', 'harini']. Filter is applied only to non-initial-looking words.
        return nameNormalized.replace(/\./g, ' ').split(/\s+/).filter(word => word.length > 1 || /^[a-z]$/i.test(word));
    };


    // --- DEDUPLICATION PASS (Runs once on initialization) ---
    const deduplicateStaff = (staffList) => {
        const uniqueNames = new Map();
        staffList.forEach(staff => {
            const cleanedKey = cleanString(staff.name);
            if (!uniqueNames.has(cleanedKey)) {
                uniqueNames.set(cleanedKey, staff);
            }
        });
        return Array.from(uniqueNames.values());
    };

    // Replace the raw STAFF_CONTACTS array with the deduplicated list
    const DEDUPLICATED_STAFF_CONTACTS = deduplicateStaff(STAFF_CONTACTS);

    // --- FUNCTION TO DERIVE CANONICAL BRANCH FROM STAFF DESIGNATION (UPDATED FOR NEW CATEGORIES) ---
    const getCanonicalBranch = (staffDesignation) => {
        const designationUpper = staffDesignation.toUpperCase();

        // Check for specific specializations first
        if (designationUpper.includes('CSE (AI&ML)')) return 'CSE (AI&ML)';
        if (designationUpper.includes('CSE (DS)')) return 'CSE (DS)';
        if (designationUpper.includes('CSE (AI)')) return 'CSE (AI)';
        
        // Handle CS ambiguity logic by checking against common CSE specializations 
        if (designationUpper.includes('CSE')) return 'CSE'; 

        // Check for main departments (using designation substring check)
        if (designationUpper.includes('CIVIL')) return 'CIVIL';
        if (designationUpper.includes('EEE')) return 'EEE';
        if (designationUpper.includes('MECH')) return 'MECH';
        if (designationUpper.includes('ECE')) return 'ECE';
        if (designationUpper.includes('IT')) return 'IT';
        if (designationUpper.includes('BS&H')) return 'BS&H';
        
        // Check for other sections (NEW MAPPINGS)
        if (designationUpper.includes('CDC')) return 'CDC';
        if (designationUpper.includes('MEFA') || designationUpper.includes('MANAGEMENT')) return 'MEFA';
        if (designationUpper.includes('EXAM')) return 'EXAM';
        if (designationUpper.includes('LIBRARY')) return 'LIBRARY';
        if (designationUpper.includes('PHYSICAL DIRECTOR') || designationUpper.includes('GARDENER')) return 'PE';
        if (designationUpper.includes('AAYA') || designationUpper.includes('ATTENDER')) return 'CLASS_IV';
        if (designationUpper.includes('XEROX')) return 'XEROX';
        
        // General Admin / Security / Maintenance
        if (designationUpper.includes('MAINTENANCE') || designationUpper.includes('SECURITY')) return 'SECURITY'; 
        if (designationUpper.includes('OFFICE SUPDT') || designationUpper.includes('ADMINISTRATIVE OFFICE') || designationUpper.includes('ADMIN')) return 'ADMIN';
        if (designationUpper.includes('HOSTEL') || designationUpper.includes('WARDEN')) return 'HOSTEL';
        if (designationUpper.includes('TRANSPORT')) return 'TRANSPORT';
        if (designationUpper.includes('RECEPTION')) return 'RECEPTION';
        
        return 'GENERAL STAFF';
    };


    // --- NEW: Helper to filter matches based on user clarification (used inside handleStaffFollowUp) ---
    // UPDATED: Added logic to suggest similar branches if the input is close but doesn't match perfectly.
    const filterMatchesByNewQuery = (matches, newQuery) => {
        const queryNormalized = normalizeName(newQuery); 
        const queryParts = queryNormalized.split(' ').filter(p => p.length > 2);
        
        let filtered = [...matches]; 

        // --- FILTER PASS 1: Name Match (Prioritizes name filtering) ---
        let nameFiltered = filtered.filter(staff => {
             const staffNameNormalized = normalizeName(staff.name);
             // Check if any significant part of the new query matches the staff name
             return queryParts.some(part => staffNameNormalized.includes(part));
        });
        
        if (nameFiltered.length > 0 && nameFiltered.length < filtered.length) {
            filtered = nameFiltered;
        }

        // --- FILTER PASS 2: Department/Branch Match (Strictly filters on Dept) ---
        let newTargetDeptCanonical = null;
        for (const [key, value] of Object.entries(DEPT_MAP)) {
            if (queryNormalized.includes(key)) {
                newTargetDeptCanonical = value;
                // If it's a specific specialization, stop looking
                if (value.startsWith('CSE (')) break;
                // If it's a very clear, specific admin dept, stop looking
                if (['LIBRARY', 'PE', 'CLASS_IV', 'XEROX'].includes(value)) break;
            }
        }
        
        if (newTargetDeptCanonical) {
            let deptFiltered = filtered.filter(staff => {
                const staffBranchCanonical = getCanonicalBranch(staff.designation);
                
                // Match exact specialization or general CSE if needed
                if (newTargetDeptCanonical.startsWith('CSE (')) {
                     return staffBranchCanonical === newTargetDeptCanonical;
                } else if (newTargetDeptCanonical === 'CSE') {
                    // Match general CSE or any CSE specialization
                    return staffBranchCanonical.startsWith('CSE');
                } else {
                     return staffBranchCanonical === newTargetDeptCanonical;
                }
            });

            // If department filter succeeded, return the highly filtered list
            if (deptFiltered.length > 0) {
                 return deptFiltered;
            }
        }
        
        // Final fallback: return the best list we have
        return filtered; 
    };

    // --- Typo Suggestion Helper (Basic implementation) ---
    const getSimilarBranches = (wrongInput) => {
        const input = wrongInput.toLowerCase().replace(/[^a-z]/g, '');
        // Use the canonical department names for suggestion output
        const validDepartments = Object.keys(FULL_DEPT_NAMES).filter(key => key.length > 1);
        
        let suggestions = [];
        for (const deptKey of validDepartments) {
            const deptName = FULL_DEPT_NAMES[deptKey].toLowerCase().replace(/[^a-z]/g, '');
            // Simple logic: return departments that start with the input or are very close in length
            if (deptName.startsWith(input) || (deptName.includes(input) && Math.abs(deptName.length - input.length) <= 3)) {
                suggestions.push(FULL_DEPT_NAMES[deptKey]);
            }
        }
        // Limit to 3 unique, top suggestions
        return Array.from(new Set(suggestions)).slice(0, 3);
    };


    // --- NEW: Function to handle contextual follow-ups (FIXES THE LOOP) ---
    const handleStaffFollowUp = (followUpQuery) => {
        const followUpLower = followUpQuery.toLowerCase();
        
        // --- 1. SIMPLE CONFIRMATION CHECK (E.g., "his number") ---
        const isConfirmation = followUpLower.includes('number') || followUpLower === 'yes' || followUpLower === 'confirm';

        // Check if a single match is stored AND the user is trying to confirm it (e.g., "his number")
        if (lastStaffQuery.state === 'idle' && lastStaffQuery.singleMatchFound) {
            if (isConfirmation) {
                const result = getStrictContactOutput(lastStaffQuery.singleMatchFound);
                // CRITICAL FIX: Clear context immediately after returning the result.
                lastStaffQuery.singleMatchFound = null; 
                lastStaffQuery.clarificationAttempts = 0; // Reset attempts on success
                return result;
            }
        }
        
        // --- 2. NESTED CS SPECIALIZATION CLARIFICATION (Rule-Specific) ---
        if (lastStaffQuery.state === 'awaiting_cs_specialization') {
            const initialMatches = lastStaffQuery.matches;
            
            let newTargetDeptCanonical = null;
            
            if (followUpLower.includes('cyber security') || followUpLower.includes('cs') || followUpLower.includes('computer science')) {
                 newTargetDeptCanonical = 'CSE'; // General CSE
            } else if (followUpLower.includes('ds') || followUpLower.includes('data science')) {
                 newTargetDeptCanonical = 'CSE (DS)';
            } else if (followUpLower.includes('ai&ml') || followUpLower.includes('aiml') || followUpLower.includes('machine learning')) {
                 newTargetDeptCanonical = 'CSE (AI&ML)';
            } else if (followUpLower.includes('ai') || followUpLower.includes('artificial intelligence')) {
                 newTargetDeptCanonical = 'CSE (AI)';
            }

            let filteredMatches = [];
            if (newTargetDeptCanonical) {
                 filteredMatches = initialMatches.filter(staff => {
                    const staffBranchCanonical = getCanonicalBranch(staff.designation);
                    // If CSE is selected, check for general CSE staff OR if it's not a different specialization
                    if (newTargetDeptCanonical === 'CSE') {
                        return staffBranchCanonical.startsWith('CSE') && staffBranchCanonical !== 'CSE (DS)' && staffBranchCanonical !== 'CSE (AI)' && staffBranchCanonical !== 'CSE (AI&ML)';
                    } else {
                        return staffBranchCanonical === newTargetDeptCanonical;
                    }
                });
            }

            if (filteredMatches.length === 1) {
                // SUCCESS
                const result = getStrictContactOutput(filteredMatches[0]);
                lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; // Cleared after success
                return result;
            } 
            
            // Failed to narrow down from the second attempt (CS Clarification counted as one attempt)
            
            // Final, improved message after max attempts
            lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 };
            return `I'm still having trouble finding a unique contact based on that specialization. **Let's restart the search.** Please try entering the **full name AND branch** in your next query for the best chance of finding the contact.`;
        }

        // --- 3. GENERIC CLARIFICATION (State: prompting_for_clarification) ---
        if (lastStaffQuery.state === 'prompting_for_clarification') {
            
            const initialMatches = lastStaffQuery.matches;
            lastStaffQuery.clarificationAttempts++; // Increment attempt counter
            
            // --- Check if the new query is 'CS' or a variation that requires the nested prompt ---
            if (followUpLower === 'cs' || followUpLower === 'computer science') {
                 // Transition to the nested state based on the specific rule
                 lastStaffQuery.state = 'awaiting_cs_specialization';
                 return `Do you mean **CSE (Computer Science and Engineering)** or **Cyber Security**?`;
            }

            // --- Regular Filtering ---
            const filteredMatches = filterMatchesByNewQuery(initialMatches, followUpQuery);
            
            if (filteredMatches.length === 1) {
                // SUCCESS: Clarified to one match
                const result = getStrictContactOutput(filteredMatches[0]);
                lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                return result;
            } else if (filteredMatches.length > 1) {
                
                // If it's the second or third fail, give the final improved message
                if (lastStaffQuery.clarificationAttempts >= 2) { 
                     lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                     return `I've tried multiple ways to narrow down the search, but I still see ${filteredMatches.length} matching contacts. **I'm resetting the search.** Please try again with the **full name AND specific branch** to find the correct contact immediately.`;
                }

                // STILL MULTIPLE MATCHES: Re-prompt (Attempt 1)
                lastStaffQuery.matches = filteredMatches;
                
                return `I still found multiple contacts matching that specific query. Please provide the **full name and branch** together to narrow it down further. (Attempt ${lastStaffQuery.clarificationAttempts} of 2)`;
            
            } else {
                // ZERO MATCHES (Or department typo)
                
                const suggestions = getSimilarBranches(followUpQuery);
                let message = "Sorry, I couldn't find a staff member matching that specific combination of name and department in the remaining list.";
                
                if (suggestions.length > 0) {
                     message += ` Were you perhaps looking for **${suggestions.join(', ')}**?`;
                }

                // Final reset after a failed clarification attempt
                lastStaffQuery = { originalQuery: null, matches: [], state: 'idle', singleMatchFound: null, clarificationAttempts: 0 }; 
                return message;
            }
        }

        return null; // Not a contextual follow-up or confirmation
    };


    // --- State-aware contact search function ---
    const findStaffContactAndManageContext = (query) => {
        const queryNormalized = normalizeName(query); 
        const queryParts = queryNormalized.split(' ').filter(p => p.length > 2);
        
        // 0. SPECIAL CASES (Akka/Discipline)
        if (queryNormalized.includes('akka')) {
            const staff = { name: "Akka", number: "79899 3489", designation: "Special Contact, N/A" };
            // Set single match for display, which will be immediately cleared by sendMessage
            lastStaffQuery = { originalQuery: query, matches: [], state: 'idle', singleMatchFound: staff, clarificationAttempts: 0 };
            return getStrictContactOutput(staff);
        }
        
        // Reset non-single-match context variables for a new primary search
        lastStaffQuery.matches = [];
        lastStaffQuery.state = 'idle';
        lastStaffQuery.clarificationAttempts = 0; // Reset attempts on new search

        // 1. Identify Target Department from Query (Canonical Name)
        let targetDeptCanonical = null;
        for (const [key, value] of Object.entries(DEPT_MAP)) {
            if (queryNormalized.includes(key)) {
                targetDeptCanonical = value;
                // If it's a specific specialization or clear admin dept, stop looking
                if (value.startsWith('CSE (')) break;
                // If it's a very clear, specific admin dept, stop looking
                if (['LIBRARY', 'PE', 'CLASS_IV', 'XEROX'].includes(value)) break;
            }
        }
        
        let preliminaryMatches = [];

        // --- TIER 1: HIGH PRECISION MATCHES (Exact/Strong Name + Dept Match) ---
        for (const staff of DEDUPLICATED_STAFF_CONTACTS) {
            const staffNameNormalized = normalizeName(staff.name);
            const staffDeptCanonical = getCanonicalBranch(staff.designation);

            // 1. Determine significant name components
            const staffNameWords = getSignificantWords(staffNameNormalized);
            
            // 2. Check if ALL significant staff name components are present in the query
            const allNameWordsInQuery = staffNameWords.every(word => queryNormalized.includes(word));
            
            // 3. Check if the department matches the query's department hint (or if no hint was given)
            const deptMatches = !targetDeptCanonical || targetDeptCanonical === staffDeptCanonical;

            if (allNameWordsInQuery && deptMatches) {
                 preliminaryMatches.push(staff);
            }
        }
        
        // --- TIER 1.1: IMMEDIATE RESOLUTION ---
        const uniqueHighPrecisionMatches = Array.from(new Set(preliminaryMatches.map(s => JSON.stringify(s)))).map(s => JSON.parse(s));
        
        if (uniqueHighPrecisionMatches.length === 1) {
            // Set single match for display and potential one-word follow-up (e.g., "his number")
            lastStaffQuery.singleMatchFound = uniqueHighPrecisionMatches[0];
            lastStaffQuery.state = 'idle';
            return getStrictContactOutput(uniqueHighPrecisionMatches[0]);
        }
        
        // --- TIER 2: BROADER SEARCH (If TIER 1 found NO unique match) ---
        if (uniqueHighPrecisionMatches.length === 0) {
            
            // --- TIER 2.1: DESIGNATION ONLY MATCHES (HOD/Principal/etc.) ---
             const titleKeywords = ['hod', 'dean', 'officer', 'principal', 'warden', 'security', 'transport', 'reception', 'xerox'];
             const isTitleQuery = titleKeywords.some(t => queryNormalized.includes(t));

             if (isTitleQuery) { 
                 const designationMatches = DEDUPLICATED_STAFF_CONTACTS.filter(staff => 
                     normalizeName(staff.designation).includes(queryNormalized) && 
                     (!targetDeptCanonical || getCanonicalBranch(staff.designation) === targetDeptCanonical)
                 );
                 
                 if (designationMatches.length === 1) {
                     lastStaffQuery.singleMatchFound = designationMatches[0];
                     lastStaffQuery.state = 'idle';
                     return getStrictContactOutput(designationMatches[0]);
                 }
                 if (designationMatches.length > 1) {
                    lastStaffQuery.matches = designationMatches;
                    lastStaffQuery.state = 'prompting_for_clarification';
                    return `I found multiple staff members with that name. Could you please specify the department or branch?`;
                 }
             }
        }
        
        // --- TIER 3: FINAL MULTIPLE MATCH / FALLBACK LOGIC ---
        let finalMatches = uniqueHighPrecisionMatches;

        if (finalMatches.length === 0) {
            // Re-run TIER 1 but with looser matching (partial name match) if we found absolutely nothing so far
             for (const staff of DEDUPLICATED_STAFF_CONTACTS) {
                const staffNameNormalized = normalizeName(staff.name);
                const isNamePartialMatch = queryParts.some(part => staffNameNormalized.includes(part));
                if (isNamePartialMatch) {
                    preliminaryMatches.push(staff);
                }
            }

            // Apply department filter to the partial matches if a department was hinted
            if (preliminaryMatches.length > 0 && targetDeptCanonical) {
                let deptFiltered = preliminaryMatches.filter(staff => getCanonicalBranch(staff.designation) === targetDeptCanonical);
                if (deptFiltered.length > 0) {
                     finalMatches = Array.from(new Set(deptFiltered.map(s => JSON.stringify(s)))).map(s => JSON.parse(s));
                } else {
                    finalMatches = Array.from(new Set(preliminaryMatches.map(s => JSON.stringify(s)))).map(s => JSON.parse(s));
                }
            } else {
                finalMatches = Array.from(new Set(preliminaryMatches.map(s => JSON.stringify(s)))).map(s => JSON.parse(s));
            }
        }

        // 3. Single Match after T3 filter
        if (finalMatches.length === 1) {
            lastStaffQuery.singleMatchFound = finalMatches[0];
            lastStaffQuery.state = 'idle';
            return getStrictContactOutput(finalMatches[0]);
        }
        
        // 4. Multiple Matches Logic
        if (finalMatches.length > 1) {
            // Set context for follow-up
            lastStaffQuery.matches = finalMatches;
            lastStaffQuery.state = 'prompting_for_clarification';
            
            // Return the mandatory ambiguity prompt
            return `I found multiple staff members with that name. Could you please specify the department or branch?`;
        }

        // 5. Final Fallback: Contact not found
        lastStaffQuery.state = 'idle';
        return `Sorry, contact doesn't exist. Please check the spelling of the name or try a new search.`; 
    };


    // --- PQP DOWNLOAD MAP ---
    const DOWNLOAD_MAP = {
        'BTECH-I-I': { 
            label: 'I B.Tech. I Sem', 
            files: [
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R16 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R19 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R20 set)',
                '12 I B.Tech I Semester Supply (R23, R20, R19 & R16) July - 2024 (R23 set)'
            ]
        },
        'BTECH-I-II': { label: 'I B.Tech. II Sem', files: ['R23 BTech I-II Papers'] },
        'BTECH-II-I': { label: 'II B.Tech. I Sem', files: ['R20 BTech II-I Papers'] },
        'BTECH-II-II': { label: 'II B.Tech. II Sem', files: ['R20 BTech II-II Papers'] },
        'BTECH-III-I': { label: 'III B.Tech. I Sem', files: ['R20 BTech III-I Papers'] },
        'BTECH-III-II': { label: 'III B.Tech. II Sem', files: ['R20 BTech III-II Papers'] },
        'BTECH-IV-I': { label: 'IV B.Tech. I Sem', files: ['R19 BTech IV-I Papers'] },
        'BTECH-IV-II': { label: 'IV B.Tech. II Sem', files: ['R19 BTech IV-II Papers'] },
        'MTECH': { label: 'M.Tech. (All Years)', files: ['MTech PQP Archive'] },
    };
    
    // --- SYLLABUS HANDLER (REVERTED TO CHAT RESPONSE) ---
    const handleSyllabusQuery = () => {
        const syllabusLink = 'https://pragati.ac.in/examination/course-structure-syllabus/';
        const academicCalendarLink = 'https://pragati.ac.in/examinations/academic-calendars/';
        
        const intros = [
            "You got it! Time to dive into the academics. ðŸ¤“",
            "Sure thing! Here are the official links for checking the coursework.",
            "Absolutely! Get ready to explore your academic journey. ðŸš€",
        ];

        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">ðŸ“š Academic Documents & Syllabus</p>
                <p class="mt-2 text-sm">${intros[Math.floor(Math.random() * intros.length)]}</p>
                <p class="mt-2 text-sm">You can find the official **Course Structure, Syllabus, and Academic Regulations** directly on the college website using the link below:</p>
                <ul class="link-list flex flex-col mt-3">
                    <li><a href="${syllabusLink}" target="_blank">ðŸ”— Course Structure & Syllabus Page</a></li>
                    <li><a href="${academicCalendarLink}" target="_blank">ðŸ”— Latest Academic Calendars Page</a></li>
                </ul>
                <p class="mt-4 text-sm text-gray-600">
                    ðŸ‘‰ **Click the link, then select the specific Regulation (R23/R20) and Year (I, II, III, IV) you need to download your PDF.**
                </p>
            </div>
        `;
    };

    // --- PQP HANDLER (REVERTED TO CHAT RESPONSE) ---
    const handlePaperQuery = (query) => {
        const queryLower = query.toLowerCase();
        
        // The official PQP link to be included in all PQP responses
        const officialPqpLink = 'https://pragati.ac.in/examination/previous-question-papers/';

        // Check for core paper intent keywords
        const isPaperQueryIntent = /previous|question paper|papers|exam/i.test(queryLower);
        
        // If query is about Syllabus, return null to fall through to the specific syllabus handler
        if (/syllabus|academic/i.test(queryLower)) {
            return { success: false, html: null, isMissingBranch: false };
        }

        if (!isPaperQueryIntent) {
            return { success: false, html: null, isMissingBranch: false };
        }

        let yearNum = null;
        let semNum = null;
        let isMTech = queryLower.includes('m.tech') || queryLower.includes('mtech');

        // Parse B.Tech Year (I, II, III, IV)
        const yearMatch = queryLower.match(/(1st|2nd|3rd|4th|\b[1-4]\b|i{1,4}\s?year|b\.?tech)/i);
        if (yearMatch) {
            const match = yearMatch[0].toLowerCase();
            // Use word boundaries for better accuracy
            if (match.includes('1st') || /\b1\b/.test(match) || match.includes('i ')) yearNum = 'I';
            else if (match.includes('2nd') || /\b2\b/.test(match) || match.includes('ii')) yearNum = 'II';
            else if (match.includes('3rd') || /\b3\b/.test(match) || match.includes('iii')) yearNum = 'III';
            else if (match.includes('4th') || /\b4\b/.test(match) || match.includes('iv')) yearNum = 'IV';
        }

        // Parse Semester (I, II)
        const semMatch = queryLower.match(/(i sem|ii sem|\b[1-2]\b\s?sem(ester)?)/i);
        if (semMatch) {
            const match = semMatch[0].toLowerCase();
            if (match.includes('i') || match.includes('1')) semNum = 'I';
            else if (match.includes('ii') || match.includes('2')) semNum = 'II';
        }
        
        let targetKey = null;
        let title = "Available B.Tech & M.Tech Question Paper Sets";
        
        // --- SCENARIO A: M.Tech Request ---
        if (isMTech) {
            targetKey = 'MTECH';
            title = "M.Tech. Previous Question Papers";
        } 
        // --- SCENARIO B: SPECIFIC B.Tech Year + Sem Request ---
        else if (yearNum && semNum) {
            targetKey = `BTECH-${yearNum}-${semNum}`;
            title = `${DOWNLOAD_MAP[targetKey].label} Previous Question Papers`;
        } else if (yearNum || semNum || isPaperQueryIntent) {
            // SCENARIO C: Incomplete B.Tech query, prompt for missing part
            // If the query is just "papers" or "btech papers" or "2nd year papers", show the full list.
             if (isPaperQueryIntent && !yearNum && !semNum && !isMTech) {
                // Fall through to show all options (Scenario D)
            } else {
                // If they specify *a* year or *a* sem, prompt for the missing part to clarify intent
                const missingPart = yearNum ? 'semester (I or II)' : 'year (I, II, III, or IV)';
                
                const promptIntros = [
                    "Whoa, hold up! We need to narrow that down. ðŸ˜…",
                    "Almost there! I need one more detail.",
                    "Quick check: Which one are you hunting for? ðŸ§",
                ];
                const promptIntro = promptIntros[Math.floor(Math.random() * promptIntros.length)]; 
                
                return { 
                    success: true, 
                    html: `
                        <div class="info-card">
                            <p class="font-semibold text-lg text-[#006494]">ðŸ” Need More Detail!</p>
                            <p class="mt-2 text-sm">
                                ${promptIntro} I see you're looking for B.Tech papers, but I'm missing the **${missingPart}**.<br>
                                Could you please specify the full set you need? For example: **I B.Tech. I Sem** or **III B.Tech. II Sem**.
                            </p>
                            <div class="mt-4 pt-3 border-t border-gray-200">
                                <p class="text-xs font-semibold text-gray-700">Official Download Page:</p>
                                <a href="${officialPqpLink}" target="_blank" class="text-xs text-blue-500 underline hover:text-blue-700 block mt-1">ðŸ”— Pragati College Previous Question Papers (Official Site)</a>
                            </div>
                        </div>
                    `,
                    isMissingBranch: true 
                };
            }
        }

        // --- Generate Final Response (In-Chat List) ---
        const successIntros = [
            "Found 'em! Hope these save you some study time. ðŸ˜‰",
            "Here are the papers you were hunting for! Good luck! ðŸ¤©",
            "Files located! Time to crush those exams. ðŸš€",
        ];
        const successIntro = successIntros[Math.floor(Math.random() * successIntros.length)]; 

        if (targetKey) {
            const data = DOWNLOAD_MAP[targetKey];
            if (data) {
                
                let listItems = '';
                let note = '';
                
                // If it's BTECH-I-I, list the individual files and set a clear note
                if (targetKey === 'BTECH-I-I') {
                    listItems = data.files.map(file => 
                        // All links point to the official site to ensure functionality
                        `<li><a href="${officialPqpLink}" target="_blank">ðŸ“œ ${file} â€“ [Official Site Download Link]</a></li>`
                    ).join('');
                    note = `ðŸ’¡ **Guaranteed Downloads:** Click any link above. They all take you directly to the **Official College Portal** where you can select and download the papers! ðŸŽ“`;

                } else {
                    // For all other years/semesters, show the single set link
                    listItems = `<li><a href="${officialPqpLink}" target="_blank">ðŸ”— ${data.label} â€“ [Official Site Download Link]</a></li>`;
                    note = `ðŸ’¡ **Guaranteed Downloads:** Click the link above! It takes you to the **Official College Portal** where you can download the complete ${data.label} paper set. ðŸŽ“`;
                }

                const html = `
                    <div class="info-card">
                        <p class="font-semibold text-lg text-[#006494]">ðŸ“‚ ${title}</p>
                        <p class="mt-2 text-sm">${successIntro}</p>
                        <ul class="link-list flex flex-col mt-3">
                            ${listItems}
                        </ul>
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <p class="text-sm text-gray-600">${note}</p>
                        </div>
                    </div>
                `;
                return { success: true, html: html, isMissingBranch: false };
            }
        }
        
        // SCENARIO D: DEFAULT FALLBACK (Show all options) 
        const fallbackIntros = [
            "We can find this! Since you didn't specify the exact year/sem, here are all the options:",
            "No problem! To give you the best set, choose from these categories:",
            "Got itâ€”you need exam files! Which bundle should I grab for you? ðŸ§",
        ];
        const fallbackIntro = fallbackIntros[Math.floor(Math.random() * fallbackIntros.length)];
        
        const listItems = Object.keys(DOWNLOAD_MAP).map(key => {
            const data = DOWNLOAD_MAP[key];
            // For general list, create a link that asks the user to refine the query
            const clickQuery = data.label.replace(/\./g, '');
            return `<li><a href="javascript:void(0);" onclick="document.getElementById('user-input').value='${clickQuery} papers'; sendMessage();">ðŸ“˜ ${data.label} â€“ [Click to Select]</a></li>`;
        }).join('');
        
        const fallbackHtml = `
            <div class="info-card">
            <p class="font-semibold text-lg text-[#006494]">ðŸ“‚ Available B.Tech & M.Tech Question Paper Sets</p>
            <p class="mt-2 text-sm">${fallbackIntro}</p>
            <ul class="link-list flex flex-col mt-3">
                ${listItems}
            </ul>
            <div class="mt-4 pt-3 border-t border-gray-200">
                <p class="text-sm text-gray-600">
                    ðŸ’¡ **Tip:** Click on a selection to submit the query. Or, use the official site for guaranteed downloads.
                </p>
                <a href="${officialPqpLink}" target="_blank" class="text-sm text-blue-500 underline hover:text-blue-700 block mt-1">ðŸ”— **Pragati College Previous Question Papers (Official Site)**</a>
            </div>
            </div>
        `;
        return { success: true, html: fallbackHtml, isMissingBranch: false };
    };
    
    // --- TIMING HANDLER (NEW) ---
    const handleTimingQuery = (query) => {
        const queryLower = query.toLowerCase();
        
        let title, content;
        
        const intros = [
            "On it! Gotta keep those energy levels up. ðŸ˜‰",
            "Sure thing! Let's check the dining schedule.",
            "Absolutely! Here's the scoop on when and where to eat. ðŸ•",
        ];
        const intro = intros[Math.floor(Math.random() * intros.length)];
        
        if (queryLower.includes('hostel') || queryLower.includes('hostler') || queryLower.includes('dinner') || queryLower.includes('breakfast')) {
            // Hosteler timings
            title = 'Hostel Food Timings ðŸ½ï¸';
            content = `
                <p class="mt-2 text-sm">${intro}</p>
                <p class="mt-2 text-sm">Here are the meal timings for **Hostelers**:</p>
                <ul class="mt-2 text-sm space-y-1 pl-4 list-disc list-inside">
                    <li>**Breakfast:** Provided at **8:00 AM**.</li>
                    <li>**Lunch:** Same as normal college timings (**12:00 PM - 1:30 PM** split).</li>
                    <li>**Dinner:** Provided from **7:30 PM** onwards.</li>
                </ul>
            `;
        } else if (queryLower.includes('canteen') || queryLower.includes('day scholar') || queryLower.includes('lunch')) {
            // Day Scholar timings (Canteen/Lunch)
            title = 'Canteen & Lunch Timings ðŸ¥ª';
            content = `
                <p class="mt-2 text-sm">${intro}</p>
                <p class="mt-2 text-sm">Here are the timings for the **Canteen** and **Day Scholars**:</p>
                <ul class="mt-2 text-sm space-y-1 pl-4 list-disc list-inside">
                    <li>**Canteen Opening Hours:** **9:00 AM to 4:00 PM** for day scholar students.</li>
                    <li>**College Lunch Timings (Split):**
                        <ul class="ml-4 list-disc list-inside">
                            <li>1:00 PM to 1:30 PM for First-Year students.</li>
                            <li>12:00 PM to 12:30 PM for Second-Year to Final-Year students.</li>
                        </ul>
                    </li>
                </ul>
            `;
        } else {
            return null;
        }

        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">${title}</p>
                ${content}
            </div>
        `;
    };
    
    // --- PLACEMENT TEXT-ONLY HANDLER ---
    const getPlacementSummary = () => {
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const latestYear = PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1];
        const officialLink = 'https://pragati.ac.in/placements/';
        
        const intros = [
            "These numbers are looking sharp! Check out the highlights: ðŸš€",
            "Here's the latest placement snapshot! Keep grinding for these roles. âœ¨",
            "Got the placement stats! Take a look at the key data points: ðŸ’°",
        ];
        const intro = intros[Math.floor(Math.random() * intros.length)];


        return `
            <div class="info-card">
                <p class="font-semibold text-lg text-[#006494]">ðŸ’° Placement Highlights (${latestYear})</p>
                <p class="mt-2 text-sm">${intro}</p>
                <ul class="mt-2 text-sm space-y-1 pl-4">
                    <li>âœ¨ **Highest Package:** **${latestHighest} LPA**</li>
                    <li>ðŸ“ˆ **Average Package:** **${latestAverage} LPA**</li>
                    <li>ðŸŽ“ **Total Placements (as of May 31):** **1625** offers.</li>
                </ul>
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                        Want to see the trend over time? Just ask for the "**Placement Graph**"!
                    </p>
                    <a href="${officialLink}" target="_blank" class="text-sm text-blue-500 underline hover:text-blue-700 block mt-1">ðŸ”— **View Official Placements Page**</a>
                </div>
            </div>
        `;
    };


    // --- CHART.JS RENDERING FUNCTION ---
    const showPlacementGraph = () => {
        // 1. Add chat confirmation message
        if (placementChart) {
            // If chart exists, destroy it before trying to find the element wrapper.
            // Also, skip the confirmation message to prevent spam when redrawing the chart on theme change.
             placementChart.destroy();
        } else {
            const graphIntros = [
                "Here comes the visual data! Watch that trend line climb! ðŸ“ˆ",
                "I'd be happy to show you the trend! Get ready for the graph view. ðŸ“Š",
                "Time for some data visualization! This shows our continuous growth. ðŸ¤©",
            ];
            const intro = graphIntros[Math.floor(Math.random() * graphIntros.length)];
            addMessage(`${intro}`, false);
        }
       
        // 2. Create the wrapper div for the chart
        let chartWrapper = chatHistory.querySelector('.chart-wrapper');
        if (!chartWrapper) {
            chartWrapper = document.createElement('div');
            chartWrapper.className = 'bot-message message-bubble chart-wrapper flex flex-col items-start info-card w-full max-w-full';
        } else {
             chartWrapper.innerHTML = ''; // Clear previous content if redrawing
             chartWrapper.classList.remove('hidden');
        }
        
        // 3. Add the canvas element
        const canvas = document.createElement('canvas');
        canvas.id = 'placementChart';
        chartWrapper.appendChild(canvas);
        
        // 4. Create the summary text area
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'graph-summary';
        
        // Calculate dynamic summary points
        const latestHighest = PLACEMENT_DATA.highest[PLACEMENT_DATA.highest.length - 1];
        const latestAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 1];
        const firstHighest = PLACEMENT_DATA.highest[0];
        const highestGrowth = ((latestHighest - firstHighest) / firstHighest * 100).toFixed(0);
        // Calculate average growth based on the latest year vs previous year
        const prevAverage = PLACEMENT_DATA.average[PLACEMENT_DATA.average.length - 2];
        const averageGrowth = ((latestAverage - prevAverage) / prevAverage * 100).toFixed(0); 

        summaryDiv.innerHTML = `
            <h4 class="font-bold text-lg mb-2 text-gray-800">Key Trends (2022 - 2025):</h4>
            <p>âœ… <strong>Highest Package:</strong> The peak package has shown strong growth, climbing from <strong>${firstHighest} LPA in ${PLACEMENT_DATA.years[0]}</strong> to a current high of <strong>${latestHighest} LPA</strong> (a massive <strong>${highestGrowth}% growth</strong>).</p>
            <p>ðŸ“ˆ <strong>Average Package Trend:</strong> The average package has maintained a steady upward trend, reaching <strong>${latestAverage} LPA</strong> in the ongoing ${PLACEMENT_DATA.years[PLACEMENT_DATA.years.length - 1]} batch. This is an increase of <strong>${averageGrowth}%</strong> over the previous year!</p>
            <p>ðŸš€ <strong>Action:</strong> These numbers indicate a strong focus on high-value placements, especially in specialized IT and CSE roles. Make sure to attend the <strong>Career Development Cell</strong> workshops! ðŸŽ“</p>
        `;
        
        chartWrapper.appendChild(summaryDiv);
        
        chatHistory.appendChild(chartWrapper);
        scrollToBottom();

        // 5. Render the chart
        
        const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#e0e0e0' : '#333';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const tealColor = isDark ? 'rgba(0, 201, 167, 0.8)' : 'rgba(0, 201, 167, 0.8)';
        const deepBlueColor = isDark ? 'rgba(0, 100, 148, 0.8)' : 'rgba(0, 100, 148, 0.8)';

        placementChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: PLACEMENT_DATA.years,
                datasets: [
                    {
                        label: 'Highest Package (LPA)',
                        data: PLACEMENT_DATA.highest,
                        backgroundColor: tealColor,
                        borderColor: tealColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average Package (LPA)',
                        data: PLACEMENT_DATA.average,
                        backgroundColor: deepBlueColor,
                        borderColor: deepBlueColor.replace('0.8', '1'),
                        borderWidth: 1,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Placement Package Trends (LPA)',
                        font: { size: 16, weight: 'bold' },
                        color: textColor
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor // Set legend text color
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Package in LPA',
                            color: textColor
                        },
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    };
    
    // --- VOICE INPUT LOGIC ---

    const startVoiceInput = () => {
        if (!('webkitSpeechRecognition' in window)) {
            addMessage("âŒ **Error:** Speech recognition is not supported in this browser. Please use Chrome or a Chromium-based browser.", false);
            return;
        }

        if (recognition && recognition.running) {
            recognition.stop();
            return;
        }
        
        // Initialize Speech Recognition API
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            voiceButton.classList.add('mic-active');
            voiceButton.disabled = false; // Enable the button to allow stopping
            sendButton.disabled = true;
            userInput.placeholder = "ðŸ‘‚ Listening... Speak now!";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            // The logic below will send the message automatically when speech stops
            recognition.stop();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            // Hide the error message from the chat, just print to console for debugging
            recognition.stop();
        };

        recognition.onend = () => {
            voiceButton.classList.remove('mic-active');
            sendButton.disabled = false;
            userInput.placeholder = "Ask a question...";

            // Automatically send the transcribed text if available
            if (userInput.value.trim().length > 0) {
                sendMessage();
            }
        };

        try {
            recognition.start();
        } catch (e) {
             // Catch error if speech recognition is already active (rare)
            console.error("Speech recognition start error:", e);
        }
    };

    // --- VIEW MANAGEMENT & ENTRY (Uses defined global variables) ---
    const showView = (viewId) => {
        // FIX: Ensure both views are defined before attempting to manipulate them
        if (!loginView || !chatView) {
             // Do not log a CONSOLE_ERROR here, as it might happen during initial load before setupDOMReferences runs fully
             return;
        }
        
        if (viewId === 'login') {
            loginView.style.display = 'flex';
            chatView.style.display = 'none';
        } else {
            loginView.style.display = 'none';
            chatView.style.display = 'flex';
        }
    };

    const initializeChat = () => {
        if (!chatInitialized) {
            // Add the initial welcome message only once
            addMessage("Hello! I'm the **Pragati Engineering College Insight Bot**. I am an official assistant ready to help you with questions about admissions, courses (B.Tech/M.Tech), campus life, and more, specific to our Surampalem campus. How can I assist you? âœ¨", false);
            
            // Show initial suggestions
            showSuggestions([
                "What courses are offered?",
                "Check Placement Trend",
                "Who is the Principal?"
            ]);

            chatInitialized = true;
        }
        // FIX: Safely attempt to focus the input only if it exists.
        if (userInput) { 
            userInput.focus();
        }
    };

    const startChat = () => {
        showView('chat');
        initializeChat();
    };

    // Attach 'Enter' key listeners to the document (will be ignored if the input is disabled)
    const handleKeypress = (e) => {
        if (e.key === 'Enter') {
            // If the chat view is active, try to send a message
            if (chatView && chatView.style.display === 'flex' && !sendButton.disabled) {
                sendMessage();
            } 
            // If the login view is active, trigger the chat start
            else if (loginView && loginView.style.display === 'flex') {
                startChat();
            }
        }
    };

    // --- API CALL LOGIC WITH EXPONENTIAL BACKOFF ---

    const fetchGeminiResponse = async (contents, maxRetries = 3, delay = 500) => { // Reduced retries to 3 and delay to 500ms
        const payload = {
            contents: contents,
            systemInstruction: {
                parts: [{ text: SYSTEM_PROMPT }]
            },
            // --- ADDING GOOGLE SEARCH GROUNDING ---
            tools: [{ "google_search": {} }],
            // -------------------------------------
        };

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 429 || response.status >= 500) {
                    console.warn(`API call failed (Status: ${response.status}). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; // Slightly less aggressive backoff
                } else {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
            } catch (error) {
                if (i === maxRetries - 1) {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw new Error("I apologize, but I couldn't connect to the server. Please try again later.");
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 1.5;
            }
        }
    };

    // --- MAIN CHAT FUNCTIONALITY ---
    const sendMessage = async (input, userInitiated = true) => {
        const messageText = input || userInput.value.trim();
        
        if (!messageText) return;

        if (userInitiated) {
            userInput.value = '';
            sendButton.disabled = true;
            voiceButton.disabled = true;
            addMessage(messageText, true);
        }

        // Clear previous suggestions immediately
        clearSuggestions(); 
        
        // --- LOCAL HANDLER CHECKS (Priority 1) ---
        // New: Moved conversational logic to start of execution
        let queryToHandle = messageText;
        if (conversationContext.state === 'awaiting_branch' && userInitiated) {
             // If we were waiting for the branch, append the new message to the original query
            queryToHandle = conversationContext.originalQuery + ' ' + messageText;
            conversationContext = { state: 'idle', originalQuery: null }; // Reset immediately
        }

        const isSyllabusQuery = /syllabus|academic calendar|regulations|course structure/i.test(queryToHandle);
        const isPaperQuery = /previous|question paper|papers|exam|m.tech|b.tech|btech|mtech/i.test(queryToHandle);
        const isTimingQuery = /canteen|hostel|hostler|food|lunch|dinner|breakfast/i.test(queryToHandle);
        const isContactQuery = /(call|number|phone|contact|line|hod|principal|dean|warden|discip|officer|professor|technician|admin|assistant|akka)/i.test(queryToHandle);
        const isGraphQuery = /(graph|chart|comparison|trend|package|salary|placement)/i.test(queryToHandle);


        try {
            // --- A. CONTEXTUAL STAFF FOLLOW-UP (Highest Priority for conversational memory) ---
            // Trigger if we are currently prompting for clarification, or if the last response was a single match (allowing "his number" follow-up)
            if (lastStaffQuery.state !== 'idle' || lastStaffQuery.singleMatchFound) {
                const followUpResult = handleStaffFollowUp(messageText);
                if (followUpResult) {
                    hideLoading();
                    addMessage(followUpResult, false);
                    showSuggestions(["Check Principal's number", "What courses are offered?", "Check canteen timings"]);
                    
                    // CRITICAL FIX: If handleStaffFollowUp consumed the query (meaning it was a contextual confirmation/clarification)
                    // The singleMatchFound state must be handled inside handleStaffFollowUp itself.
                    return;
                }
            }
            
            // --- B. NEW CONTACT QUERY DETECTED: FORCE RESET CONTEXT ---
            // This handles the case where a user types a brand new name (not a confirmation/clarification).
            // The purpose of this block is only to run if the previous block (A) did NOT consume the query.
            if (isContactQuery) {
                // If a new query is detected, wipe the old singleMatchFound just in case.
                lastStaffQuery.singleMatchFound = null; 
            }

            // --- 1. TIMING CHECK ---
            if (isTimingQuery) {
                const timingResponse = handleTimingQuery(queryToHandle);
                if (timingResponse) {
                    hideLoading();
                    addMessage(timingResponse, false);
                    showSuggestions([
                        "What are the college timings?",
                        "What is the college fee?",
                        "Contact the Warden"
                    ]);
                    return;
                }
            }

            // --- 2. SYLLABUS CHECK ---
            if (isSyllabusQuery && !isPaperQuery) {
                hideLoading();
                // Since this handler returns HTML, we wrap it in an addMessage call that doesn't expect 'text\n'
                addMessage(`<div>${handleSyllabusQuery()}</div>`, false); 
                 showSuggestions([
                    "Download Previous Papers",
                    "What courses are offered?",
                    "Contact the Exam Section"
                ]);
                return;
            }


            // --- 3. PREVIOUS PAPERS CHECK ---
            if (isPaperQuery) {
                
                const paperResult = handlePaperQuery(queryToHandle);
                
                if (paperResult.success && paperResult.html) {
                    
                    if (paperResult.isMissingBranch) {
                        // Context needed: Prompting for missing year/sem. Save current message.
                        conversationContext = { state: 'awaiting_branch', originalQuery: messageText };
                    } else {
                        // Success: Clear context
                        conversationContext = { state: 'idle', originalQuery: null };
                    }
                    
                    hideLoading();
                    addMessage(`<div>${paperResult.html}</div>`, false);
                    showSuggestions([
                        "Check my syllabus",
                        "When are the internals?",
                        "Contact the Exam Section"
                    ]);
                    return;
                }
                
                conversationContext = { state: 'idle', originalQuery: null }; 
            }
            // --- END PREVIOUS PAPERS CHECK ---
            
            // --- 4. GRAPH CHECK / PLACEMENT FACT CHECK ---
            if (isGraphQuery) {
                const graphKeywords = /(graph|chart|comparison|trend)/i;
                if (graphKeywords.test(queryToHandle)) {
                    // Explicit graph request
                    hideLoading();
                    showPlacementGraph();
                    showSuggestions(["Tell me the highest package", "What courses are offered?", "Contact the CDC Dean"]);
                    return;
                } else {
                    // General placement fact request
                    hideLoading();
                    // Since this handler returns HTML, we wrap it in an addMessage call that doesn't expects 'text\n'
                    addMessage(`<div>${getPlacementSummary()}</div>`, false);
                    showSuggestions(["Show the Placement Graph", "What is the college fee?", "Contact the CDC Dean"]);
                    return;
                }
            }


            // --- 5. CONTACTS CHECK (PRIMARY SEARCH) ---
            if (isContactQuery) {
                // findStaffContactAndManageContext now handles the search and sets/updates lastStaffQuery state
                const localContactResponse = findStaffContactAndManageContext(queryToHandle);
                
                hideLoading();
                
                if (localContactResponse.startsWith('âœ… Name:')) {
                    // Single clear match (using the new strict format string)
                    addMessage(localContactResponse, false);
                    
                    // CRITICAL FIX: Reset the single match *after* the correct display is shown.
                    // This prevents the next unrelated query from being trapped by the singleMatchFound state.
                    lastStaffQuery.singleMatchFound = null; 
                    
                    showSuggestions([
                        "What is the college fee?",
                        "Where can I find the syllabus?",
                        "Check canteen timings"
                    ]);
                    return; 
                } else {
                    // This handles the "I found multiple staff members..." prompt OR the "Sorry, contact doesn't exist" message
                    addMessage(localContactResponse, false); 
                    showSuggestions([
                        "Contact the Principal",
                        "Who is the HOD for ECE?",
                        "Check General Contact Info"
                    ]);
                    return;
                }
            }
            // --- END CONTACTS CHECK ---
            
            // --- 6. GENERAL AI QUERY (FALLBACK) ---
            const contents = [{ role: "user", parts: [{ text: messageText }] }];
            showTyping(); 

            const result = await fetchGeminiResponse(contents);
            
            const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (botResponse) {
                if (botResponse.startsWith("I'd be happy to show you the trend!")) {
                    hideLoading();
                    addMessage(botResponse.replace("I'd be happy to show you the trend!", "I'd be happy to show you the trend! ðŸš€"), false);
                    showPlacementGraph();
                    return; 
                }
                
                hideLoading();
                addMessage(botResponse, false); 
                
                // Show contextual suggestions 
                showSuggestions(["What is the college fee?", "Where can I find the syllabus?", "Check Placement Trend"]);

            } else {
                hideLoading();
                addMessage("Oops! I hit a snag while looking that up. Please try again or rephrase your question. ðŸ¤”", false);
                showSuggestions(["What courses are offered?", "Contact General Office", "Check Placement Trend"]);
            }

        } catch (error) {
            console.error("Chat Error:", error);
            hideLoading();
            addMessage(`I am unable to connect to the external information source right now. Please try again in a moment.`, false);
        } finally {
            sendButton.disabled = false;
            voiceButton.disabled = false;
            if (userInput) {
                userInput.focus();
            }
            scrollToBottom();
        }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        setupDOMReferences(); // FIX 1: Defines all required DOM element variables
        applySavedTheme(); // FIX 2: Now defined globally above
        showView('login');
        document.addEventListener('keypress', handleKeypress);
        
        // Ensure suggestion area state is correct on load
        if (suggestionArea) {
             suggestionArea.classList.remove('p-3');
             suggestionArea.style.height = '0';
        }
    };

</script>
</body>
</html>
